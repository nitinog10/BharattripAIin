<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BharatTrip AI ðŸ‡®ðŸ‡³</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Axios for API calls -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Three.js for 3D models and AR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/PLYLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .tooltip {
        @apply absolute -top-9 left-1/2 -translate-x-1/2 
                whitespace-nowrap rounded-md bg-black 
                px-2 py-1 text-xs text-white 
                opacity-0 scale-95 transition 
                group-hover:opacity-100 group-hover:scale-100;
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out forwards;
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.5s ease-out forwards;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }
        .leaflet-container {
            height: 500px;
            width: 100%;
            border-radius: 12px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .status-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes slide-in-right {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5), 0 0 10px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.8), 0 0 20px rgba(59, 130, 246, 0.5); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .animate-slide-in-right {
            animation: slide-in-right 0.6s ease-out forwards;
        }
        .animate-shimmer {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        .insight-card {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .insight-card:hover::before {
            left: 100%;
        }
        .insight-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#fef2f2', 100: '#fee2e2', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c' },
                        secondary: { 500: '#f97316', 600: '#ea580c' }
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo, cloneElement } = React;
        
        // Backend API Configuration
        const API_BASE = 'http://localhost:3001/api';
        
        // Icons
        const icons = {
            Home: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>,
            ChevronDown: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
            ),
            Moon: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            ),
            Sun: () => (
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
            ),
            Map: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>,
            Route: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>,
            Chat: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" /></svg>,
            User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
            Sun: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Moon: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>,
            Send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
            Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            TrendingUp: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>,
            Calendar: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>,
            Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
            Copy: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
            Edit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            UserPlus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>,
            Rupee: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 8h6m-6 4h6m-2 4H9m5-12V2m-2 2v4m2-4h4a2 2 0 012 2v12a2 2 0 01-2 2H9a2 2 0 01-2-2V4a2 2 0 012-2z" /></svg>,
            Clock: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
            Filter: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
            Shield: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" /></svg>,
            Star: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
        };

        // OpenAI API for AI Content Generation (replaces Gemini)
        const geminiApi = {
            async generateContent(prompt, jsonSchema = null) {
                // OpenAI API Key - Replace with your own key from environment or backend
                const apiKey = "YOUR_OPENAI_API_KEY_HERE";
                const apiUrl = "https://api.openai.com/v1/chat/completions";
                
                // Try multiple models in order of preference
                const models = ['gpt-4o-mini', 'gpt-4o', 'gpt-3.5-turbo'];
                let lastError = null;
                
                for (const model of models) {
                    try {
                        const payload = {
                            model: model,
                            messages: [
                                {
                                    role: "system",
                                    content: "You are a helpful travel assistant specializing in Indian tourism. Always respond with valid JSON when asked for structured data. Be concise and accurate."
                                },
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 4096
                        };
                        
                        // If JSON schema is provided, use response_format
                        if (jsonSchema) {
                            payload.response_format = { type: "json_object" };
                        }
                        
                        let response;
                        let delay = 1000;
                        for (let i = 0; i < 3; i++) {
                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${apiKey}`
                                },
                                body: JSON.stringify(payload)
                            });
                            if (response.ok) break;
                            if (response.status === 429 || response.status >= 500) {
                                console.log(`Retry ${i + 1} for model ${model}, waiting ${delay}ms...`);
                                await new Promise(res => setTimeout(res, delay));
                                delay *= 2;
                            } else { break; }
                        }
                        
                        if (!response.ok) {
                            const errorBody = await response.text();
                            console.error("OpenAI API Error Response:", errorBody);
                            let errorMessage = `API request failed with status ${response.status}`;
                            try {
                                const errorJson = JSON.parse(errorBody);
                                if (errorJson.error && errorJson.error.message) {
                                    errorMessage = `${errorMessage}: ${errorJson.error.message}`;
                                }
                            } catch (e) {
                                if (errorBody) {
                                    errorMessage = `${errorMessage}: ${errorBody.substring(0, 200)}`;
                                }
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const result = await response.json();
                        
                        if (result.choices && result.choices.length > 0 && result.choices[0].message) {
                            const text = result.choices[0].message.content;
                            console.log("OpenAI API Response:", text.substring(0, 500) + "...");
                            
                            // Try to parse as JSON if it looks like JSON
                            if (text.trim().startsWith('{') || text.trim().startsWith('[')) {
                                try {
                                    return JSON.parse(text);
                                } catch (parseError) {
                                    // Try to extract JSON from markdown code blocks
                                    const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                                    if (jsonMatch) {
                                        return JSON.parse(jsonMatch[1].trim());
                                    }
                                    console.error("JSON parsing error:", parseError);
                                    return text; // Return raw text if JSON parsing fails
                                }
                            }
                            
                            // Check if response contains JSON in markdown code blocks
                            const jsonMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                            if (jsonMatch) {
                                try {
                                    return JSON.parse(jsonMatch[1].trim());
                                } catch (e) {
                                    console.error("Failed to parse JSON from code block:", e);
                                }
                            }
                            
                            return text;
                        } else {
                            console.error("Unexpected API response structure:", result);
                            if (result.error) {
                                throw new Error(`API Error: ${result.error.message || JSON.stringify(result.error)}`);
                            }
                            throw new Error("Failed to generate content from API.");
                        }
                    } catch (error) {
                        lastError = error;
                        console.error(`Failed with model ${model}:`, error.message);
                        continue;
                    }
                }
                throw lastError || new Error("All OpenAI models failed to generate content");
            }
        };

        // Activities API (mock data)
        const activitiesApi = {
            async getActivities(destination) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const allActivities = {
                            'Goa': [
                                { id: 1, name: 'Baga Beach', type: 'Sightseeing', cost: 0, duration: 3, image: 'https://source.unsplash.com/400x300/?goa-beach' },
                                { id: 2, name: 'Spice Plantation Tour', type: 'Food Tour', cost: 1500, duration: 4, image: 'https://source.unsplash.com/400x300/?spice-plantation' },
                                { id: 3, name: 'Dolphin Watching', type: 'Adventure', cost: 800, duration: 2, image: 'https://source.unsplash.com/400x300/?dolphin' },
                                { id: 4, name: 'Fort Aguada', type: 'History', cost: 200, duration: 2, image: 'https://source.unsplash.com/400x300/?fort' },
                            ],
                            'Jaipur': [
                                { id: 5, name: 'Amber Fort', type: 'Sightseeing', cost: 500, duration: 3, image: 'https://source.unsplash.com/400x300/?amber-fort' },
                                { id: 6, name: 'City Palace', type: 'History', cost: 700, duration: 4, image: 'https://source.unsplash.com/400x300/?city-palace' },
                                { id: 7, name: 'Rajasthani Thali Experience', type: 'Food Tour', cost: 600, duration: 2, image: 'https://source.unsplash.com/400x300/?thali' },
                                { id: 8, name: 'Elephant Ride', type: 'Adventure', cost: 1000, duration: 1, image: 'https://source.unsplash.com/400x300/?elephant' },
                            ],
                            'Kerala': [
                                { id: 9, name: 'Backwater Cruise', type: 'Relaxation', cost: 2500, duration: 6, image: 'https://source.unsplash.com/400x300/?backwater' },
                                { id: 10, name: 'Tea Plantation Tour', type: 'Nature', cost: 800, duration: 3, image: 'https://source.unsplash.com/400x300/?tea-plantation' },
                                { id: 11, name: 'Ayurveda Spa', type: 'Wellness', cost: 2000, duration: 2, image: 'https://source.unsplash.com/400x300/?ayurveda' },
                                { id: 12, name: 'Kerala Cuisine Class', type: 'Food Tour', cost: 1500, duration: 3, image: 'https://source.unsplash.com/400x300/?kerala-food' },
                            ],
                            'default': [
                                { id: 13, name: 'City Walking Tour', type: 'Sightseeing', cost: 1000, duration: 3, image: 'https://source.unsplash.com/400x300/?city-walk' },
                                { id: 14, name: 'Local Market Visit', type: 'Shopping', cost: 500, duration: 2, image: 'https://source.unsplash.com/400x300/?local-market' },
                                { id: 15, name: 'Sunset Point', type: 'Relaxation', cost: 0, duration: 1, image: 'https://source.unsplash.com/400x300/?sunset' },
                            ]
                        };
                        const activities = allActivities[destination] || allActivities['default'];
                        resolve(activities);
                    }, 500);
                });
            }
        };

        // User Management API (localStorage-based)
        const userApi = {
            async signup(firstName, lastName, email, password) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const users = JSON.parse(localStorage.getItem('bharattrip_users')) || [];
                        if (users.find(user => user.email === email)) {
                            reject(new Error("User with this email already exists."));
                        } else {
                            const newUser = {
                                id: `user_${Date.now()}`,
                                firstName,
                                lastName,
                                email,
                                password,
                                preferences: null,
                                language: 'en',
                                photoUrl: null,
                                createdAt: new Date().toISOString()
                            };
                            users.push(newUser);
                            localStorage.setItem('bharattrip_users', JSON.stringify(users));
                            resolve(newUser);
                        }
                    }, 500);
                });
            },
            async login(email, password) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const users = JSON.parse(localStorage.getItem('bharattrip_users')) || [];
                        const user = users.find(u => u.email === email && u.password === password);
                        if (user) {
                            resolve(user);
                        } else {
                            reject(new Error("Invalid email or password."));
                        }
                    }, 500);
                });
            },
            async updateUserProfile(userId, profileData) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        let users = JSON.parse(localStorage.getItem('bharattrip_users')) || [];
                        const userIndex = users.findIndex(u => u.id === userId);
                        if (userIndex !== -1) {
                            users[userIndex] = { ...users[userIndex], ...profileData };
                            localStorage.setItem('bharattrip_users', JSON.stringify(users));
                            resolve(users[userIndex]);
                        } else {
                            reject(new Error("User not found."));
                        }
                    }, 500);
                });
            },
            async deleteUserAccount(userId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        let users = JSON.parse(localStorage.getItem('bharattrip_users')) || [];
                        users = users.filter(u => u.id !== userId);
                        localStorage.setItem('bharattrip_users', JSON.stringify(users));
                        resolve({ success: true });
                    }, 1000);
                });
            }
        };

        // Mock API for Itinerary Management (compatible with index.html structure)
        const mockApi = {
            async saveItinerary(userId, itineraryData, isPublic) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        const userItinerariesKey = `bharattrip_itineraries_${userId}`;
                        const userItineraries = JSON.parse(localStorage.getItem(userItinerariesKey)) || [];
                        
                        if (itineraryData.startDate && itineraryData.endDate) {
                            const newTripStart = new Date(itineraryData.startDate);
                            const newTripEnd = new Date(itineraryData.endDate);
                            const isOverlapping = userItineraries.some(existingTrip => {
                                if (existingTrip.id === itineraryData.id) return false;
                                if (existingTrip.startDate && existingTrip.endDate) {
                                    const existingStart = new Date(existingTrip.startDate);
                                    const existingEnd = new Date(existingTrip.endDate);
                                    return newTripStart <= existingEnd && newTripEnd >= existingStart;
                                }
                                return false;
                            });
                            if (isOverlapping) {
                                reject(new Error("You already have a trip scheduled during these dates."));
                                return;
                            }
                        }

                        const itineraryId = itineraryData.id || `trip_${Date.now()}`;
                        // When making a trip public, it should always go to pending status for admin approval
                        // Unless it's already approved (in which case, keep it approved)
                        let tripStatus = itineraryData.status || (isPublic ? 'pending' : 'private');
                        if (isPublic && tripStatus !== 'approved') {
                            tripStatus = 'pending'; // Always set to pending when making public (unless already approved)
                        }
                        const newItinerary = { 
                            ...itineraryData,
                            id: itineraryId,
                            ownerId: userId,
                            isPublic, 
                            status: tripStatus,
                            createdAt: itineraryData.createdAt || new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };

                        const existingIndex = userItineraries.findIndex(trip => trip.id === itineraryId);
                        if (existingIndex !== -1) {
                            userItineraries[existingIndex] = newItinerary;
                        } else {
                            userItineraries.push(newItinerary);
                        }

                        localStorage.setItem(userItinerariesKey, JSON.stringify(userItineraries));

                        if (isPublic) {
                            const publicItineraries = JSON.parse(localStorage.getItem('bharattrip_public_itineraries')) || [];
                            const existingPublicIndex = publicItineraries.findIndex(trip => trip.id === itineraryId);
                            if (existingPublicIndex !== -1) {
                                publicItineraries[existingPublicIndex] = newItinerary;
                            } else {
                                publicItineraries.push(newItinerary);
                            }
                            localStorage.setItem('bharattrip_public_itineraries', JSON.stringify(publicItineraries));
                        }
                        
                        resolve(newItinerary);
                    }, 500);
                });
            },
            async getUserTrips(userId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const userItinerariesKey = `bharattrip_itineraries_${userId}`;
                        const trips = JSON.parse(localStorage.getItem(userItinerariesKey)) || [];
                        // Also check bharattrip_saved_trips for backwards compatibility
                        const savedTrips = JSON.parse(localStorage.getItem('bharattrip_saved_trips')) || [];
                        const userSavedTrips = savedTrips.filter(t => t.userId === userId);
                        resolve([...trips, ...userSavedTrips]);
                    }, 500);
                });
            },
            async getPublicTrips(status = 'approved') {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const publicItineraries = JSON.parse(localStorage.getItem('bharattrip_public_itineraries')) || [];
                        if (status === 'all') {
                            resolve(publicItineraries);
                        } else {
                            resolve(publicItineraries.filter(trip => trip.status === status));
                        }
                    }, 500);
                });
            },
            async updateItineraryStatus(tripId, newStatus) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        let publicItineraries = JSON.parse(localStorage.getItem('bharattrip_public_itineraries')) || [];
                        const tripIndex = publicItineraries.findIndex(t => t.id === tripId);
                        if (tripIndex !== -1) {
                            const tripToUpdate = publicItineraries[tripIndex];
                            tripToUpdate.status = newStatus;
                            publicItineraries[tripIndex] = tripToUpdate;
                            localStorage.setItem('bharattrip_public_itineraries', JSON.stringify(publicItineraries));
                            const userItinerariesKey = `bharattrip_itineraries_${tripToUpdate.ownerId}`;
                            let userItineraries = JSON.parse(localStorage.getItem(userItinerariesKey)) || [];
                            const userTripIndex = userItineraries.findIndex(t => t.id === tripId);
                            if(userTripIndex !== -1) {
                                userItineraries[userTripIndex].status = newStatus;
                                localStorage.setItem(userItinerariesKey, JSON.stringify(userItineraries));
                            }
                            resolve(tripToUpdate);
                        } else {
                            reject(new Error("Trip not found in public itineraries."));
                        }
                    }, 500);
                });
            },
            async getActivities(destination) {
                return activitiesApi.getActivities(destination);
            },
            async signup(firstName, lastName, email, password) {
                return userApi.signup(firstName, lastName, email, password);
            },
            async login(email, password) {
                return userApi.login(email, password);
            },
            async updateUserProfile(userId, profileData) {
                return userApi.updateUserProfile(userId, profileData);
            },
            async deleteUserAccount(userId) {
                return userApi.deleteUserAccount(userId);
            },
            // Review Management
            async saveReview(tripId, userId, reviewData) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const reviews = JSON.parse(localStorage.getItem('bharattrip_reviews')) || [];
                        const review = {
                            id: `review_${Date.now()}`,
                            tripId,
                            userId,
                            userName: reviewData.userName || 'Anonymous',
                            rating: reviewData.rating,
                            title: reviewData.title || '',
                            comment: reviewData.comment || '',
                            createdAt: new Date().toISOString()
                        };
                        reviews.push(review);
                        localStorage.setItem('bharattrip_reviews', JSON.stringify(reviews));
                        resolve(review);
                    }, 300);
                });
            },
            async getTripReviews(tripId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const reviews = JSON.parse(localStorage.getItem('bharattrip_reviews')) || [];
                        const tripReviews = reviews.filter(r => r.tripId === tripId);
                        // Sort by date, newest first
                        tripReviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        resolve(tripReviews);
                    }, 200);
                });
            },
            async getTripAverageRating(tripId) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const reviews = JSON.parse(localStorage.getItem('bharattrip_reviews')) || [];
                        const tripReviews = reviews.filter(r => r.tripId === tripId);
                        if (tripReviews.length === 0) {
                            resolve({ average: 0, count: 0 });
                        } else {
                            const sum = tripReviews.reduce((acc, r) => acc + r.rating, 0);
                            resolve({ average: (sum / tripReviews.length).toFixed(1), count: tripReviews.length });
                        }
                    }, 200);
                });
            }
        };

        // Toast Notification Component
        const Toast = ({ message, type, onDismiss }) => {
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            useEffect(() => {
                const timer = setTimeout(onDismiss, 5000);
                return () => clearTimeout(timer);
            }, [onDismiss]);

            return (
                <div className={`fixed bottom-5 right-5 ${bgColor} text-white py-3 px-6 rounded-lg shadow-xl z-50 flex items-center animate-fade-in-up`}>
                    {type === 'success' ? 'âœ“' : 'âœ•'}
                    <span className="ml-3">{message}</span>
                    <button onClick={onDismiss} className="ml-4 font-bold">Ã—</button>
                </div>
            );
        };

        // Modal Component
        const Modal = ({ children, onClose, isDarkMode }) => {
            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className={`${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white/80 border-slate-200'} backdrop-blur-lg border rounded-2xl p-8 w-full max-w-md animate-fade-in-up`} onClick={e => e.stopPropagation()}>
                        {children}
                    </div>
                </div>
            );
        };

        // Star Rating Component
        const StarRating = ({ rating, onRate, isEditable = false, size = 'md' }) => {
            const sizeClasses = {
                sm: 'w-4 h-4',
                md: 'w-5 h-5',
                lg: 'w-6 h-6'
            };
            const starSize = sizeClasses[size] || sizeClasses.md;
            
            return (
                <div className="flex items-center gap-1">
                    {[1, 2, 3, 4, 5].map((star) => (
                        <button
                            key={star}
                            type="button"
                            onClick={() => isEditable && onRate && onRate(star)}
                            disabled={!isEditable}
                            className={`
                                ${isEditable ? 'cursor-pointer hover:scale-110 transition-transform' : 'cursor-default'}
                                ${star <= rating ? 'text-yellow-400' : 'text-gray-300 dark:text-gray-600'}
                            `}
                        >
                            <icons.Star className={`${starSize} ${star <= rating ? 'fill-current' : ''}`} />
                        </button>
                    ))}
                </div>
            );
        };

        // Review Card Component
        const ReviewCard = ({ review, isDarkMode }) => {
            return (
                <div className={`${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/50 border-slate-200'} backdrop-blur-lg border rounded-xl p-4 mb-4`}>
                    <div className="flex items-start justify-between mb-2">
                        <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                                <h4 className={`font-semibold ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>
                                    {review.userName}
                                </h4>
                                {review.title && (
                                    <span className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                                        - {review.title}
                                    </span>
                                )}
                            </div>
                            <StarRating rating={review.rating} isEditable={false} size="sm" />
                        </div>
                        <span className={`text-xs ${isDarkMode ? 'text-slate-500' : 'text-slate-500'}`}>
                            {new Date(review.createdAt).toLocaleDateString()}
                        </span>
                    </div>
                    {review.comment && (
                        <p className={`text-sm ${isDarkMode ? 'text-slate-300' : 'text-slate-700'} mt-2`}>
                            {review.comment}
                        </p>
                    )}
                </div>
            );
        };

        // ItineraryCard Component
        const ItineraryCard = ({ trip, onCopy, onRequestJoin, isDarkMode, onViewBudget, onEdit, onViewReviews }) => {
            const getStatusColor = (status) => {
                switch (status) {
                    case 'approved': return 'bg-green-500';
                    case 'pending': return 'bg-yellow-500';
                    case 'rejected': return 'bg-red-500';
                    case 'private': return 'bg-gray-500';
                    case 'copied': return 'bg-cyan-500';
                    default: return 'bg-gray-500';
                }
            };
                const progress = useMemo(() => {
                if (!trip.startDate || !trip.endDate) return 0;
                const today = new Date();
                const startDate = new Date(trip.startDate);
                const endDate = new Date(trip.endDate);
                
                if (today < startDate) return 0;
                if (today > endDate) return 100;

                const totalDuration = endDate.getTime() - startDate.getTime();
                if (totalDuration <= 0) return 100;
                const elapsed = today.getTime() - startDate.getTime();
                return Math.min(100, Math.round((elapsed / totalDuration) * 100));
            }, [trip]);

            const destinationName = trip.final_destination || trip.title?.split(' to ')[1] || 'Dream Destination';
            const isDark = isDarkMode || document.documentElement.classList.contains('dark');

            return (
                <div className={`${isDark ? 'bg-slate-800/50 border-slate-700' : 'bg-white/50 border-slate-200'} backdrop-blur-lg border rounded-2xl p-5 transition-all duration-300 hover:shadow-2xl hover:shadow-purple-500/20 hover:-translate-y-1 flex flex-col`}>
                    <div className="relative">
                        <img 
                            src={`https://source.unsplash.com/400x300/?${encodeURIComponent(destinationName)}`} 
                            onError={(e) => { e.target.onerror = null; e.target.src=`https://placehold.co/400x300/${isDark ? '1e293b/94a3b8' : 'e2e8f0/475569'}?text=${encodeURIComponent(destinationName)}`; }}
                            alt={trip.title || 'Trip'} 
                            className="rounded-lg w-full h-40 object-cover mb-4"
                        />
                        {trip.status && (
                            <div className={`absolute top-2 right-2 text-xs font-bold text-white px-2 py-1 rounded-full ${getStatusColor(trip.status)}`}>
                                {trip.status}
                            </div>
                        )}
                    </div>
                    <h3 className={`text-xl font-bold ${isDark ? 'text-white' : 'text-slate-800'} mb-2 truncate`}>{trip.title || 'Untitled Trip'}</h3>
                    <p className={`${isDark ? 'text-slate-400' : 'text-slate-600'} text-sm mb-3 flex items-center`}>
                        <icons.Clock className="w-4 h-4 mr-2"/> {trip.duration_days || 0} Days
                    </p>
                    {trip.startDate && trip.endDate && (
                        <div className={`w-full ${isDark ? 'bg-slate-700' : 'bg-slate-200'} rounded-full h-2.5 mb-4`}>
                            <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2.5 rounded-full" style={{ width: `${progress}%` }}></div>
                        </div>
                    )}
                    <div className="mt-auto grid grid-cols-2 gap-2">
                        {onCopy && <button onClick={() => onCopy(trip)} className="text-sm bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"><icons.Copy className="w-4 h-4 mr-2"/> Copy</button>}
                        {onEdit && <button onClick={() => onEdit(trip)} className="text-sm bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"><icons.Edit className="w-4 h-4 mr-2"/> Edit</button>}
                        {onRequestJoin && <button onClick={() => onRequestJoin(trip)} className="text-sm bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"><icons.UserPlus className="w-4 h-4 mr-2"/> Join</button>}
                        {onViewBudget && <button onClick={() => onViewBudget(trip)} className="text-sm bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center"><icons.Rupee className="w-4 h-4 mr-2"/> Budget</button>}
                        {onViewReviews && <button onClick={() => onViewReviews(trip)} className="text-sm bg-amber-600 hover:bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center justify-center col-span-2"><icons.Star className="w-4 h-4 mr-2"/> Reviews & Ratings</button>}
                    </div>
                </div>
            );
        };

        // Login/Signup Component
        function LoginSignup({ onLoginSuccess, isDarkMode, setIsDarkMode }) {
            const [isLogin, setIsLogin] = useState(true);
            const [formData, setFormData] = useState({ firstName: '', lastName: '', email: '', password: '', confirmPassword: '' });
            const [toast, setToast] = useState(null);
            const [isLoading, setIsLoading] = useState(false);

            const handleInputChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setToast(null);
                if (isLogin) {
                    try {
                        const user = await userApi.login(formData.email, formData.password);
                        setToast({ message: 'Welcome back! ðŸŽ‰', type: 'success' });
                        setTimeout(() => onLoginSuccess(user), 1500);
                    } catch (error) {
                        setToast({ message: error.message, type: 'error' });
                    }
                } else {
                    if (formData.password !== formData.confirmPassword) {
                        setToast({ message: "Passwords don't match.", type: 'error' });
                        setIsLoading(false);
                        return;
                    }
                    try {
                        const newUser = await userApi.signup(formData.firstName, formData.lastName, formData.email, formData.password);
                        setToast({ message: 'Account created successfully! Please log in.', type: 'success' });
                        setIsLogin(true);
                        setFormData({ firstName: '', lastName: '', email: '', password: '', confirmPassword: '' });
                    } catch (error) {
                        setToast({ message: error.message, type: 'error' });
                    }
                }
                setIsLoading(false);
            };

            return (
                <div className={`min-h-screen w-full flex items-center justify-center ${isDarkMode ? 'bg-gradient-to-br from-slate-900 via-indigo-900 to-purple-900' : 'bg-gradient-to-br from-gray-50 via-blue-100 to-violet-100'} p-4`}>
                    {toast && <Toast message={toast.message} type={toast.type} onDismiss={() => setToast(null)} />}
                    <div className={`${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/60 border-white/80'} w-full max-w-md backdrop-blur-xl border rounded-2xl shadow-2xl p-8 transition-all duration-500`}>
                        <div className="text-center mb-6">
                            <div className="text-6xl mb-4">ðŸ‡®ðŸ‡³</div>
                            <h1 className={`text-4xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-2`}>BharatTrip AI</h1>
                            <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>Your AI-Powered Travel Companion</p>
                        </div>
                        <div className={`flex ${isDarkMode ? 'bg-slate-900' : 'bg-slate-100'} p-1 rounded-lg mb-6`}>
                            <button onClick={() => setIsLogin(true)} className={`w-1/2 p-2 rounded-md font-semibold transition-colors ${isLogin ? 'bg-indigo-600 text-white' : `${isDarkMode ? 'text-slate-400 hover:bg-slate-800' : 'text-slate-500 hover:bg-slate-200'}`}`}>Sign In</button>
                            <button onClick={() => setIsLogin(false)} className={`w-1/2 p-2 rounded-md font-semibold transition-colors ${!isLogin ? 'bg-purple-600 text-white' : `${isDarkMode ? 'text-slate-400 hover:bg-slate-800' : 'text-slate-500 hover:bg-slate-200'}`}`}>Sign Up</button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <div className="flex space-x-4">
                                    <input
                                        type="text"
                                        name="firstName"
                                        placeholder="First Name"
                                        value={formData.firstName}
                                        onChange={handleInputChange}
                                        className={`w-1/2 ${isDarkMode ? 'bg-slate-700/50 border-slate-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 outline-none transition`}
                                        required
                                    />
                                    <input
                                        type="text"
                                        name="lastName"
                                        placeholder="Last Name"
                                        value={formData.lastName}
                                        onChange={handleInputChange}
                                        className={`w-1/2 ${isDarkMode ? 'bg-slate-700/50 border-slate-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 outline-none transition`}
                                        required
                                    />
                                </div>
                            )}
                            <input
                                type="email"
                                name="email"
                                placeholder="Email"
                                value={formData.email}
                                onChange={handleInputChange}
                                className={`w-full ${isDarkMode ? 'bg-slate-700/50 border-slate-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 outline-none transition`}
                                required
                            />
                            <input
                                type="password"
                                name="password"
                                placeholder="Password"
                                value={formData.password}
                                onChange={handleInputChange}
                                className={`w-full ${isDarkMode ? 'bg-slate-700/50 border-slate-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 outline-none transition`}
                                required
                            />
                            {!isLogin && (
                                <input
                                    type="password"
                                    name="confirmPassword"
                                    placeholder="Confirm Password"
                                    value={formData.confirmPassword}
                                    onChange={handleInputChange}
                                    className={`w-full ${isDarkMode ? 'bg-slate-700/50 border-slate-600 text-white' : 'bg-gray-50 border-gray-300 text-gray-900'} border rounded-lg p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 outline-none transition`}
                                    required
                                />
                            )}
                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white font-bold py-3 rounded-lg text-lg transition-all duration-300 shadow-lg hover:shadow-purple-500/30 disabled:opacity-50 flex items-center justify-center"
                            >
                                {isLoading ? (
                                    <div className="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div>
                                ) : (
                                    <>
                                        {isLogin ? 'âœ¨ Sign In' : 'ðŸŒŸ Create Account'}
                                    </>
                                )}
                            </button>
                        </form>
                        <div className="mt-6 flex justify-center">
                            <button
                                onClick={() => setIsDarkMode(!isDarkMode)}
                                className={`p-3 rounded-full transition-colors duration-300 ${isDarkMode ? 'bg-slate-700 hover:bg-slate-600 text-yellow-400' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'}`}
                            >
                                {isDarkMode ? <icons.Sun /> : <icons.Moon />}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Onboarding Quiz Component
        function OnboardingQuiz({ user, onComplete, isDarkMode }) {
            const [step, setStep] = useState(1);
            const [preferences, setPreferences] = useState({ style: '', interests: [], pace: '', budget: '' });
            const [isLoading, setIsLoading] = useState(false);
            const isMountedRef = useRef(true);

            useEffect(() => {
                isMountedRef.current = true;
                return () => {
                    isMountedRef.current = false;
                };
            }, []);

            const handleSelect = (key, value) => {
                if (key === 'interests') {
                    setPreferences(p => ({
                        ...p,
                        interests: p.interests.includes(value)
                            ? p.interests.filter(i => i !== value)
                            : [...p.interests, value]
                    }));
                } else {
                    setPreferences(p => ({ ...p, [key]: value }));
                    if (key !== 'interests' && step < 4) {
                        setTimeout(nextStep, 300);
                    }
                }
            };

            const nextStep = () => setStep(s => s + 1);
            const prevStep = () => setStep(s => s - 1);

            const handleSubmit = async () => {
                setIsLoading(true);
                try {
                    await userApi.updateUserProfile(user.id, { preferences });
                    if (isMountedRef.current) {
                        setTimeout(() => onComplete(preferences), 500);
                    }
                } catch (error) {
                    console.error("Failed to save preferences:", error);
                    if (isMountedRef.current) {
                        setIsLoading(false);
                    }
                }
            };

            const renderStep = () => {
                switch (step) {
                    case 1:
                        return (
                            <div>
                                <h3 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-6`}>
                                    <span className="text-4xl mr-3">ðŸŽ¯</span>
                                    What's your travel style?
                                </h3>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    {[
                                        { style: 'Adventure', icon: 'ðŸƒâ€â™‚ï¸', desc: 'Thrilling experiences' },
                                        { style: 'Relaxation', icon: 'ðŸŒ´', desc: 'Peace and calm' },
                                        { style: 'Cultural', icon: 'ðŸ›ï¸', desc: 'Local traditions' },
                                        { style: 'Luxury', icon: 'âœ¨', desc: 'Premium experiences' },
                                        { style: 'Budget', icon: 'ðŸ’°', desc: 'Value for money' },
                                        { style: 'Family', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦', desc: 'Kid-friendly' }
                                    ].map(item => (
                                        <button
                                            key={item.style}
                                            onClick={() => handleSelect('style', item.style)}
                                            className={`p-6 rounded-xl font-semibold transition-all duration-300 hover:-translate-y-1 ${
                                                preferences.style === item.style 
                                                ? 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white ring-2 ring-purple-400 shadow-lg' 
                                                : `${isDarkMode ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-white text-slate-800 hover:bg-slate-50'} border border-slate-200 dark:border-slate-700`
                                            }`}
                                        >
                                            <div className="text-3xl mb-2">{item.icon}</div>
                                            <div>{item.style}</div>
                                            <div className={`text-xs mt-1 ${preferences.style === item.style ? 'text-white/80' : 'text-slate-500 dark:text-slate-400'}`}>
                                                {item.desc}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        );
                    case 2:
                        return (
                            <div>
                                <h3 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-6`}>
                                    <span className="text-4xl mr-3">ðŸŽ¨</span>
                                    Pick your interests
                                </h3>
                                <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mb-6`}>Select all that you'd like to experience.</p>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {[
                                        { name: 'History', icon: 'ðŸº' },
                                        { name: 'Food', icon: 'ðŸœ' },
                                        { name: 'Nature', icon: 'ðŸŒ¿' },
                                        { name: 'Art', icon: 'ðŸŽ¨' },
                                        { name: 'Spirituality', icon: 'ðŸ•‰ï¸' },
                                        { name: 'Shopping', icon: 'ðŸ›ï¸' },
                                        { name: 'Adventure', icon: 'ðŸƒâ€â™‚ï¸' },
                                        { name: 'Wellness', icon: 'ðŸ§˜â€â™€ï¸' }
                                    ].map(item => (
                                        <button
                                            key={item.name}
                                            onClick={() => handleSelect('interests', item.name)}
                                            className={`p-4 rounded-xl font-semibold transition-all duration-300 hover:-translate-y-1 ${
                                                preferences.interests.includes(item.name)
                                                ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white ring-2 ring-purple-400 shadow-lg'
                                                : `${isDarkMode ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-white text-slate-800 hover:bg-slate-50'} border border-slate-200 dark:border-slate-700`
                                            }`}
                                        >
                                            <div className="text-3xl mb-2">{item.icon}</div>
                                            <div>{item.name}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        );
                    case 3:
                        return (
                            <div>
                                <h3 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-6`}>
                                    <span className="text-4xl mr-3">âš¡</span>
                                    Choose your pace
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {[
                                        { pace: 'Fast-Paced', icon: 'ðŸƒâ€â™‚ï¸', desc: 'Pack in lots of activities' },
                                        { pace: 'Balanced', icon: 'âš–ï¸', desc: 'Mix of activity and rest' },
                                        { pace: 'Relaxed', icon: 'ðŸŒ…', desc: 'Take it slow and easy' }
                                    ].map(item => (
                                        <button
                                            key={item.pace}
                                            onClick={() => handleSelect('pace', item.pace)}
                                            className={`p-6 rounded-xl font-semibold transition-all duration-300 hover:-translate-y-1 ${
                                                preferences.pace === item.pace
                                                ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white ring-2 ring-blue-400 shadow-lg'
                                                : `${isDarkMode ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-white text-slate-800 hover:bg-slate-50'} border border-slate-200 dark:border-slate-700`
                                            }`}
                                        >
                                            <div className="text-3xl mb-2">{item.icon}</div>
                                            <div>{item.pace}</div>
                                            <div className={`text-xs mt-1 ${preferences.pace === item.pace ? 'text-white/80' : 'text-slate-500 dark:text-slate-400'}`}>
                                                {item.desc}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        );
                    case 4:
                        return (
                            <div>
                                <h3 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-6`}>
                                    <span className="text-4xl mr-3">ðŸ’°</span>
                                    Travel budget
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {[
                                        { budget: 'Budget-Friendly', icon: 'ðŸ’°', desc: 'â‚¹1,000-2,500/day', details: 'Hostels, local transport' },
                                        { budget: 'Mid-Range', icon: 'ðŸ’Ž', desc: 'â‚¹2,500-5,000/day', details: '3-star hotels, AC transport' },
                                        { budget: 'Premium', icon: 'ðŸ‘‘', desc: 'â‚¹5,000+/day', details: 'Luxury stays & experiences' }
                                    ].map(item => (
                                        <button
                                            key={item.budget}
                                            onClick={() => handleSelect('budget', item.budget)}
                                            className={`p-6 rounded-xl font-semibold transition-all duration-300 hover:-translate-y-1 ${
                                                preferences.budget === item.budget
                                                ? 'bg-gradient-to-r from-green-500 to-teal-500 text-white ring-2 ring-green-400 shadow-lg'
                                                : `${isDarkMode ? 'bg-slate-800 text-white hover:bg-slate-700' : 'bg-white text-slate-800 hover:bg-slate-50'} border border-slate-200 dark:border-slate-700`
                                            }`}
                                        >
                                            <div className="text-3xl mb-2">{item.icon}</div>
                                            <div>{item.budget}</div>
                                            <div className={`text-sm mt-1 font-bold ${preferences.budget === item.budget ? 'text-white' : 'text-slate-500 dark:text-slate-400'}`}>
                                                {item.desc}
                                            </div>
                                            <div className={`text-xs mt-1 ${preferences.budget === item.budget ? 'text-white/80' : 'text-slate-500 dark:text-slate-400'}`}>
                                                {item.details}
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        );
                    default:
                        return null;
                }
            };

            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className={`${isDarkMode ? 'bg-slate-800/90 border-slate-700' : 'bg-white/95 border-white/80'} backdrop-blur-xl border rounded-2xl p-8 w-full max-w-3xl animate-fade-in-up shadow-2xl`}>
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h2 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-2`}>Personalize Your BharatTrip âœ¨</h2>
                                <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>Let's tailor your perfect Indian journey.</p>
                            </div>
                            <div className={`${isDarkMode ? 'bg-slate-700' : 'bg-slate-100'} px-4 py-2 rounded-xl`}>
                                <span className={`font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>{step}</span>
                                <span className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}> / 4</span>
                            </div>
                        </div>
                        <div className="mb-4">
                            <div className={`w-full ${isDarkMode ? 'bg-slate-700' : 'bg-slate-200'} rounded-full h-2`}>
                                <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all duration-500" 
                                    style={{ width: `${(step / 4) * 100}%` }}></div>
                            </div>
                        </div>
                        <div className="mb-8 min-h-[350px]">
                            {renderStep()}
                        </div>
                        <div className="flex justify-between items-center">
                            {step > 1 && (
                                <button
                                    onClick={prevStep}
                                    className={`flex items-center px-6 py-3 rounded-xl font-semibold transition-colors ${
                                        isDarkMode 
                                        ? 'text-slate-400 hover:bg-slate-700' 
                                        : 'text-slate-600 hover:bg-slate-100'
                                    }`}
                                >
                                    â† Back
                                </button>
                            )}
                            {step === 4 ? (
                                <button
                                    onClick={handleSubmit}
                                    disabled={isLoading}
                                    className="flex items-center px-8 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-semibold hover:from-indigo-600 hover:to-purple-600 transition-all duration-300 ml-auto disabled:opacity-50"
                                >
                                    {isLoading ? (
                                        <div className="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                                    ) : (
                                        <>
                                            Start My Journey âœ¨
                                        </>
                                    )}
                                </button>
                            ) : (
                                (step === 2 && preferences.interests.length === 0) ? (
                                    <div className={`ml-auto text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                                        Select at least one interest to continue
                                    </div>
                                ) : (
                                    <button
                                        onClick={nextStep}
                                        className="flex items-center px-8 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl font-semibold hover:from-indigo-600 hover:to-purple-600 transition-all duration-300 ml-auto"
                                    >
                                        Continue â†’
                                    </button>
                                )
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Backend Status Hook
        function useBackendStatus() {
            const [isOnline, setIsOnline] = useState(false);
            
            useEffect(() => {
                const checkStatus = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/health`);
                        const data = await res.json();
                        setIsOnline(data.status === 'OK');
                    } catch (err) {
                        setIsOnline(false);
                    }
                };
                
                checkStatus();
                const interval = setInterval(checkStatus, 30000);
                return () => clearInterval(interval);
            }, []);
            
            return isOnline;
        }

        // Admin Panel Component
        const AdminPanel = ({ user, isDarkMode }) => {
            const [pendingTrips, setPendingTrips] = useState([]);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);

            const fetchPendingTrips = useCallback(async () => {
                setLoading(true);
                const trips = await mockApi.getPublicTrips('all');
                setPendingTrips(trips.filter(t => t.status === 'pending'));
                setLoading(false);
            }, []);

            useEffect(() => {
                fetchPendingTrips();
            }, [fetchPendingTrips]);

            const handleApproval = async (tripId, newStatus) => {
                try {
                    await mockApi.updateItineraryStatus(tripId, newStatus);
                    setToast({ message: `Trip has been ${newStatus}.`, type: 'success' });
                    fetchPendingTrips();
                } catch (error) {
                    setToast({ message: "Failed to update trip status.", type: 'error' });
                }
            };

            if (loading) return <div className="flex justify-center items-center h-full"><div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div></div>;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    {toast && <Toast message={toast.message} type={toast.type} onDismiss={() => setToast(null)} />}
                    <h1 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-2`}>Admin Panel - Pending Approvals</h1>
                    <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mb-6`}>Review and approve trips that users want to share with the community. Approved trips will appear in the Community section.</p>
                    {pendingTrips.length > 0 ? (
                        <div className="space-y-4">
                            {pendingTrips.map(trip => (
                                <div key={trip.id} className={`${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/50 border-slate-200'} backdrop-blur-lg border rounded-xl p-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4 shadow-lg`}>
                                    <div className="flex-1">
                                        <h3 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'} mb-2`}>{trip.title || 'Untitled Trip'}</h3>
                                        <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mb-1`}>By User ID: {trip.ownerId}</p>
                                        {trip.starting_destination && trip.final_destination && (
                                            <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                                                Route: {trip.starting_destination} â†’ {trip.final_destination}
                                            </p>
                                        )}
                                        {trip.startDate && trip.endDate && (
                                            <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                                                Dates: {new Date(trip.startDate).toLocaleDateString()} - {new Date(trip.endDate).toLocaleDateString()}
                                            </p>
                                        )}
                                    </div>
                                    <div className="flex gap-4 flex-shrink-0">
                                        <button 
                                            onClick={() => handleApproval(trip.id, 'approved')} 
                                            className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg"
                                        >
                                            âœ“ Approve
                                        </button>
                                        <button 
                                            onClick={() => handleApproval(trip.id, 'rejected')} 
                                            className="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition-colors shadow-md hover:shadow-lg"
                                        >
                                            âœ• Reject
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div className={`${isDarkMode ? 'bg-slate-800/50' : 'bg-white/50'} backdrop-blur-lg rounded-xl p-8 text-center`}>
                            <p className={`text-lg ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>No pending trips for approval.</p>
                            <p className={`text-sm ${isDarkMode ? 'text-slate-500' : 'text-slate-500'} mt-2`}>All trips have been reviewed.</p>
                        </div>
                    )}
                </div>
            );
        };

        function App() {
            const [darkMode, setDarkMode] = useState(() => window.matchMedia('(prefers-color-scheme: dark)').matches);
            const [currentPage, setCurrentPage] = useState('home');
            const backendOnline = useBackendStatus();
            const [user, setUser] = useState(null);
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [beachImages, setBeachImages] = useState([]);
            const [mountainImages, setMountainImages] = useState([]);
            const [selectedTrip, setSelectedTrip] = useState(null);
            const [tripToEdit, setTripToEdit] = useState(null);
            
            useEffect(() => {
                // Load beach images
                fetch('Beach images data')
                    .then(response => response.json())
                    .catch(() => {
                        // Fallback to dummy beach data
                        setBeachImages([
                            { name: 'Agonda Beach', location: 'Goa', image: 'Beach images data/Agonda Beach.jpg', mapUrl: 'https://goo.gl/maps/xyz1' },
                            { name: 'Auroville Beach', location: 'Puducherry', image: 'Beach images data/Auroville Beach.jpg', mapUrl: 'https://goo.gl/maps/xyz2' },
                            { name: 'Baga Beach', location: 'Goa', image: 'Beach images data/Baga Beach.jpg', mapUrl: 'https://goo.gl/maps/xyz3' },
                            { name: 'Cherai Beach', location: 'Kerala', image: 'Beach images data/Cherai Beach.jpg', mapUrl: 'https://goo.gl/maps/xyz4' },
                            // Add more beach data...
                        ]);
                    });

                // Load mountain images
                fetch('Mountain images data')
                    .then(response => response.json())
                    .catch(() => {
                        // Fallback to dummy mountain data
                        setMountainImages([
                            { name: 'Anamudi', location: 'Kerala', image: 'mountain images data/Anamudi (1).jpg', mapUrl: 'https://goo.gl/maps/xyz5' },
                            { name: 'Aravalli Range', location: 'Rajasthan', image: 'mountain images data/Aravalli Range.jpg', mapUrl: 'https://goo.gl/maps/xyz6' },
                            { name: 'Chembra Peak', location: 'Kerala', image: 'mountain images data/Chembra Peak.png', mapUrl: 'https://goo.gl/maps/xyz7' },
                            { name: 'Dzukou Valley', location: 'Nagaland', image: 'mountain images data/Dzukou Valley.jpg', mapUrl: 'https://goo.gl/maps/xyz8' },
                            // Add more mountain data...
                        ]);
                    });
            }, []);
            
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            const handleLoginSuccess = (userData) => {
                if (!userData) {
                    console.error('No user data received');
                    return;
                }
                // Ensure user object has required properties
                const userWithDefaults = {
                    id: userData.id || `user_${Date.now()}`,
                    firstName: userData.firstName || 'User',
                    lastName: userData.lastName || '',
                    email: userData.email || '',
                    preferences: userData.preferences || null,
                    photoUrl: userData.photoUrl || null,
                    ...userData
                };
                setUser(userWithDefaults);
                if (!userWithDefaults.preferences) {
                    setShowOnboarding(true);
                } else {
                    setShowOnboarding(false);
                }
            };

            const handleOnboardingComplete = (preferences) => {
                if (user) {
                    const updatedUser = { ...user, preferences };
                    userApi.updateUserProfile(user.id, { preferences }).catch(err => {
                        console.error('Failed to save preferences:', err);
                    });
                    setUser(updatedUser);
                }
                setShowOnboarding(false);
            };
            
            // Listen for navigation events from planner
            useEffect(() => {
                const handleNavigateToExplore = () => {
                    setCurrentPage('explore');
                };
                window.addEventListener('navigateToExplore', handleNavigateToExplore);
                return () => {
                    window.removeEventListener('navigateToExplore', handleNavigateToExplore);
                };
            }, []);
            
            // Validate user state in effect to avoid render issues
            useEffect(() => {
                if (user && (!user.firstName || !user.id)) {
                    console.error('Invalid user state detected, resetting:', user);
                    setUser(null);
                }
            }, [user]);
            
            // Show login if no user or invalid user
            if (!user || !user.firstName) {
                return <LoginSignup onLoginSuccess={handleLoginSuccess} isDarkMode={darkMode} setIsDarkMode={setDarkMode} />;
            }

            // Show onboarding if needed
            if (showOnboarding) {
                return <OnboardingQuiz user={user} onComplete={handleOnboardingComplete} isDarkMode={darkMode} />;
            }

            return (
                <div className={`min-h-screen ${darkMode ? 'dark bg-gray-900' : 'bg-gray-50'}`}>
                    {/* Header */}
                    <header className="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50">
                        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
                            <h1 className="text-2xl font-bold bg-gradient-to-r from-blue-500 to-indigo-600 bg-clip-text text-transparent">
                                BharatTrip AI ðŸ‡®ðŸ‡³
                            </h1>
                            
                            <div className="flex items-center gap-4">
                                {/* User Menu */}
                                <div className="relative group">
                                    <button className="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                                        <img
                                            src={user?.photoUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent((user?.firstName || 'User') + ' ' + (user?.lastName || ''))}&background=6366f1&color=fff`}
                                            alt="Profile"
                                            className="w-8 h-8 rounded-full"
                                        />
                                        <span>{user?.firstName || 'User'}</span>
                                        <icons.ChevronDown />
                                    </button>
                                    <div className="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 hidden group-hover:block">
                                        <button
                                            onClick={() => setUser(null)}
                                            className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                                        >
                                            Sign Out
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Backend Status */}
                                <div className="flex items-center gap-2 text-sm">
                                    <div className={`w-2 h-2 rounded-full ${backendOnline ? 'bg-green-500 status-pulse' : 'bg-red-500'}`}></div>
                                    <span className="text-gray-600 dark:text-gray-300">
                                        {backendOnline ? 'Connected' : 'Offline'}
                                    </span>
                                </div>
                                
                                {/* Admin Panel Button */}
                                <button
                                    onClick={() => window.open('admin-panel.html', '_blank')}
                                    className={`p-2 rounded-full transition-colors duration-300 ${darkMode ? 'bg-purple-700 hover:bg-purple-600 text-white' : 'bg-purple-100 hover:bg-purple-200 text-purple-700'}`}
                                    title="Admin Panel"
                                >
                                    <icons.Shield />
                                </button>
                                
                                {/* Dark Mode Toggle */}
                                <button
                                    onClick={() => setDarkMode(!darkMode)}
                                    className={`p-2 rounded-full transition-colors duration-300 ${darkMode ? 'bg-slate-700 hover:bg-slate-600 text-yellow-400' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'}`}
                                >
                                    {darkMode ? <icons.Sun /> : <icons.Moon />}
                                </button>
                            </div>
                        </div>
                    </header>
                    
                    {/* Navigation */}
                    <nav className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                        <div className="container mx-auto px-4">
                            <div className="flex gap-1 overflow-x-auto">
                                {[
                                    { id: 'home', label: 'Home', icon: icons.Home },
                                    { id: 'explore', label: 'Explore', icon: icons.Map },
                                    { id: 'planner', label: 'Trip Planner', icon: icons.Route },
                                    { id: 'dreamTrip', label: 'Dream Trip', icon: () => <span className="text-xl">ðŸ’«</span> },
                                    { id: 'travelPartner', label: 'Find Partner', icon: icons.Users },
                                    { id: 'cultural', label: 'Cultural', icon: () => <span className="text-xl">ðŸŽ­</span> },
                                    { id: 'profile', label: 'Profile', icon: icons.User },
                                    { id: 'admin', label: 'Admin', icon: icons.Shield }
                                ].map(page => (
                                    <button
                                        key={page.id}
                                        onClick={() => setCurrentPage(page.id)}
                                        className={`flex items-center gap-2 px-4 py-3 border-b-2 transition ${
                                            currentPage === page.id
                                                ? 'border-blue-600 text-blue-600'
                                                : 'border-transparent text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200'
                                        }`}
                                    >
                                        <page.icon />
                                        <span className="hidden sm:inline">{page.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>
                    
                    {/* Main Content */}
                    <main className="container mx-auto px-4 py-8">
                        {currentPage === 'home' && <HomePage darkMode={darkMode} setCurrentPage={setCurrentPage} />}
                        {currentPage === 'explore' && <ExplorePage setCurrentPage={setCurrentPage} />}
                        {currentPage === 'planner' && <TripPlannerPage user={user} setCurrentPage={setCurrentPage} tripToEdit={tripToEdit} setTripToEdit={setTripToEdit} darkMode={darkMode} />}
                        {currentPage === 'dreamTrip' && <DreamTripPlanner user={user} setCurrentPage={setCurrentPage} darkMode={darkMode} />}
                        {currentPage === 'travelPartner' && <TravelPartnerPage user={user} darkMode={darkMode} />}
                        {currentPage === 'cultural' && <CulturalInsightsPage />}
                        {currentPage === 'profile' && <ProfilePage />}
                        {currentPage === 'community' && <CommunityPage user={user} darkMode={darkMode} />}
                        {currentPage === 'admin' && <AdminPanel user={user} isDarkMode={darkMode} />}
                    </main>
                </div>
            );
        }

        // Tourist Guide Profile Component
        function TouristGuideProfile({ locationType, onClose, darkMode }) {
            // Check if locationType is an object with admin guide data
            const isAdminGuide = locationType && typeof locationType === 'object' && locationType.guide;
            const actualLocationType = isAdminGuide ? locationType.type : locationType;
            
            // Get guides based on location type
            const getGuides = () => {
                // If admin guide data is provided, return it as a single guide
                if (isAdminGuide && locationType.guide) {
                    return [{
                        name: locationType.guide.name,
                        location: "Admin Updated Guide",
                        phone: locationType.guide.phone || "Not provided",
                        languages: locationType.guide.languages || "Not provided",
                        experience: locationType.guide.experience || "Not provided",
                        background: locationType.guide.experience || "Tourist guide information updated by admin.",
                        specialties: locationType.guide.experience || "Contact for details",
                        img: "https://randomuser.me/api/portraits/men/44.jpg",
                        rating: "5.0/5"
                    }];
                }
                
                if (actualLocationType === 'sacred') {
                    return [
                        {
                            name: "Shri Ram Mohan",
                            location: "Punjab & Golden Temple Specialist",
                            phone: "+91 98765 43210",
                            languages: "Punjabi, Hindi, English",
                            experience: "15+ years",
                            background: "Certified religious tourism guide with deep knowledge of Sikhism, Golden Temple history, and Amritsar heritage. Expert in organizing spiritual tours and langar experiences.",
                            specialties: "Golden Temple tours, Jallianwala Bagh, Partition Museum, local cuisine tours",
                            img: "https://randomuser.me/api/portraits/men/44.jpg",
                            rating: "4.9/5"
                        },
                        {
                            name: "Priya Sharma",
                            location: "Himalayan Temples & Char Dham",
                            phone: "+91 98001 11223",
                            languages: "Hindi, English, Garhwali",
                            experience: "12+ years",
                            background: "Specialized in Hindu pilgrimage sites in Uttarakhand. Expert in Kedarnath, Badrinath, and spiritual trekking. Well-versed in local customs and traditions.",
                            specialties: "Kedarnath Yatra, Badrinath, Gangotri, Yamunotri, high-altitude guidance",
                            img: "https://randomuser.me/api/portraits/women/58.jpg",
                            rating: "4.8/5"
                        },
                        {
                            name: "Ahmed Khan",
                            location: "Ajmer Sharif & Rajasthan Religious Sites",
                            phone: "+91 99988 77662",
                            languages: "Urdu, Hindi, English, Rajasthani",
                            experience: "18+ years",
                            background: "Dedicated guide for Ajmer Sharif Dargah and other Islamic heritage sites in Rajasthan. Expert in Sufi culture and local history.",
                            specialties: "Ajmer Sharif, Sufi culture, Islamic architecture, Rajasthan heritage",
                            img: "https://randomuser.me/api/portraits/men/18.jpg",
                            rating: "4.9/5"
                        },
                        {
                            name: "Meera Devi",
                            location: "Tamil Nadu & South Indian Temples",
                            phone: "+91 98100 22443",
                            languages: "Tamil, Hindi, English, Telugu",
                            experience: "14+ years",
                            background: "Specialized in South Indian temple architecture and rituals. Expert in Rameshwaram, Madurai, and other Dravidian temple tours.",
                            specialties: "Temple architecture, Dravidian culture, puja rituals, local festivals",
                            img: "https://randomuser.me/api/portraits/women/65.jpg",
                            rating: "4.7/5"
                        },
                        {
                            name: "Rajesh Pathak",
                            location: "North India Religious Circuit",
                            phone: "+91 96543 21987",
                            languages: "Hindi, English, Sanskrit",
                            experience: "20+ years",
                            background: "Veteran guide covering major religious destinations across North India. Expert in Varanasi, Mathura, Vrindavan, and Ayodhya tours.",
                            specialties: "Ganga aarti, temple tours, religious festivals, spiritual experiences",
                            img: "https://randomuser.me/api/portraits/men/50.jpg",
                            rating: "5.0/5"
                        }
                    ];
                } else if (locationType === 'mountain') {
                    return [
                        {
                            name: "Tashi Dorjee",
                            location: "Ladakh & High Altitude Specialist",
                            phone: "+91 98765 43210",
                            languages: "Ladakhi, Hindi, English, Tibetan",
                            experience: "15+ years",
                            background: "Certified mountaineer and trekking guide with expertise in Ladakh, Stok Kangri, and high-altitude adventures. Trained in mountain safety and rescue operations.",
                            specialties: "Stok Kangri trek, Markha Valley, high-altitude acclimatization, Ladakhi culture",
                            img: "https://randomuser.me/api/portraits/men/32.jpg",
                            rating: "4.9/5"
                        },
                        {
                            name: "Rajesh Kumar",
                            location: "Sikkim & Eastern Himalayas",
                            phone: "+91 98001 11223",
                            languages: "Hindi, English, Nepali, Sikkimese",
                            experience: "12+ years",
                            background: "Expert guide for Kangchenjunga region and Sikkim Himalayas. Specializes in multi-day treks, biodiversity tours, and cultural experiences.",
                            specialties: "Kangchenjunga base camp, Goechala trek, Sikkim culture, rhododendron trails",
                            img: "https://randomuser.me/api/portraits/men/44.jpg",
                            rating: "4.8/5"
                        },
                        {
                            name: "Sunil Rawat",
                            location: "Uttarakhand Mountains & Nanda Devi",
                            phone: "+91 99988 77662",
                            languages: "Hindi, English, Garhwali",
                            experience: "18+ years",
                            background: "Veteran mountaineer guiding expeditions to Nanda Devi, Kamet, and other Uttarakhand peaks. Expert in technical climbing and mountain safety.",
                            specialties: "Nanda Devi, Kamet expeditions, Valley of Flowers, Garhwal culture",
                            img: "https://randomuser.me/api/portraits/men/28.jpg",
                            rating: "4.9/5"
                        },
                        {
                            name: "Priya Narayanan",
                            location: "Kerala Hills & Nilgiri Mountains",
                            phone: "+91 98100 22443",
                            languages: "Malayalam, English, Hindi, Tamil",
                            experience: "10+ years",
                            background: "Nature guide specializing in Western Ghats, Nilgiris, and Kerala hill stations. Expert in wildlife, tea plantations, and eco-tourism.",
                            specialties: "Munnar tours, Nilgiri hills, wildlife spotting, tea estate visits",
                            img: "https://randomuser.me/api/portraits/women/68.jpg",
                            rating: "4.7/5"
                        },
                        {
                            name: "Tenzing Sherpa",
                            location: "Himalayan Expeditions & Peak Climbing",
                            phone: "+91 96543 21987",
                            languages: "Nepali, Hindi, English, Sherpa",
                            experience: "22+ years",
                            background: "Professional mountaineer with extensive experience in Himalayan peaks. Certified by Indian Mountaineering Foundation. Expert in expedition planning.",
                            specialties: "Peak climbing, expedition planning, mountaineering training, high-altitude safety",
                            img: "https://randomuser.me/api/portraits/men/56.jpg",
                            rating: "5.0/5"
                        }
                    ];
                } else if (locationType === 'beach') {
                    return [
                        {
                            name: "Ananya Singh",
                            location: "Goa & Konkan Beaches",
                            phone: "+91 98765 43210",
                            languages: "English, Hindi, Konkani, Portuguese",
                            experience: "12+ years",
                            background: "Beach and heritage guide specializing in Goa's beaches, Portuguese architecture, and local culture. Expert in water sports and beach activities.",
                            specialties: "Palolem, Agonda, Baga beaches, water sports, Goan cuisine, heritage walks",
                            img: "https://randomuser.me/api/portraits/women/58.jpg",
                            rating: "4.9/5"
                        },
                        {
                            name: "Ravi Menon",
                            location: "Kerala Beaches & Backwaters",
                            phone: "+91 98001 11223",
                            languages: "Malayalam, English, Hindi",
                            experience: "14+ years",
                            background: "Expert guide for Varkala, Kovalam, and other Kerala beaches. Specializes in Ayurveda tours, backwater cruises, and coastal culture.",
                            specialties: "Varkala Beach, Kovalam, Ayurveda wellness, backwater tours, fishing village visits",
                            img: "https://randomuser.me/api/portraits/men/45.jpg",
                            rating: "4.8/5"
                        },
                        {
                            name: "Priya Nair",
                            location: "Andaman & Nicobar Islands",
                            phone: "+91 99988 77662",
                            languages: "English, Hindi, Tamil, Bengali",
                            experience: "10+ years",
                            background: "Specialized guide for Andaman Islands including Radhanagar Beach, Havelock, and Neil Island. Expert in water activities and marine life.",
                            specialties: "Radhanagar Beach, scuba diving, snorkeling, island hopping, cellular jail tours",
                            img: "https://randomuser.me/api/portraits/women/52.jpg",
                            rating: "4.9/5"
                        },
                        {
                            name: "Vikram Reddy",
                            location: "Tamil Nadu Coastal Beaches",
                            phone: "+91 98100 22443",
                            languages: "Tamil, English, Hindi, Telugu",
                            experience: "11+ years",
                            background: "Guide for Marina Beach, Mahabalipuram, and Tamil Nadu coastal destinations. Expert in historical sites and beach activities.",
                            specialties: "Marina Beach, Mahabalipuram, coastal temples, local seafood, water sports",
                            img: "https://randomuser.me/api/portraits/men/38.jpg",
                            rating: "4.7/5"
                        },
                        {
                            name: "Sneha Kulkarni",
                            location: "Karnataka & Om Beach Specialist",
                            phone: "+91 96543 21987",
                            languages: "Kannada, English, Hindi, Marathi",
                            experience: "9+ years",
                            background: "Beach guide for Gokarna, Om Beach, and Karnataka coastal areas. Expert in beach treks, camping, and coastal cuisine.",
                            specialties: "Om Beach, Gokarna, beach trekking, beach camping, local cuisine tours",
                            img: "https://randomuser.me/api/portraits/women/48.jpg",
                            rating: "4.8/5"
                        }
                    ];
                }
                return [];
            };

            const guides = getGuides();
            const locationTypeNames = {
                'sacred': 'Sacred Destinations',
                'mountain': 'Mountains',
                'beach': 'Beaches'
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4 overflow-y-auto">
                    <div className={`${darkMode ? 'bg-gray-900' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-4xl p-8 relative my-8 max-h-[90vh] overflow-y-auto`}>
                        <button
                            className="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                            onClick={onClose}
                        >
                            âœ•
                        </button>
                        
                        <div className="mb-6">
                            <h2 className="text-3xl font-bold mb-2 text-blue-700 dark:text-blue-300 flex items-center gap-3">
                                <span className="text-4xl">ðŸ§‘â€ðŸ’¼</span> Tourist Guides {isAdminGuide ? '(Admin Updated)' : `for ${locationTypeNames[actualLocationType] || 'Your Destination'}`}
                            </h2>
                            <p className="text-gray-600 dark:text-gray-400">Connect with experienced local guides in your destination</p>
                        </div>

                        <div className="space-y-6">
                            {guides.map((guide, idx) => (
                                <div key={idx} className={`${darkMode ? 'bg-gray-800' : 'bg-blue-50'} rounded-xl p-6 shadow-lg hover:shadow-xl transition transform hover:-translate-y-1`}>
                                    <div className="flex flex-col md:flex-row gap-4">
                                        <div className="flex-shrink-0">
                                            <img 
                                                src={guide.img} 
                                                alt={guide.name} 
                                                className="rounded-full h-24 w-24 object-cover border-4 border-blue-300 dark:border-blue-700"
                                            />
                                            <div className="mt-2 text-center">
                                                <span className={`text-xs font-semibold px-2 py-1 rounded ${darkMode ? 'bg-yellow-600 text-white' : 'bg-yellow-200 text-yellow-800'}`}>
                                                    â­ {guide.rating}
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <div className="flex-1">
                                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-2">
                                                <div>
                                                    <h3 className="text-xl font-bold text-gray-800 dark:text-white">{guide.name}</h3>
                                                    <p className="text-sm text-blue-600 dark:text-blue-400 font-medium">{guide.location}</p>
                                                </div>
                                                <span className={`text-xs font-semibold px-3 py-1 rounded-full ${darkMode ? 'bg-green-800 text-green-200' : 'bg-green-200 text-green-800'}`}>
                                                    {guide.experience}
                                                </span>
                                            </div>
                                            
                                            <p className="text-gray-700 dark:text-gray-300 mb-3 text-sm leading-relaxed">{guide.background}</p>
                                            
                                            <div className="mb-3">
                                                <p className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Specialties:</p>
                                                <p className="text-xs text-gray-600 dark:text-gray-400">{guide.specialties}</p>
                                            </div>
                                            
                                            <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                                                <div className="flex-1">
                                                    <p className="text-sm mb-1">
                                                        <span className="font-semibold text-blue-600 dark:text-blue-400">Languages: </span>
                                                        <span className="text-gray-700 dark:text-gray-300">{guide.languages}</span>
                                                    </p>
                                                    <p className="text-sm">
                                                        <span className="font-semibold text-blue-600 dark:text-blue-400">Contact: </span>
                                                        <a 
                                                            href={`tel:${guide.phone.replace(/\s+/g, '')}`} 
                                                            className="text-green-600 dark:text-green-400 hover:underline font-medium"
                                                        >
                                                            {guide.phone}
                                                        </a>
                                                    </p>
                                                </div>
                                                <a
                                                    href={`tel:${guide.phone.replace(/\s+/g, '')}`}
                                                    className={`px-6 py-2 rounded-lg font-semibold text-white transition ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-600 hover:bg-green-700'} flex items-center gap-2`}
                                                >
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                    </svg>
                                                    Call Now
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="mt-6 text-center">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Hotels Modal Component
        function HotelsModal({ location, hotels, onClose, darkMode }) {
            if (!hotels || hotels.length === 0) {
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
                        <div className={`${darkMode ? 'bg-gray-900' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-4xl p-8 relative`}>
                            <button
                                className="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                                onClick={onClose}
                            >
                                âœ•
                            </button>
                            <div className="text-center py-12">
                                <h2 className={`text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                    No Hotels Available
                                </h2>
                                <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Hotels for {location?.name || 'this location'} have not been added yet.
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4 overflow-y-auto">
                    <div className={`${darkMode ? 'bg-gray-900' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-5xl p-8 relative my-8 max-h-[90vh] overflow-y-auto`}>
                        <button
                            className="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                            onClick={onClose}
                        >
                            âœ•
                        </button>
                        
                        <div className="mb-6">
                            <h2 className="text-3xl font-bold mb-2 text-blue-700 dark:text-blue-300 flex items-center gap-3">
                                <span className="text-4xl">ðŸ¨</span> Hotels near {location?.name || 'Location'}
                            </h2>
                            <p className="text-gray-600 dark:text-gray-400">Find the perfect accommodation for your stay</p>
                        </div>

                        <div className="space-y-6">
                            {hotels.map((hotel) => (
                                <div key={hotel.id} className={`${darkMode ? 'bg-gray-800' : 'bg-blue-50'} rounded-xl p-6 shadow-lg hover:shadow-xl transition transform hover:-translate-y-1`}>
                                    <div className="flex flex-col md:flex-row gap-4">
                                        {hotel.image && (
                                            <div className="flex-shrink-0">
                                                <img 
                                                    src={hotel.image} 
                                                    alt={hotel.name}
                                                    className="w-full md:w-64 h-48 object-cover rounded-lg"
                                                />
                                            </div>
                                        )}
                                        <div className="flex-1">
                                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-2">
                                                <div>
                                                    <h3 className="text-xl font-bold text-gray-800 dark:text-white">{hotel.name}</h3>
                                                    <p className="text-sm text-blue-600 dark:text-blue-400 font-medium">{hotel.address}</p>
                                                </div>
                                                {hotel.rating && (
                                                    <span className={`text-sm font-semibold px-3 py-1 rounded-full ${darkMode ? 'bg-yellow-600 text-white' : 'bg-yellow-200 text-yellow-800'}`}>
                                                        â­ {hotel.rating}
                                                    </span>
                                                )}
                                            </div>
                                            
                                            {hotel.price && (
                                                <p className={`text-lg font-bold mb-3 ${darkMode ? 'text-green-400' : 'text-green-600'}`}>
                                                    â‚¹{hotel.price}/night
                                                </p>
                                            )}
                                            
                                            {hotel.amenities && (
                                                <div className="mb-3">
                                                    <p className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">Amenities:</p>
                                                    <p className="text-xs text-gray-600 dark:text-gray-400">{hotel.amenities}</p>
                                                </div>
                                            )}
                                            
                                            <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
                                                <div className="flex-1">
                                                    {hotel.phone && (
                                                        <p className="text-sm mb-1">
                                                            <span className="font-semibold text-blue-600 dark:text-blue-400">Phone: </span>
                                                            <a 
                                                                href={`tel:${hotel.phone.replace(/\s+/g, '')}`} 
                                                                className="text-green-600 dark:text-green-400 hover:underline font-medium"
                                                            >
                                                                {hotel.phone}
                                                            </a>
                                                        </p>
                                                    )}
                                                    {hotel.email && (
                                                        <p className="text-sm mb-1">
                                                            <span className="font-semibold text-blue-600 dark:text-blue-400">Email: </span>
                                                            <a 
                                                                href={`mailto:${hotel.email}`} 
                                                                className="text-blue-600 dark:text-blue-400 hover:underline"
                                                            >
                                                                {hotel.email}
                                                            </a>
                                                        </p>
                                                    )}
                                                    {hotel.website && (
                                                        <p className="text-sm">
                                                            <span className="font-semibold text-blue-600 dark:text-blue-400">Website: </span>
                                                            <a 
                                                                href={hotel.website} 
                                                                target="_blank" 
                                                                rel="noopener noreferrer"
                                                                className="text-blue-600 dark:text-blue-400 hover:underline"
                                                            >
                                                                Visit Website
                                                            </a>
                                                        </p>
                                                    )}
                                                </div>
                                                {hotel.phone && (
                                                    <a
                                                        href={`tel:${hotel.phone.replace(/\s+/g, '')}`}
                                                        className={`px-6 py-2 rounded-lg font-semibold text-white transition ${darkMode ? 'bg-green-600 hover:bg-green-700' : 'bg-green-600 hover:bg-green-700'} flex items-center gap-2`}
                                                    >
                                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                                        </svg>
                                                        Call Now
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="mt-6 text-center">
                            <button
                                onClick={onClose}
                                className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // AR Viewer Component for 3D Models (PLY and GLB files)
        function ARViewer({ location, plyFileUrl, glbFileUrl, onClose, darkMode }) {
            const containerRef = useRef(null);
            const sceneRef = useRef(null);
            const rendererRef = useRef(null);
            const cameraRef = useRef(null);
            const controlsRef = useRef(null);
            const modelRef = useRef(null);
            const animationRef = useRef(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [autoRotate, setAutoRotate] = useState(true);

            // Determine which file to use (prefer GLB over PLY)
            const modelFileUrl = glbFileUrl || plyFileUrl;
            const isGLB = !!glbFileUrl;

            useEffect(() => {
                console.log('AR Viewer - Location:', location);
                console.log('AR Viewer - Using:', isGLB ? 'GLB' : 'PLY');
                
                if (!modelFileUrl) {
                    console.log('AR Viewer - No 3D model file URL provided');
                    setLoading(false);
                    setError('No 3D model file available for this location');
                    return;
                }
                
                if (!containerRef.current) {
                    console.log('AR Viewer - Container not ready');
                    return;
                }

                // Initialize Three.js scene with gradient background
                const scene = new THREE.Scene();
                
                // Create gradient background
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 512);
                gradient.addColorStop(0, '#1a1a2e');
                gradient.addColorStop(0.5, '#16213e');
                gradient.addColorStop(1, '#0f0f23');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 512, 512);
                const texture = new THREE.CanvasTexture(canvas);
                scene.background = texture;
                sceneRef.current = scene;

                // Camera setup with better FOV
                const camera = new THREE.PerspectiveCamera(
                    50, 
                    containerRef.current.clientWidth / containerRef.current.clientHeight, 
                    0.1, 
                    1000
                );
                camera.position.set(3, 2, 5);
                cameraRef.current = camera;

                // High quality renderer
                const renderer = new THREE.WebGLRenderer({ 
                    antialias: true, 
                    alpha: true,
                    powerPreference: 'high-performance'
                });
                renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                renderer.outputEncoding = THREE.sRGBEncoding;
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.2;
                containerRef.current.appendChild(renderer.domElement);
                rendererRef.current = renderer;

                // OrbitControls for interactive viewing
                if (typeof THREE.OrbitControls !== 'undefined') {
                    const controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    controls.enableZoom = true;
                    controls.enablePan = true;
                    controls.minDistance = 1;
                    controls.maxDistance = 20;
                    controls.autoRotate = true;
                    controls.autoRotateSpeed = 1.5;
                    controlsRef.current = controls;
                }

                // Enhanced lighting setup
                // Ambient light for base illumination
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
                scene.add(ambientLight);

                // Main directional light (sun-like)
                const mainLight = new THREE.DirectionalLight(0xffffff, 1.0);
                mainLight.position.set(5, 10, 7);
                mainLight.castShadow = true;
                mainLight.shadow.mapSize.width = 2048;
                mainLight.shadow.mapSize.height = 2048;
                mainLight.shadow.camera.near = 0.5;
                mainLight.shadow.camera.far = 50;
                scene.add(mainLight);

                // Fill light from opposite side
                const fillLight = new THREE.DirectionalLight(0x9090ff, 0.4);
                fillLight.position.set(-5, 3, -5);
                scene.add(fillLight);

                // Rim light for edge highlighting
                const rimLight = new THREE.DirectionalLight(0xffd700, 0.3);
                rimLight.position.set(0, -5, -10);
                scene.add(rimLight);

                // Top light
                const topLight = new THREE.DirectionalLight(0xffffff, 0.3);
                topLight.position.set(0, 10, 0);
                scene.add(topLight);

                // Hemisphere light for natural sky/ground lighting
                const hemiLight = new THREE.HemisphereLight(0x87ceeb, 0x3d2817, 0.3);
                scene.add(hemiLight);

                // Add a subtle ground plane
                const groundGeometry = new THREE.CircleGeometry(5, 64);
                const groundMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1a1a2e,
                    roughness: 0.8,
                    metalness: 0.2,
                    transparent: true,
                    opacity: 0.5
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -1.5;
                ground.receiveShadow = true;
                scene.add(ground);

                // Load 3D model (GLB or PLY)
                try {
                    if (isGLB) {
                        // Load GLB file using GLTFLoader
                        if (typeof THREE.GLTFLoader === 'undefined') {
                            setError('GLTFLoader is not available. Please ensure Three.js GLTFLoader is loaded.');
                            setLoading(false);
                            return;
                        }
                        
                        const loader = new THREE.GLTFLoader();
                        loader.load(
                            modelFileUrl,
                            (gltf) => {
                                try {
                                    const model = gltf.scene;
                                    
                                    // Enable shadows on all meshes
                                    model.traverse((child) => {
                                        if (child.isMesh) {
                                            child.castShadow = true;
                                            child.receiveShadow = true;
                                        }
                                    });
                                    
                                    // Center and scale the model
                                    const box = new THREE.Box3().setFromObject(model);
                                    const center = box.getCenter(new THREE.Vector3());
                                    model.position.sub(center);
                                    
                                    const size = box.getSize(new THREE.Vector3());
                                    const maxDim = Math.max(size.x, size.y, size.z);
                                    const scale = 2.5 / maxDim;
                                    model.scale.multiplyScalar(scale);
                                    model.position.y = 0;
                                    
                                    scene.add(model);
                                    modelRef.current = model;
                                    setLoading(false);
                                } catch (err) {
                                    console.error('Error processing GLB model:', err);
                                    setError('Failed to process 3D model. Please check if the GLB file is valid.');
                                    setLoading(false);
                                }
                            },
                            (progress) => {
                                if (progress.lengthComputable) {
                                    const percentComplete = (progress.loaded / progress.total) * 100;
                                    console.log('Loading GLB:', percentComplete.toFixed(2) + '%');
                                }
                            },
                            (err) => {
                                console.error('Error loading GLB file:', err);
                                setError('Failed to load 3D model. Please check if the GLB file is valid.');
                                setLoading(false);
                            }
                        );
                    } else {
                        // Load PLY file using PLYLoader
                        if (typeof THREE.PLYLoader === 'undefined') {
                            setError('PLYLoader is not available. Please ensure Three.js PLYLoader is loaded.');
                            setLoading(false);
                            return;
                        }
                        
                        const loader = new THREE.PLYLoader();
                        loader.load(
                            modelFileUrl,
                            (geometry) => {
                                try {
                                    geometry.computeVertexNormals();
                                    
                                    // Check if geometry has vertex colors
                                    const hasVertexColors = geometry.hasAttribute('color');
                                    
                                    // Create high-quality material
                                    const material = new THREE.MeshStandardMaterial({ 
                                        vertexColors: hasVertexColors,
                                        color: hasVertexColors ? 0xffffff : 0xd4af37, // Gold color for monuments
                                        roughness: 0.4,
                                        metalness: 0.3,
                                        flatShading: false,
                                        side: THREE.DoubleSide
                                    });
                                    
                                    const mesh = new THREE.Mesh(geometry, material);
                                    mesh.castShadow = true;
                                    mesh.receiveShadow = true;
                                    
                                    // Center and scale the model
                                    geometry.center();
                                    const box = new THREE.Box3().setFromObject(mesh);
                                    const size = box.getSize(new THREE.Vector3());
                                    const maxDim = Math.max(size.x, size.y, size.z);
                                    const scale = 2.5 / maxDim;
                                    mesh.scale.multiplyScalar(scale);
                                    mesh.position.y = 0;
                                    
                                    scene.add(mesh);
                                    modelRef.current = mesh;
                                    setLoading(false);
                                } catch (err) {
                                    console.error('Error processing PLY geometry:', err);
                                    setError('Failed to process 3D model. Please check if the PLY file is valid.');
                                    setLoading(false);
                                }
                            },
                            (progress) => {
                                if (progress.lengthComputable) {
                                    const percentComplete = (progress.loaded / progress.total) * 100;
                                    console.log('Loading PLY:', percentComplete.toFixed(2) + '%');
                                }
                            },
                            (err) => {
                                console.error('Error loading PLY file:', err);
                                setError('Failed to load 3D model. Please check if the PLY file URL is correct and accessible.');
                                setLoading(false);
                            }
                        );
                    }
                } catch (err) {
                    console.error('Error initializing model loader:', err);
                    setError('Failed to initialize 3D model loader. Please refresh the page.');
                    setLoading(false);
                }

                // Animation loop
                const animate = () => {
                    animationRef.current = requestAnimationFrame(animate);
                    if (controlsRef.current) {
                        controlsRef.current.update();
                    }
                    renderer.render(scene, camera);
                };
                animate();

                // Handle resize
                const handleResize = () => {
                    if (!containerRef.current) return;
                    camera.aspect = containerRef.current.clientWidth / containerRef.current.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(containerRef.current.clientWidth, containerRef.current.clientHeight);
                };
                window.addEventListener('resize', handleResize);

                // Cleanup
                return () => {
                    window.removeEventListener('resize', handleResize);
                    if (animationRef.current) {
                        cancelAnimationFrame(animationRef.current);
                    }
                    if (controlsRef.current) {
                        controlsRef.current.dispose();
                    }
                    if (rendererRef.current && containerRef.current) {
                        containerRef.current.removeChild(rendererRef.current.domElement);
                    }
                    rendererRef.current?.dispose();
                };
            }, [modelFileUrl, isGLB]);

            const toggleAutoRotate = () => {
                if (controlsRef.current) {
                    controlsRef.current.autoRotate = !controlsRef.current.autoRotate;
                    setAutoRotate(controlsRef.current.autoRotate);
                }
            };

            const resetCamera = () => {
                if (cameraRef.current && controlsRef.current) {
                    cameraRef.current.position.set(3, 2, 5);
                    controlsRef.current.reset();
                }
            };

            const handleARMode = () => {
                if (!navigator.xr) {
                    alert('AR is not supported on this device. Please use a device with ARCore (Android) or ARKit (iOS) support.');
                    return;
                }
                alert('AR mode requires WebXR support. Please use a compatible browser like Chrome on Android or Safari on iOS.');
            };

            // Show error state if no model file and not loading
            if (!modelFileUrl && !loading && error) {
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4">
                        <div className={`${darkMode ? 'bg-gray-900' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-4xl p-8 relative`}>
                            <button
                                className="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                                onClick={onClose}
                            >
                                âœ•
                            </button>
                            <div className="text-center py-12">
                                <h2 className={`text-2xl font-bold mb-4 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                    No 3D Model Available
                                </h2>
                                <p className={`${darkMode ? 'text-gray-400' : 'text-gray-600'} mb-4`}>
                                    A 3D model (PLY or GLB file) has not been uploaded for {location?.name || 'this location'} yet.
                                </p>
                                <p className={`text-sm ${darkMode ? 'text-gray-500' : 'text-gray-500'} mb-4`}>
                                    Please upload a PLY or GLB file through the Admin Panel for this location.
                                </p>
                                <div className="mt-4">
                                    <button
                                        onClick={() => window.location.href = 'admin-panel.html'}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg"
                                    >
                                        Go to Admin Panel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // If no model file URL at all, show message immediately
            if (!modelFileUrl && !loading) {
                setError('No 3D model file available');
            }

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4">
                    <div className={`${darkMode ? 'bg-gray-900' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-6xl h-[90vh] relative flex flex-col overflow-hidden`}>
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <div>
                                <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                                    ðŸ›ï¸ {location?.name || '3D Model'}
                                </h2>
                                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    Interactive 3D Model Viewer â€¢ Drag to rotate â€¢ Scroll to zoom
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={toggleAutoRotate}
                                    className={`px-3 py-2 rounded-lg font-semibold transition flex items-center gap-2 ${
                                        autoRotate 
                                            ? 'bg-green-600 hover:bg-green-700 text-white' 
                                            : 'bg-gray-600 hover:bg-gray-700 text-white'
                                    }`}
                                    title="Toggle Auto Rotate"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </button>
                                <button
                                    onClick={resetCamera}
                                    className="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition flex items-center gap-2"
                                    title="Reset View"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                                    </svg>
                                </button>
                                <button
                                    onClick={handleARMode}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition flex items-center gap-2"
                                >
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    AR
                                </button>
                                <button
                                    className="text-gray-400 hover:text-red-600 text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                                    onClick={onClose}
                                >
                                    âœ•
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex-1 relative" ref={containerRef}>
                            {loading && (
                                <div className="absolute inset-0 flex items-center justify-center bg-gradient-to-b from-gray-900 to-gray-800 z-10">
                                    <div className="text-center">
                                        <div className="relative w-20 h-20 mx-auto mb-4">
                                            <div className="absolute inset-0 border-4 border-blue-500/30 rounded-full"></div>
                                            <div className="absolute inset-0 border-4 border-transparent border-t-blue-500 rounded-full animate-spin"></div>
                                        </div>
                                        <p className="text-white text-lg font-medium">Loading 3D Model...</p>
                                        <p className="text-gray-400 text-sm mt-2">Please wait while we prepare the view</p>
                                    </div>
                                </div>
                            )}
                            {error && (
                                <div className="absolute inset-0 flex items-center justify-center bg-gray-800/80 z-10">
                                    <div className={`text-center p-8 ${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-xl max-w-md`}>
                                        <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                            </svg>
                                        </div>
                                        <p className="text-red-500 font-semibold text-lg mb-2">Loading Error</p>
                                        <p className="text-gray-400 mb-4">{error}</p>
                                        <button
                                            onClick={onClose}
                                            className="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="p-4 border-t border-gray-700 bg-gradient-to-r from-gray-800 to-gray-900">
                            <div className="flex items-center justify-center gap-6 text-sm">
                                <span className={`flex items-center gap-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    <span className="text-lg">ðŸ–±ï¸</span> Drag to rotate
                                </span>
                                <span className={`flex items-center gap-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    <span className="text-lg">ðŸ”</span> Scroll to zoom
                                </span>
                                <span className={`flex items-center gap-2 ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                                    <span className="text-lg">ðŸ“±</span> Pinch on mobile
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Home Page Component
        function HomePage({ darkMode, setCurrentPage }) {
            // No refs needed as sections are statically laid out
            const [showGuideModal, setShowGuideModal] = useState(false);
            const [showHotelsModal, setShowHotelsModal] = useState(false);
            const [showARViewer, setShowARViewer] = useState(false);
            const [selectedLocationForAR, setSelectedLocationForAR] = useState(null);
            const [selectedLocationType, setSelectedLocationType] = useState(null); // 'sacred', 'mountain', 'beach'
            const [selectedLocationForHotels, setSelectedLocationForHotels] = useState(null);
            const [adminLocations, setAdminLocations] = useState([]);
            
            useEffect(() => {
                loadAdminLocations();
                // Listen for storage changes from admin panel
                const handleStorageChange = () => {
                    loadAdminLocations();
                };
                window.addEventListener('storage', handleStorageChange);
                // Also check periodically for same-window updates
                const interval = setInterval(loadAdminLocations, 1000);
                return () => {
                    window.removeEventListener('storage', handleStorageChange);
                    clearInterval(interval);
                };
            }, []);
            
            const loadAdminLocations = () => {
                const saved = localStorage.getItem('adminLocations');
                if (saved) {
                    setAdminLocations(JSON.parse(saved));
                }
            };
            
            const getLocationData = (name, category) => {
                return adminLocations.find(loc => 
                    loc.name === name && loc.category === category
                ) || null;
            };

            // Get all locations for a category - uses admin locations if available (respects deletions)
            const getLocationsForCategory = (category) => {
                // If admin has configured locations, use ONLY those (this respects deletions)
                if (adminLocations && adminLocations.length > 0) {
                    return adminLocations.filter(loc => loc.category === category);
                }
                
                // Fallback to default locations only if no admin configuration exists
                const defaultLocations = {
                    'Monuments': [
    { id: 1, name: 'Taj Mahal', location: 'Agra, Uttar Pradesh', image: 'monuments images data/taj mahal agra.jpg', category: 'monuments' },
    { id: 2, name: 'Qutub Minar', location: 'Delhi', image: 'monuments images data/qutub minar delhi.jpg', category: 'monuments' },
    { id: 3, name: 'Red Fort', location: 'Delhi', image: 'monuments images data/red fort delhi.jpg', category: 'monuments' },
    { id: 4, name: 'Gateway of India', location: 'Mumbai, Maharashtra', image: 'monuments images data/gateway of india mumbai.jpg', category: 'monuments' },
    { id: 5, name: 'Charminar', location: 'Hyderabad, Telangana', image: 'monuments images data/charminar hyderabad.jpg', category: 'monuments' },
    { id: 6, name: 'Hawa Mahal', location: 'Jaipur, Rajasthan', image: 'monuments images data/hawa mahal jaipur.jpg', category: 'monuments' },
    { id: 7, name: 'Victoria Memorial', location: 'Kolkata, West Bengal', image: 'monuments images data/victoria memorial kolkata.jpg', category: 'monuments' },
    { id: 8, name: 'Sanchi Stupa', location: 'Sanchi, Madhya Pradesh', image: 'monuments images data/sanchi stupa mp.jpg', category: 'monuments' }
],

                    'mountain': [
                        { id: 9, name: 'Mount Kangchenjunga', location: 'Sikkim', height: '8,586m', image: 'mountain images data/kangchenjunga.jpeg', category: 'mountain' },
                        { id: 10, name: 'Nanda Devi', location: 'Uttarakhand', height: '7,816m', image: 'mountain images data/Nanda Devi.jpg', category: 'mountain' },
                        { id: 11, name: 'Dzukou Valley', location: 'Nagaland', height: '2,452m', image: 'mountain images data/Dzukou Valley.jpg', category: 'mountain' },
                        { id: 12, name: 'Nilgiri Hills', location: 'Tamil Nadu', image: 'mountain images data/Nilgiri Hills.jpg', category: 'mountain' }
                    ],
                    'sacred': [
                        { id: 13, name: 'Golden Temple', location: 'Amritsar, Punjab', image: 'religion images data/golden temple amritsar.jpeg', category: 'sacred' },
                        { id: 14, name: 'Kedarnath Temple', location: 'Uttarakhand', image: 'religion images data/kedarnath.jpg', category: 'sacred' },
                        { id: 15, name: 'Jagannath Temple', location: 'Puri, Odisha', image: 'religion images data/jagannath puri.jpg', category: 'sacred' },
                        { id: 16, name: 'Ajmer Sharif Dargah', location: 'Ajmer, Rajasthan', image: 'religion images data/sharif dargah ajmer.jpg', category: 'sacred' },
                        { id: 17, name: 'Shirdi Sai Baba Temple', location: 'Shirdi, Maharashtra', image: 'religion images data/shirdi.jpg', category: 'sacred' },
                        { id: 18, name: 'Kamakhya Temple', location: 'Guwahati, Assam', image: 'religion images data/kamakhya devi temple.jpg', category: 'sacred' },
                        { id: 19, name: 'St. John Church', location: 'McLeodganj, HP', image: 'religion images data/st john church McLeodGanj.jpg', category: 'sacred' },
                        { id: 20, name: 'Taj-ul-Masajid', location: 'Bhopal, MP', image: 'religion images data/Tajulmasajid bhopal.jpg', category: 'sacred' }
                    ],
                };

                return defaultLocations[category] || [];
            };
            
            const handleViewMap = (location) => {
                localStorage.setItem('selectedLocation', JSON.stringify(location));
                setCurrentPage('explore');
            };
            
            const handleViewAR = (location) => {
                // Get the latest admin data to ensure we have the plyFile
                const adminLoc = getLocationData(location.name, location.category);
                const locationWithPLY = adminLoc ? { ...location, ...adminLoc } : location;
                setSelectedLocationForAR(locationWithPLY);
                setShowARViewer(true);
            };

            const handleContactGuide = (location, locationType) => {
                const adminLoc = getLocationData(location.name, locationType);
                if (adminLoc && adminLoc.guideName) {
                    // Show guide info from admin data
                    setSelectedLocationType({
                        type: locationType,
                        guide: {
                            name: adminLoc.guideName,
                            phone: adminLoc.guidePhone,
                            email: adminLoc.guideEmail,
                            languages: adminLoc.guideLanguages,
                            experience: adminLoc.guideExperience
                        }
                    });
                } else {
                    setSelectedLocationType(locationType);
                }
                setShowGuideModal(true);
            };

            const handleViewHotels = (location) => {
                setSelectedLocationForHotels(location);
                setShowHotelsModal(true);
            };

            return (
                <div className="space-y-8 animate-fade-in">
                    {/* Hero Section */}
                    <div className="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl p-8 text-white">
                        <div className="max-w-2xl">
                            <h2 className="text-4xl font-bold mb-4">Discover Incredible India</h2>
                            <p className="text-xl mb-6 opacity-90">
                                Your AI-powered travel companion for authentic Indian experiences
                            </p>
                            <button 
                                onClick={() => setCurrentPage('planner')}
                                className="bg-white text-blue-600 hover:bg-blue-50 px-8 py-3 rounded-xl font-semibold transition-all transform hover:scale-105 shadow-lg"
                            >
                                Plan Your Trip âœ¨
                            </button>
                        </div>
                    </div>






                    

                    {/* Religious Places Section */}
                    <div className="space-y-6">
                        <h2 className="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                            <span className="text-4xl">ðŸ•‰ï¸</span> Sacred Destinations
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {getLocationsForCategory('sacred').map((place, idx) => {
                                const displayImage = place.image;
                                const isUpdated = place.updated || false || true;
                                
                                return (
                                    <div
                                        key={place.id || idx}
                                        className="bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition transform hover:-translate-y-1"
                                    >
                                        <div className="relative h-48">
                                            <img
                                                src={displayImage}
                                                alt={place.name}
                                                className="w-full h-full object-cover"
                                            />
                                            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                                                <h3 className="text-white text-lg font-semibold">
                                                    {place.name}
                                                </h3>
                                                <p className="text-white/80 text-sm">
                                                    {place.location}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="p-4 flex justify-between gap-3">
                                            {isUpdated && (
                                                <div className="relative group">
                                                    <button
                                                        onClick={() => handleViewMap(place)}
                                                        className="relative w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition overflow-hidden"
                                                    >
                                                        {/* ICON */}
                                                        <span className="group-hover:opacity-0 transition">
                                                            <svg
                                                                className="w-6 h-6"
                                                                fill="none"
                                                                stroke="currentColor"
                                                                viewBox="0 0 24 24"
                                                            >
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                                                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                                                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                                            </svg>
                                                        </span>

                                                        {/* TEXT */}
                                                        <span className="absolute text-[10px] font-semibold opacity-0 group-hover:opacity-100 transition">
                                                            View Map
                                                        </span>
                                                    </button>
                                                </div>
                                            )}

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleViewHotels(place)}
                                                    className="relative w-12 h-12 rounded-full bg-purple-600 hover:bg-purple-700 text-white flex items-center justify-center transition overflow-hidden"
                                                >
                                                    <span className="group-hover:opacity-0 transition">
                                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                                                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3" />
                                                        </svg>
                                                    </span>
                                                    <span className="absolute text-[10px] font-semibold opacity-0 group-hover:opacity-100 transition">
                                                        Hotels
                                                    </span>
                                                </button>
                                            </div>

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleViewAR(place)}
                                                    className="relative w-12 h-12 rounded-full bg-orange-600 hover:bg-orange-700 text-white flex items-center justify-center transition overflow-hidden"
                                                >
                                                    <span className="group-hover:opacity-0 transition">
                                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                                                                d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14" />
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                                                                d="M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                                        </svg>
                                                    </span>
                                                    <span className="absolute text-[10px] font-semibold opacity-0 group-hover:opacity-100 transition">
                                                        View AR
                                                    </span>
                                                </button>
                                            </div>

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleContactGuide(place, 'sacred')}
                                                    className="relative w-12 h-12 rounded-full bg-green-600 hover:bg-green-700 text-white flex items-center justify-center transition overflow-hidden"
                                                >
                                                    <span className="group-hover:opacity-0 transition">
                                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                                                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0z" />
                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}
                                                                d="M12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                                        </svg>
                                                    </span>
                                                    <span className="absolute text-[10px] font-semibold opacity-0 group-hover:opacity-100 transition">
                                                        Guide
                                                    </span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {/* Mountains Section */}
                    <div className="space-y-6">
                        <h2 className="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                            <span className="text-4xl">ðŸ”ï¸</span> Majestic Mountains
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {getLocationsForCategory('mountain').map((mountain, idx) => {
                                const displayImage = mountain.image;
                                const isUpdated = mountain.updated || false || true;
                                
                                return (
                                    <div
                                        key={mountain.id || idx}
                                        className="bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition transform hover:-translate-y-1"
                                    >
                                        <div className="relative h-48">
                                            <img
                                                src={displayImage}
                                                alt={mountain.name}
                                                className="w-full h-full object-cover"
                                            />
                                            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                                                <h3 className="text-white text-lg font-semibold">
                                                    {mountain.name}
                                                </h3>
                                                <p className="text-white/80 text-sm">
                                                    {mountain.location}
                                                </p>
                                                {mountain.height && (
                                                    <p className="text-white/80 text-sm">
                                                        Height: {mountain.height}
                                                    </p>
                                                )}
                                            </div>
                                        </div>

                                        {/* BUTTONS SECTION (ONLY THIS PART CHANGED) */}
                                        <div className="p-4 flex justify-between gap-3">
                                            {isUpdated && (
                                                <div className="relative group">
                                                    <button
                                                        onClick={() => handleViewMap(mountain)}
                                                        className="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition"
                                                    >
                                                        <svg
                                                            className="w-6 h-6"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            viewBox="0 0 24 24"
                                                        >
                                                            <path
                                                                strokeLinecap="round"
                                                                strokeLinejoin="round"
                                                                strokeWidth={2}
                                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                                            />
                                                            <path
                                                                strokeLinecap="round"
                                                                strokeLinejoin="round"
                                                                strokeWidth={2}
                                                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                                            />
                                                        </svg>
                                                    </button>
                                                </div>
                                            )}

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleViewHotels(mountain)}
                                                    className="w-12 h-12 rounded-full bg-purple-600 hover:bg-purple-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleViewAR(mountain)}
                                                    className="w-12 h-12 rounded-full bg-orange-600 hover:bg-orange-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14"
                                                        />
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleContactGuide(mountain, 'mountain')}
                                                    className="w-12 h-12 rounded-full bg-green-600 hover:bg-green-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"
                                                        />
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                );

                            })}
                        </div>
                    </div>


                    {/* Beaches Section */}
                    <div className="space-y-6">
                        <h2 className="text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3">
                            <span className="text-4xl">ðŸ–ï¸</span> Beautiful Beaches
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {getLocationsForCategory('beach').map((beach, idx) => {
                                const displayImage = beach.image;
                                const isUpdated = beach.updated || false || true;
                                
                                return (
                                    <div
                                        key={beach.id || idx}
                                        className="bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition transform hover:-translate-y-1"
                                    >
                                        <div className="relative h-48">
                                            <img
                                                src={displayImage}
                                                alt={beach.name}
                                                className="w-full h-full object-cover"
                                            />
                                            <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                                                <h3 className="text-white text-lg font-semibold">
                                                    {beach.name}
                                                </h3>
                                                <p className="text-white/80 text-sm">
                                                    {beach.location}
                                                </p>
                                            </div>
                                        </div>

                                        {/* BUTTONS SECTION (ONLY THIS PART CHANGED) */}
                                        <div className="p-4 flex justify-between gap-3">
                                            {isUpdated && (
                                                <div className="relative group">
                                                    <button
                                                        onClick={() => handleViewMap(beach)}
                                                        className="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition"
                                                    >
                                                        <svg
                                                            className="w-6 h-6"
                                                            fill="none"
                                                            stroke="currentColor"
                                                            viewBox="0 0 24 24"
                                                        >
                                                            <path
                                                                strokeLinecap="round"
                                                                strokeLinejoin="round"
                                                                strokeWidth={2}
                                                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                                            />
                                                            <path
                                                                strokeLinecap="round"
                                                                strokeLinejoin="round"
                                                                strokeWidth={2}
                                                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                                            />
                                                        </svg>
                                                    </button>
                                                </div>
                                            )}

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleViewHotels(beach)}
                                                    className="w-12 h-12 rounded-full bg-purple-600 hover:bg-purple-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleViewAR(beach)}
                                                    className="w-12 h-12 rounded-full bg-orange-600 hover:bg-orange-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14"
                                                        />
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleContactGuide(beach, 'beach')}
                                                    className="w-12 h-12 rounded-full bg-green-600 hover:bg-green-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"
                                                        />
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                );

                            })}
                        </div>
                    </div>








                    {/* Tourist Guide Profile Modal */}
                    {showGuideModal && (
                        <TouristGuideProfile 
                            locationType={selectedLocationType}
                            onClose={() => setShowGuideModal(false)}
                            darkMode={darkMode}
                        />
                    )}

                    {/* Hotels Modal */}
                    {showHotelsModal && (
                        <HotelsModal 
                            location={selectedLocationForHotels}
                            hotels={selectedLocationForHotels?.hotels || []}
                            onClose={() => setShowHotelsModal(false)}
                            darkMode={darkMode}
                        />
                    )}

                    {/* AR Viewer Modal */}
                    {showARViewer && (
                        <ARViewer 
                            location={selectedLocationForAR}
                            plyFileUrl={selectedLocationForAR?.plyFile || getLocationData(selectedLocationForAR?.name, selectedLocationForAR?.category)?.plyFile || null}
                            glbFileUrl={selectedLocationForAR?.glbFile || getLocationData(selectedLocationForAR?.name, selectedLocationForAR?.category)?.glbFile || null}
                            onClose={() => setShowARViewer(false)}
                            darkMode={darkMode}
                        />
                    )}

                    {/* Features Grid */}
                    <div className="grid grid-cols-1 gap-6">
                        {/* Sustainability */}
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 transform transition-all hover:scale-105 max-w-md mx-auto">
                            <div className="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center mb-4">
                                <svg className="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                            </div>
                            <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-2">Sustainable Travel</h3>
                            <p className="text-gray-600 dark:text-gray-300 mb-4">Eco-friendly travel recommendations and tips.</p>
                            <button onClick={() => setCurrentPage('sustainability')} className="text-green-600 dark:text-green-400 font-medium hover:underline">
                                Learn More â†’
                            </button>
                        </div>
                    </div>                    {/* Hidden Gems Section */}
                    <div className="mt-8">
                        <h2 className="text-3xl font-bold mb-8 text-gray-900 dark:text-white text-center">
                            Hidden Treasures of India
                        </h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            {[
                                { name: 'Hampi Caves', location: 'Hampi, Karnataka', desc: 'Ancient ruins & boulders', img: 'https://images.unsplash.com/photo-1599661046289-e31897846e41?w=400' },
                                { name: 'Ziro Valley', location: 'Ziro, Arunachal Pradesh', desc: 'Pine hills & Apatani culture', img: 'ziro.png' },
                                { name: 'Orchha', location: 'Orchha, Madhya Pradesh', desc: 'Medieval palaces', img: 'https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=400' },
                                { name: 'Majuli Island', location: 'Majuli, Assam', desc: 'World\'s largest river island', img: 'image.png' }
                            ].map((gem, idx) => (
                                <div key={idx} className="bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                                    <div className="relative h-48">
                                        <img 
                                            src={gem.img} 
                                            alt={gem.name}
                                            className="w-full h-full object-cover"
                                        />
                                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                                            <h3 className="text-white text-lg font-semibold">{gem.name}</h3>
                                            <p className="text-white/80 text-sm">{gem.location}</p>
                                        </div>
                                    </div>
                                    <div className="p-4">
                                        <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                                            {gem.desc}
                                        </p>

                                        <div className="flex gap-4">
                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleViewMap(gem)}
                                                    className="w-12 h-12 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                                                        />
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>

                                            <div className="relative group">
                                                <button
                                                    onClick={() => handleContactGuide('hidden')}
                                                    className="w-12 h-12 rounded-full bg-green-600 hover:bg-green-700 text-white flex items-center justify-center transition"
                                                >
                                                    <svg
                                                        className="w-6 h-6"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                    >
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"
                                                        />
                                                        <path
                                                            strokeLinecap="round"
                                                            strokeLinejoin="round"
                                                            strokeWidth={2}
                                                            d="M12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                                        />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            ))}
                        </div>
                    </div>


                </div>
            );
        }



        // Explore Page with Advanced Weather Map
        // Helper function to get coordinates for locations
        function getLocationCoordinates(locationName) {
            // This would ideally come from an API or database
            const coordinates = {
                // Religious Places
                'Golden Temple': [31.6200, 74.8765],
                'Kedarnath Temple': [30.7346, 79.0669],
                'Jagannath Temple': [19.8050, 85.8179],
                'Ajmer Sharif Dargah': [26.4519, 74.6283],
                'Shirdi Sai Baba Temple': [19.7645, 74.4762],
                'Kamakhya Temple': [26.1664, 91.7027],
                'St. John Church': [32.2432, 76.3232],
                'Taj-ul-Masajid': [23.2599, 77.4126],
                // Mountains
                'Mount Kangchenjunga': [27.7025, 88.1475],
                'Nanda Devi': [30.3758, 79.9714],
                'Mount Kamet': [30.9198, 79.5933],
                'Anamudi Peak': [10.1722, 77.0389],
                'Dzukou Valley': [25.5619, 94.0719],
                'Stok Kangri': [33.9983, 77.4862],
                'Aravalli Range': [25.6486, 73.7169],
                'Nilgiri Hills': [11.4064, 76.6932],
                // Beaches
                'Radhanagar Beach': [11.9809, 92.9526],
                'Palolem Beach': [15.0100, 74.0232],
                'Varkala Beach': [8.7370, 76.7080],
                'Marina Beach': [13.0500, 80.2824],
                'Agonda Beach': [15.0445, 73.9853],
                'Om Beach': [14.5197, 74.3217],
                // Add more coordinates as needed
            };
            return coordinates[locationName] || [20.5937, 78.9629]; // Default to center of India if not found
        }

        function ExplorePage({ setCurrentPage }) {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const baseTileLayer = useRef(null);
            const weatherLayer = useRef(null);
            const markersLayer = useRef(null);
            const [selectedLocation, setSelectedLocation] = useState(null);
            const locationProcessedRef = useRef(false);

            // Function to check and update location from localStorage
            const checkAndUpdateLocation = () => {
                const savedLocation = localStorage.getItem('selectedLocation');
                if (savedLocation) {
                    try {
                        const locationData = JSON.parse(savedLocation);
                        setSelectedLocation(locationData);
                        locationProcessedRef.current = true;
                    } catch (e) {
                        console.error('Error parsing location:', e);
                    }
                }
            };

            useEffect(() => {
                // Initial check for selected location from localStorage
                checkAndUpdateLocation();
                
                // Listen for navigation events to re-check localStorage
                const handleNavigateToExplore = () => {
                    // Reset the processed flag to allow re-processing
                    locationProcessedRef.current = false;
                    // Small delay to ensure localStorage is set before checking
                    setTimeout(() => {
                        checkAndUpdateLocation();
                    }, 100);
                };
                
                // Listen for storage changes (if localStorage is modified)
                const handleStorageChange = (e) => {
                    if (e.key === 'selectedLocation' && e.newValue) {
                        locationProcessedRef.current = false;
                        checkAndUpdateLocation();
                    }
                };
                
                window.addEventListener('navigateToExplore', handleNavigateToExplore);
                window.addEventListener('storage', handleStorageChange);
                
                // Also check periodically when on explore page (fallback)
                const intervalId = setInterval(() => {
                    const savedLocation = localStorage.getItem('selectedLocation');
                    if (savedLocation && !locationProcessedRef.current) {
                        checkAndUpdateLocation();
                    }
                }, 500);
                
                return () => {
                    window.removeEventListener('navigateToExplore', handleNavigateToExplore);
                    window.removeEventListener('storage', handleStorageChange);
                    clearInterval(intervalId);
                };
            }, []);
            
            // Update map when selectedLocation changes
            useEffect(() => {
                if (selectedLocation) {
                    // Wait for map to be initialized
                    const updateMapLocation = () => {
                        if (!mapInstance.current) {
                            // Map not ready yet, wait a bit and retry
                            setTimeout(updateMapLocation, 100);
                            return;
                        }
                        
                        const locationName = selectedLocation.name || selectedLocation;
                        const coords = getLocationCoordinates(locationName);
                        
                        // Clear existing markers
                        if (markersLayer.current) {
                            markersLayer.current.clearLayers();
                        }
                        
                        // Pan to new location
                        mapInstance.current.setView(coords, 12);
                        
                        // Add marker
                        L.marker(coords)
                            .addTo(markersLayer.current)
                            .bindPopup(`ðŸ“ ${locationName}`)
                            .openPopup();
                        
                        // Fetch weather data for new location (check if function exists)
                        if (typeof fetchWeatherData === 'function') {
                            fetchWeatherData(coords[0], coords[1]);
                        } else {
                            // If fetchWeatherData not ready yet, wait a bit
                            setTimeout(() => {
                                if (typeof fetchWeatherData === 'function') {
                                    fetchWeatherData(coords[0], coords[1]);
                                }
                            }, 200);
                        }
                        
                        // Clear the location after processing
                        localStorage.removeItem('selectedLocation');
                        locationProcessedRef.current = false;
                    };
                    
                    updateMapLocation();
                }
            }, [selectedLocation]);
            
            const [searchTerm, setSearchTerm] = useState('');
            const [latitude, setLatitude] = useState('');
            const [longitude, setLongitude] = useState('');
            const [loading, setLoading] = useState(false);
            const [activeWeatherLayer, setActiveWeatherLayer] = useState('temp_new');
            const [activeMapStyle, setActiveMapStyle] = useState('satellite');
            const [currentLocation, setCurrentLocation] = useState({ lat: 28.6139, lng: 77.2090 });
            const [weatherData, setWeatherData] = useState(null);
            const [aiRecommendations, setAiRecommendations] = useState(null);
            const [analyzingWeather, setAnalyzingWeather] = useState(false);
            const [structuredRecommendations, setStructuredRecommendations] = useState(null);
            
            // OpenWeatherMap API key from your config
            const WEATHER_API_KEY = '84254d5ce02335eb1d0ed7c9393e2ebb';
            
            // Initialize map
            useEffect(() => {
                if (!mapInstance.current && mapRef.current) {
                    // Get coordinates based on selected location or default to user's location
                    let locationName = null;
                    if (selectedLocation) {
                        locationName = selectedLocation.name || selectedLocation;
                    }
                    let initialCoords = locationName 
                        ? getLocationCoordinates(locationName)
                        : [currentLocation.lat, currentLocation.lng];

                    // Create map
                    mapInstance.current = L.map(mapRef.current, {
                        center: initialCoords,
                        zoom: locationName ? 12 : 6,
                        zoomControl: true
                    });
                    
                    // Create markers layer group
                    markersLayer.current = L.layerGroup().addTo(mapInstance.current);
                    
                    // Initialize with satellite view
                    changeMapStyle('satellite');
                    changeWeatherLayer('temp_new');
                    
                    // Add marker for selected location or current location
                    if (locationName) {
                        L.marker(initialCoords)
                            .addTo(markersLayer.current)
                            .bindPopup(`ðŸ“ ${locationName}`)
                            .openPopup();
                    } else {
                        L.marker(initialCoords)
                            .addTo(markersLayer.current)
                            .bindPopup('ðŸ“ Current Location')
                            .openPopup();
                    }
                    
                    // Fetch weather data
                    fetchWeatherData(initialCoords[0], initialCoords[1]);
                }
            }, []);
            
            // Fetch weather data for location
            const fetchWeatherData = async (lat, lng) => {
                try {
                    const res = await fetch(`${API_BASE}/weather/Location?lat=${lat}&lon=${lng}`);
                    const data = await res.json();
                    if (data.success) {
                        setWeatherData(data.current);
                        // Auto-analyze after getting weather data
                        analyzeLocationWithAI(data.current);
                    }
                } catch (err) {
                    console.error('Weather fetch error:', err);
                }
            };
            
            // AI Analysis of current map view
            const analyzeLocationWithAI = async (weather) => {
                if (!weather) return;
                
                setAnalyzingWeather(true);
                
                try {
                    const analysisPrompt = `Analyze this location for travel planning and provide structured output:

Location: ${weather.name}
Current Weather:
- Temperature: ${weather.main.temp}Â°C
- Condition: ${weather.weather[0].description}
- Humidity: ${weather.main.humidity}%
- Wind: ${weather.wind.speed} m/s
- Visibility: ${weather.visibility/1000} km

Provide output in this EXACT format (use these section headers):
BEST_TIME: [specific hours e.g., "6-9 AM and 5-7 PM"]
CROWD_LEVEL: [Low/Moderate/High with brief reason]
ACTIVITIES: [3-4 activities, one per line with time if relevant]
TRANSPORT: [2-3 transport suggestions, one per line]
WEAR_BRING: [3-4 items, one per line]
SAFETY_TIPS: [1-3 tips if any, one per line, or "None" if safe]
WEATHER_INSIGHT: [1-2 sentence summary about weather impact]

Keep each section concise. Use bullet format for lists.`;

                    const res = await fetch(`${API_BASE}/chatbot`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: analysisPrompt,
                            language: 'en'
                        })
                    });
                    
                    const data = await res.json();
                    const reply = data.reply || data.fallbackReply || '';
                    
                    // Parse structured response
                    const parsed = {
                        bestTime: extractSection(reply, 'BEST_TIME'),
                        crowdLevel: extractSection(reply, 'CROWD_LEVEL'),
                        activities: extractListSection(reply, 'ACTIVITIES'),
                        transport: extractListSection(reply, 'TRANSPORT'),
                        wearBring: extractListSection(reply, 'WEAR_BRING'),
                        safetyTips: extractListSection(reply, 'SAFETY_TIPS'),
                        weatherInsight: extractSection(reply, 'WEATHER_INSIGHT'),
                        raw: reply
                    };
                    
                    setStructuredRecommendations(parsed);
                    setAiRecommendations(reply);
                } catch (err) {
                    console.error('AI analysis error:', err);
                } finally {
                    setAnalyzingWeather(false);
                }
            };
            
            // Helper function to extract section from AI response
            const extractSection = (text, sectionName) => {
                const regex = new RegExp(`${sectionName}:\\s*([^\\n]+(?:\\n(?!\\w+_?:)[^\\n]+)*)`, 'i');
                const match = text.match(regex);
                return match ? match[1].trim().replace(/^[-â€¢]\s*/, '') : null;
            };
            
            // Helper function to extract list section
            const extractListSection = (text, sectionName) => {
                const regex = new RegExp(`${sectionName}:\\s*([^\\n]+(?:\\n(?!\\w+_?:)[^\\n]+)*)`, 'i');
                const match = text.match(regex);
                if (!match) return [];
                
                const content = match[1].trim();
                // Split by newlines and clean up
                return content.split('\n')
                    .map(line => line.trim().replace(/^[-â€¢*]\s*/, ''))
                    .filter(line => line.length > 0);
            };
            
            // Change map base style
            const changeMapStyle = (style) => {
                if (!mapInstance.current) return;
                
                // Remove existing base layer
                if (baseTileLayer.current) {
                    mapInstance.current.removeLayer(baseTileLayer.current);
                }
                
                let tileUrl, options;
                
                switch(style) {
                    case 'satellite':
                        tileUrl = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                        options = { attribution: 'Â© Esri', maxZoom: 18 };
                        break;
                    case 'dark':
                        tileUrl = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                        options = { attribution: 'Â© CARTO', maxZoom: 19 };
                        break;
                    case 'terrain':
                        tileUrl = 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
                        options = { attribution: 'Â© OpenTopoMap', maxZoom: 17 };
                        break;
                    default:
                        tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                        options = { attribution: 'Â© OpenStreetMap', maxZoom: 19 };
                }
                
                baseTileLayer.current = L.tileLayer(tileUrl, options).addTo(mapInstance.current);
                setActiveMapStyle(style);
            };
            
            // Change weather layer
            const changeWeatherLayer = (layer) => {
                if (!mapInstance.current) return;
                
                // Remove existing weather layer
                if (weatherLayer.current) {
                    mapInstance.current.removeLayer(weatherLayer.current);
                }
                
                // Add new weather layer
                if (layer !== 'none') {
                    weatherLayer.current = L.tileLayer(
                        `https://tile.openweathermap.org/map/${layer}/{z}/{x}/{y}.png?appid=${WEATHER_API_KEY}`,
                        {
                            attribution: 'Â© OpenWeatherMap',
                            opacity: 0.6,
                            maxZoom: 19
                        }
                    ).addTo(mapInstance.current);
                }
                
                setActiveWeatherLayer(layer);
            };
            
            // Get user's live location
            const getLiveLocation = () => {
                if (navigator.geolocation) {
                    setLoading(true);
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            setCurrentLocation({ lat, lng });
                            
                            if (mapInstance.current) {
                                mapInstance.current.setView([lat, lng], 13);
                                markersLayer.current.clearLayers();
                                L.marker([lat, lng])
                                    .addTo(markersLayer.current)
                                    .bindPopup('ðŸ“ Your Live Location')
                                    .openPopup();
                                
                                fetchWeatherData(lat, lng);
                            }
                            setLoading(false);
                        },
                        (error) => {
                            alert('Unable to get location: ' + error.message);
                            setLoading(false);
                        }
                    );
                } else {
                    alert('Geolocation is not supported by your browser');
                }
            };
            
            // Search location
            const searchLocation = async () => {
                // Check if coordinates are provided
                if (latitude && longitude) {
                    const lat = parseFloat(latitude);
                    const lng = parseFloat(longitude);
                    
                    // Validate coordinates
                    if (isNaN(lat) || isNaN(lng)) {
                        alert('Please enter valid latitude and longitude values');
                        return;
                    }
                    
                    if (lat < -90 || lat > 90) {
                        alert('Latitude must be between -90 and 90');
                        return;
                    }
                    
                    if (lng < -180 || lng > 180) {
                        alert('Longitude must be between -180 and 180');
                        return;
                    }
                    
                    setLoading(true);
                    
                    try {
                        if (mapInstance.current) {
                            setCurrentLocation({ lat, lng });
                            mapInstance.current.setView([lat, lng], 10);
                            
                            markersLayer.current.clearLayers();
                            L.marker([lat, lng])
                                .addTo(markersLayer.current)
                                .bindPopup(`ðŸ“ ${lat.toFixed(6)}, ${lng.toFixed(6)}`)
                                .openPopup();
                            
                            fetchWeatherData(lat, lng);
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error searching location');
                    } finally {
                        setLoading(false);
                    }
                    return;
                }
                
                // Otherwise, search by location name
                if (!searchTerm) return;
                setLoading(true);
                
                try {
                    const res = await fetch(`${API_BASE}/geocode/${encodeURIComponent(searchTerm)}`);
                    const data = await res.json();
                    
                    if (data.success && mapInstance.current) {
                        const { lat, lng } = data.location;
                        setCurrentLocation({ lat, lng });
                        mapInstance.current.setView([lat, lng], 10);
                        
                        markersLayer.current.clearLayers();
                        L.marker([lat, lng])
                            .addTo(markersLayer.current)
                            .bindPopup(`ðŸ“ ${data.formatted_address}`)
                            .openPopup();
                        
                        fetchWeatherData(lat, lng);
                    } else {
                        alert('Location not found');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error searching location');
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="space-y-4 animate-fade-in">
                    <h2 className="text-3xl font-bold dark:text-white">Weather Intelligence Map</h2>
                    
                    {/* Search Bar */}
                    <div className="space-y-2">
                        <div className="flex gap-2">
                            <input
                                type="text"
                                placeholder="Search location..."
                                value={searchTerm}
                                onChange={(e) => {
                                    setSearchTerm(e.target.value);
                                    // Clear coordinates when typing location name
                                    setLatitude('');
                                    setLongitude('');
                                }}
                                onKeyPress={(e) => e.key === 'Enter' && searchLocation()}
                                className="flex-1 px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                            />
                            <button
                                onClick={searchLocation}
                                disabled={loading}
                                className="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 transition"
                            >
                                {loading ? 'ðŸ” Searching...' : 'ðŸ” Search'}
                            </button>
                            <button
                                onClick={getLiveLocation}
                                className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                            >
                                ðŸ“ My Location
                            </button>
                            <button
                                onClick={() => {
                                    // Save current location to localStorage for weather prediction page
                                    if (currentLocation.lat && currentLocation.lng) {
                                        localStorage.setItem('weatherPredictionLocation', JSON.stringify({
                                            lat: currentLocation.lat,
                                            lng: currentLocation.lng,
                                            name: weatherData?.name || searchTerm || 'Selected Location'
                                        }));
                                    }
                                    window.location.href = 'weather-prediction.html';
                                }}
                                className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition shadow-lg"
                            >
                                ðŸŒ§ï¸ Will it rain on my parade?
                            </button>
                        </div>
                        {/* Latitude and Longitude Inputs */}
                        <div className="flex gap-2 items-center">
                            <span className="text-sm font-semibold text-gray-600 dark:text-gray-300 whitespace-nowrap">Or use coordinates:</span>
                            <input
                                type="number"
                                placeholder="Latitude (-90 to 90)"
                                value={latitude}
                                onChange={(e) => {
                                    setLatitude(e.target.value);
                                    // Clear location name when typing coordinates
                                    setSearchTerm('');
                                }}
                                onKeyPress={(e) => e.key === 'Enter' && searchLocation()}
                                step="any"
                                className="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                            />
                            <input
                                type="number"
                                placeholder="Longitude (-180 to 180)"
                                value={longitude}
                                onChange={(e) => {
                                    setLongitude(e.target.value);
                                    // Clear location name when typing coordinates
                                    setSearchTerm('');
                                }}
                                onKeyPress={(e) => e.key === 'Enter' && searchLocation()}
                                step="any"
                                className="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
                            />
                        </div>
                    </div>
                    
                    {/* Weather Info Card */}
                    {weatherData && (
                        <div className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl p-6 shadow-lg">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h3 className="text-2xl font-bold">{weatherData.name}</h3>
                                    <p className="text-4xl font-bold my-2">{Math.round(weatherData.main.temp)}Â°C</p>
                                    <p className="text-lg capitalize">{weatherData.weather[0].description}</p>
                                </div>
                                <div className="text-right space-y-2">
                                    <p>ðŸ’¨ Wind: {weatherData.wind.speed} m/s</p>
                                    <p>ðŸ’§ Humidity: {weatherData.main.humidity}%</p>
                                    <p>ðŸŒ¡ï¸ Feels like: {Math.round(weatherData.main.feels_like)}Â°C</p>
                                    <p>ðŸ‘ï¸ Visibility: {(weatherData.visibility / 1000).toFixed(1)} km</p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Control Buttons Above Map */}
                    <div className="flex gap-2 mb-3 flex-wrap">
                        <div className="flex gap-2">
                            <span className="text-sm font-semibold text-gray-600 dark:text-gray-300 flex items-center">Weather:</span>
                            {[
                                { id: 'temp_new', label: 'ðŸŒ¡ï¸', tooltip: 'Temperature' },
                                { id: 'wind_new', label: 'ðŸ’¨', tooltip: 'Wind' },
                                { id: 'precipitation_new', label: 'ðŸ’§', tooltip: 'Rain' },
                                { id: 'clouds_new', label: 'â˜ï¸', tooltip: 'Clouds' },
                                { id: 'pressure_new', label: 'ðŸŒŠ', tooltip: 'Pressure' }
                            ].map(layer => (
                                <button
                                    key={layer.id}
                                    onClick={() => changeWeatherLayer(layer.id)}
                                    title={layer.tooltip}
                                    className={`px-3 py-2 rounded-lg text-lg font-medium transition ${
                                        activeWeatherLayer === layer.id
                                            ? 'bg-red-500 text-white shadow-lg ring-2 ring-red-300'
                                            : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 shadow'
                                    }`}
                                >
                                    {layer.label}
                                </button>
                            ))}
                            <button
                                onClick={() => changeWeatherLayer('none')}
                                title="No Weather Layer"
                                className={`px-3 py-2 rounded-lg text-sm font-medium transition ${
                                    activeWeatherLayer === 'none'
                                        ? 'bg-gray-800 text-white shadow-lg'
                                        : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 shadow'
                                }`}
                            >
                                ðŸš«
                            </button>
                        </div>
                        
                        <div className="flex gap-2 ml-auto">
                            <span className="text-sm font-semibold text-gray-600 dark:text-gray-300 flex items-center">Map:</span>
                            {[
                                { id: 'satellite', label: 'ðŸ›°ï¸', tooltip: 'Satellite' },
                                { id: 'dark', label: 'ðŸŒ™', tooltip: 'Dark' },
                                { id: 'terrain', label: 'ðŸ”ï¸', tooltip: 'Terrain' },
                                { id: 'default', label: 'ðŸ—ºï¸', tooltip: 'Default' }
                            ].map(style => (
                                <button
                                    key={style.id}
                                    onClick={() => changeMapStyle(style.id)}
                                    title={style.tooltip}
                                    className={`px-3 py-2 rounded-lg text-lg font-medium transition ${
                                        activeMapStyle === style.id
                                            ? 'bg-blue-500 text-white shadow-lg ring-2 ring-blue-300'
                                            : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-600 shadow'
                                    }`}
                                >
                                    {style.label}
                                </button>
                            ))}
                        </div>
                    </div>
                    
                    {/* Map Container */}
                    <div className="relative">
                        <div ref={mapRef} className="leaflet-container shadow-lg" style={{height: '600px'}}></div>
                        
                        {/* Compact Legend - Bottom Right */}
                        {activeWeatherLayer !== 'none' && (
                            <div className="absolute bottom-4 right-4 z-[1000] bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-lg shadow-lg px-3 py-2">
                                <p className="text-xs font-semibold text-gray-700 dark:text-gray-300">
                                    {activeWeatherLayer === 'temp_new' && 'ðŸŒ¡ï¸ Temp'}
                                    {activeWeatherLayer === 'wind_new' && 'ðŸ’¨ Wind'}
                                    {activeWeatherLayer === 'precipitation_new' && 'ðŸ’§ Rain'}
                                    {activeWeatherLayer === 'clouds_new' && 'â˜ï¸ Clouds'}
                                    {activeWeatherLayer === 'pressure_new' && 'ðŸŒŠ Pressure'}
                                    : Low â†’ High
                                </p>
                            </div>
                        )}
                    </div>
                    
                    {/* AI Smart Recommendations Bot - Structured UI */}
                    {(aiRecommendations || structuredRecommendations) && (
                        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                            {/* Header */}
                            <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white p-5">
                                <div className="flex items-start justify-between">
                                    <div>
                                        <h3 className="text-2xl font-bold flex items-center gap-2 mb-1">
                                            <span className="text-3xl">ðŸ¤–</span>
                                            <span>AI Context Awareness and insights</span>
                                        </h3>
                                        {weatherData && (
                                            <p className="text-indigo-100 text-sm mt-1">
                                                Analyzing {weatherData.name} â€¢ {weatherData.main.temp}Â°C â€¢ {weatherData.weather[0].description}
                                            </p>
                                        )}
                                    </div>
                                    <button
                                        onClick={() => {
                                            setAiRecommendations(null);
                                            setStructuredRecommendations(null);
                                        }}
                                        className="text-white/80 hover:text-white text-2xl transition hover:rotate-90"
                                    >
                                        âœ•
                                    </button>
                                </div>
                            </div>

                            {analyzingWeather ? (
                                <div className="p-8 flex flex-col items-center justify-center gap-4">
                                    <div className="animate-spin text-4xl">âš™ï¸</div>
                                    <p className="text-gray-600 dark:text-gray-400 font-medium">Analyzing weather patterns and travel conditions...</p>
                                    <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                                        <div className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 animate-pulse" style={{width: '70%'}}></div>
                                    </div>
                                </div>
                            ) : structuredRecommendations ? (
                                <div className="p-5 space-y-4">
                                    {/* Weather Insight Banner */}
                                    {structuredRecommendations.weatherInsight && (
                                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-blue-900/20 dark:to-cyan-900/20 border-l-4 border-blue-500 p-4 rounded-r-lg">
                                            <div className="flex items-start gap-3">
                                                <span className="text-2xl">ðŸŒ¤ï¸</span>
                                                <div>
                                                    <h4 className="font-semibold text-gray-900 dark:text-white mb-1">Weather Insight</h4>
                                                    <p className="text-sm text-gray-700 dark:text-gray-300">{structuredRecommendations.weatherInsight}</p>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Grid of Recommendation Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {/* Best Time Card */}
                                        {structuredRecommendations.bestTime && (
                                            <div className="bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4 hover:shadow-lg transition">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className="text-3xl">â°</span>
                                                    <h4 className="font-bold text-gray-900 dark:text-white">Best Time to Visit</h4>
                                                </div>
                                                <p className="text-gray-700 dark:text-gray-300 font-medium">{structuredRecommendations.bestTime}</p>
                                            </div>
                                        )}

                                        {/* Crowd Level Card */}
                                        {structuredRecommendations.crowdLevel && (
                                            <div className="bg-gradient-to-br from-pink-50 to-rose-50 dark:from-pink-900/20 dark:to-rose-900/20 border border-pink-200 dark:border-pink-800 rounded-xl p-4 hover:shadow-lg transition">
                                                <div className="flex items-center gap-3 mb-2">
                                                    <span className="text-3xl">ðŸ‘¥</span>
                                                    <h4 className="font-bold text-gray-900 dark:text-white">Crowd Prediction</h4>
                                                </div>
                                                <p className="text-gray-700 dark:text-gray-300 font-medium">{structuredRecommendations.crowdLevel}</p>
                                            </div>
                                        )}

                                        {/* Activities Card */}
                                        {structuredRecommendations.activities && structuredRecommendations.activities.length > 0 && (
                                            <div className="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-200 dark:border-green-800 rounded-xl p-4 hover:shadow-lg transition">
                                                <div className="flex items-center gap-3 mb-3">
                                                    <span className="text-3xl">ðŸŽ¯</span>
                                                    <h4 className="font-bold text-gray-900 dark:text-white">Recommended Activities</h4>
                                                </div>
                                                <ul className="space-y-2">
                                                    {structuredRecommendations.activities.map((activity, idx) => (
                                                        <li key={idx} className="flex items-start gap-2 text-sm text-gray-700 dark:text-gray-300">
                                                            <span className="text-green-600 dark:text-green-400 mt-1">â–¸</span>
                                                            <span>{activity}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {/* Transport Card */}
                                        {structuredRecommendations.transport && structuredRecommendations.transport.length > 0 && (
                                            <div className="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-4 hover:shadow-lg transition">
                                                <div className="flex items-center gap-3 mb-3">
                                                    <span className="text-3xl">ðŸš‡</span>
                                                    <h4 className="font-bold text-gray-900 dark:text-white">Transport Suggestions</h4>
                                                </div>
                                                <ul className="space-y-2">
                                                    {structuredRecommendations.transport.map((transport, idx) => (
                                                        <li key={idx} className="flex items-start gap-2 text-sm text-gray-700 dark:text-gray-300">
                                                            <span className="text-blue-600 dark:text-blue-400 mt-1">â–¸</span>
                                                            <span>{transport}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {/* What to Wear/Bring Card */}
                                        {structuredRecommendations.wearBring && structuredRecommendations.wearBring.length > 0 && (
                                            <div className="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 border border-purple-200 dark:border-purple-800 rounded-xl p-4 hover:shadow-lg transition">
                                                <div className="flex items-center gap-3 mb-3">
                                                    <span className="text-3xl">ðŸ‘”</span>
                                                    <h4 className="font-bold text-gray-900 dark:text-white">What to Wear & Bring</h4>
                                                </div>
                                                <ul className="space-y-2">
                                                    {structuredRecommendations.wearBring.map((item, idx) => (
                                                        <li key={idx} className="flex items-start gap-2 text-sm text-gray-700 dark:text-gray-300">
                                                            <span className="text-purple-600 dark:text-purple-400 mt-1">â–¸</span>
                                                            <span>{item}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {/* Safety Tips Card */}
                                        {structuredRecommendations.safetyTips && structuredRecommendations.safetyTips.length > 0 && 
                                         !structuredRecommendations.safetyTips.some(tip => tip.toLowerCase().includes('none') || tip.toLowerCase().includes('safe')) && (
                                            <div className="bg-gradient-to-br from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 hover:shadow-lg transition">
                                                <div className="flex items-center gap-3 mb-3">
                                                    <span className="text-3xl">âš ï¸</span>
                                                    <h4 className="font-bold text-gray-900 dark:text-white">Safety Tips</h4>
                                                </div>
                                                <ul className="space-y-2">
                                                    {structuredRecommendations.safetyTips
                                                        .filter(tip => !tip.toLowerCase().includes('none') && !tip.toLowerCase().includes('safe'))
                                                        .map((tip, idx) => (
                                                        <li key={idx} className="flex items-start gap-2 text-sm text-gray-700 dark:text-gray-300">
                                                            <span className="text-red-600 dark:text-red-400 mt-1">â–¸</span>
                                                            <span>{tip}</span>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}
                                    </div>

                                    {/* Refresh Button */}
                                    <button
                                        onClick={() => analyzeLocationWithAI(weatherData)}
                                        className="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-xl font-semibold transition shadow-lg hover:shadow-xl flex items-center justify-center gap-2"
                                    >
                                        <span>ðŸ”„</span>
                                        <span>Refresh Analysis</span>
                                    </button>
                                </div>
                            ) : (
                                <div className="p-5">
                                    <div className="bg-white/20 backdrop-blur-sm rounded-lg p-4">
                                        <p className="text-sm leading-relaxed whitespace-pre-wrap text-gray-700 dark:text-gray-300">
                                            {aiRecommendations}
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {/* Manual Analysis Trigger */}
                    {weatherData && !aiRecommendations && !analyzingWeather && !structuredRecommendations && (
                        <button
                            onClick={() => analyzeLocationWithAI(weatherData)}
                            className="w-full py-4 bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all transform hover:scale-[1.02] flex items-center justify-center gap-3 border-2 border-indigo-400"
                        >
                            <span className="text-2xl animate-pulse">ðŸ¤–</span>
                            <span>Get AI Recommendations for {weatherData.name}</span>
                            <span className="text-lg">âœ¨</span>
                        </button>
                    )}
                    
                    {/* Quick Info */}
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-gray-800 dark:to-gray-700 rounded-xl p-4">
                        <p className="text-sm text-gray-700 dark:text-gray-300">
                            <span className="font-semibold">ðŸ’¡ Tip:</span> Switch between weather layers to see temperature, wind, and precipitation. 
                            Click "ðŸ¤– Get AI Recommendations" to analyze the best time and route based on current weather!
                        </p>
                    </div>
                </div>
            );
        }

        // Budget Tab Content Component (used inside Trip Planner)
        const BudgetTabContent = ({ trip, user, isDarkMode, setActiveTab, setMyTripsList }) => {
            const [editableTrip, setEditableTrip] = useState(trip ? JSON.parse(JSON.stringify(trip)) : null);
            const [newItem, setNewItem] = useState({ day: 1, category: 'Activities', name: '', cost: '' });
            const [budgetToast, setBudgetToast] = useState(null);

            useEffect(() => {
                if (trip) {
                    setEditableTrip(JSON.parse(JSON.stringify(trip)));
                }
            }, [trip]);

            const budgetData = useMemo(() => {
                if (!editableTrip || !editableTrip.itinerary) return null;
                
                const breakdown = { Accommodation: 0, Food: 0, Activities: 0, Transportation: 0, Total: 0 };

                editableTrip.itinerary.forEach(day => {
                    breakdown.Accommodation += day.accommodation?.estimated_cost || 0;
                    (day.food || []).forEach(f => breakdown.Food += f.estimated_cost || 0);
                    (day.activities || []).forEach(a => breakdown.Activities += a.estimated_cost || 0);
                    (day.transportation || []).forEach(t => breakdown.Transportation += t.estimated_cost || 0);
                });

                breakdown.Total = breakdown.Accommodation + breakdown.Food + breakdown.Activities + breakdown.Transportation;
                const avgPerDay = breakdown.Total / (editableTrip.duration_days || 1);

                return { breakdown, avgPerDay };
            }, [editableTrip]);
            
            const handleItemAdd = async () => {
                if (!newItem.name || !newItem.cost) {
                    setBudgetToast({ message: "Please enter item name and cost.", type: 'error' });
                    return;
                }
                const updatedTrip = JSON.parse(JSON.stringify(editableTrip));
                const dayIndex = updatedTrip.itinerary.findIndex(d => d.day == newItem.day);
                if (dayIndex !== -1) {
                    const categoryKey = newItem.category.toLowerCase();
                    if (!updatedTrip.itinerary[dayIndex][categoryKey]) {
                        updatedTrip.itinerary[dayIndex][categoryKey] = [];
                    }
                    updatedTrip.itinerary[dayIndex][categoryKey].push({ name: newItem.name, estimated_cost: parseFloat(newItem.cost) });
                    
                    setEditableTrip(updatedTrip);
                    await mockApi.saveItinerary(user.id, updatedTrip, updatedTrip.isPublic);
                    setBudgetToast({ message: "Item added and trip updated!", type: 'success' });
                    setNewItem({ day: 1, category: 'Activities', name: '', cost: '' });
                    if (setMyTripsList) {
                        const trips = await mockApi.getUserTrips(user.id);
                        setMyTripsList(trips);
                    }
                }
            };

            if (!budgetData || !editableTrip) {
                return (
                    <div className="p-8 text-center">
                        <h2 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>No trip selected.</h2>
                        <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mt-2`}>Go to 'My Trips' tab to view a budget.</p>
                        <button onClick={() => setActiveTab('myTrips')} className="mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg">Go to My Trips</button>
                    </div>
                );
            }
            
            const { breakdown, avgPerDay } = budgetData;
            const maxCost = Math.max(1, breakdown.Accommodation, breakdown.Food, breakdown.Activities, breakdown.Transportation);

            const Bar = ({ label, value, color }) => (
                <div>
                    <div className="flex justify-between mb-1">
                        <span className="text-base font-medium">{label}</span>
                        <span className={`text-sm font-medium ${isDarkMode ? 'text-white' : 'text-slate-700'}`}>â‚¹{value.toLocaleString('en-IN')}</span>
                    </div>
                    <div className={`w-full ${isDarkMode ? 'bg-slate-700' : 'bg-gray-200'} rounded-full h-4`}>
                        <div className={`${color} h-4 rounded-full`} style={{ width: `${(value / maxCost) * 100}%` }}></div>
                    </div>
                </div>
            );
            
            const inputClasses = isDarkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-100 text-slate-900 border-slate-300';

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    {budgetToast && <Toast message={budgetToast.message} type={budgetToast.type} onDismiss={() => setBudgetToast(null)} />}
                    <h1 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-2`}>Budget for: {editableTrip.title}</h1>
                    <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mb-8`}>An estimated cost breakdown for your adventure. Add or remove items to see the budget update in real-time.</p>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-8">
                            <div className={`${isDarkMode ? 'bg-slate-800/50' : 'bg-white/50'} backdrop-blur-lg p-6 rounded-2xl`}>
                                <h2 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'} mb-6`}>Cost Breakdown</h2>
                                <div className="space-y-4">
                                    <Bar label="Accommodation" value={breakdown.Accommodation} color="bg-blue-500" />
                                    <Bar label="Food" value={breakdown.Food} color="bg-green-500" />
                                    <Bar label="Activities" value={breakdown.Activities} color="bg-yellow-500" />
                                    <Bar label="Transportation" value={breakdown.Transportation} color="bg-red-500" />
                                </div>
                            </div>
                             <div className={`${isDarkMode ? 'bg-slate-800/50' : 'bg-white/50'} backdrop-blur-lg p-6 rounded-2xl`}>
                                <h2 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'} mb-4`}>Add Expense</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} placeholder="Item Name (e.g., Taxi)" className={`w-full ${inputClasses} border rounded-lg p-3`} />
                                    <input type="number" value={newItem.cost} onChange={e => setNewItem({...newItem, cost: e.target.value})} placeholder="Cost (â‚¹)" className={`w-full ${inputClasses} border rounded-lg p-3`} />
                                    <select value={newItem.day} onChange={e => setNewItem({...newItem, day: e.target.value})} className={`w-full ${inputClasses} border rounded-lg p-3`}>
                                        {editableTrip.itinerary.map(d => <option key={d.day} value={d.day}>Day {d.day}</option>)}
                                    </select>
                                    <select value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})} className={`w-full ${inputClasses} border rounded-lg p-3`}>
                                        <option>Activities</option>
                                        <option>Food</option>
                                        <option>Transportation</option>
                                    </select>
                                </div>
                                <button onClick={handleItemAdd} className="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">Add Item</button>
                            </div>
                        </div>
                        <div className={`${isDarkMode ? 'bg-slate-800/50' : 'bg-white/50'} backdrop-blur-lg p-6 rounded-2xl flex flex-col justify-center items-center`}>
                             <h2 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'} mb-4`}>Trip Summary</h2>
                             <div className="text-center">
                                <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>Total Estimated Cost</p>
                                <p className={`text-4xl font-bold text-indigo-400 my-2`}>â‚¹{breakdown.Total.toLocaleString('en-IN')}</p>
                             </div>
                             <div className="text-center mt-4">
                                <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>Average Cost Per Day</p>
                                <p className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'} my-1`}>â‚¹{avgPerDay.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
                             </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Activity Search Component
        const ActivitySearch = ({ destination, onAddActivity, onClose, isDarkMode }) => {
            const [activities, setActivities] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filters, setFilters] = useState({ type: 'All', cost: 'All' });

            useEffect(() => {
                activitiesApi.getActivities(destination).then(data => {
                    setActivities(data);
                    setLoading(false);
                });
            }, [destination]);

            const handleFilterChange = (e) => {
                setFilters({ ...filters, [e.target.name]: e.target.value });
            };

            const filteredActivities = useMemo(() => {
                return activities.filter(act => {
                    const typeMatch = filters.type === 'All' || act.type === filters.type;
                    const costMatch = filters.cost === 'All' || (filters.cost === 'Free' && act.cost === 0) || (filters.cost === 'Paid' && act.cost > 0);
                    return typeMatch && costMatch;
                });
            }, [activities, filters]);

            const inputClasses = isDarkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-100 text-slate-900 border-slate-300';

            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className={`${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white/80 border-slate-200'} backdrop-blur-lg border rounded-2xl p-8 w-full max-w-3xl animate-fade-in-up h-[90vh] flex flex-col`} onClick={e => e.stopPropagation()}>
                        <h2 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-4`}>Find Activities in {destination}</h2>
                        
                        <div className="flex gap-4 mb-4">
                            <select name="type" onChange={handleFilterChange} className={`w-full ${inputClasses} border rounded-lg p-2`}>
                                <option>All</option>
                                <option>Sightseeing</option>
                                <option>Food Tour</option>
                                <option>Art</option>
                                <option>Relaxation</option>
                                <option>Shopping</option>
                                <option>Adventure</option>
                                <option>Nature</option>
                                <option>History</option>
                            </select>
                            <select name="cost" onChange={handleFilterChange} className={`w-full ${inputClasses} border rounded-lg p-2`}>
                                <option>All</option>
                                <option>Free</option>
                                <option>Paid</option>
                            </select>
                        </div>

                        <div className="flex-1 overflow-y-auto pr-2">
                            {loading ? <p className={isDarkMode ? 'text-white' : 'text-slate-900'}>Loading activities...</p> : (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {filteredActivities.map(act => (
                                        <div key={act.id} className={`${isDarkMode ? 'bg-slate-900/50' : 'bg-slate-100/50'} p-4 rounded-lg`}>
                                            <img src={act.image} alt={act.name} className="w-full h-32 object-cover rounded-lg mb-2"/>
                                            <h4 className={`font-bold ${isDarkMode ? 'text-white' : 'text-slate-800'}`}>{act.name}</h4>
                                            <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>{act.type} - {act.duration} hours</p>
                                            <p className={`text-sm font-semibold ${isDarkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>Cost: â‚¹{act.cost}</p>
                                            <button onClick={() => onAddActivity(act)} className="w-full mt-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Add to Day</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <button onClick={onClose} className="mt-6 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Close</button>
                    </div>
                </div>
            );
        };

        // Dream Trip Planner Component
        function DreamTripPlanner({ user, setCurrentPage, darkMode }) {
            const [dreamTrips, setDreamTrips] = useState(() => {
                const saved = localStorage.getItem(`dreamTrips_${user?.id || 'default'}`);
                return saved ? JSON.parse(saved) : [];
            });
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [showWalletModal, setShowWalletModal] = useState(false);
            const [newTrip, setNewTrip] = useState({
                destination: '',
                targetAmount: '',
                description: '',
                targetDate: ''
            });
            const [walletAmount, setWalletAmount] = useState(() => {
                const saved = localStorage.getItem(`wallet_${user?.id || 'default'}`);
                return saved ? parseFloat(saved) : 0;
            });
            const [addMoneyAmount, setAddMoneyAmount] = useState('');
            const [notifications, setNotifications] = useState(() => {
                const saved = localStorage.getItem(`notifications_${user?.id || 'default'}`);
                return saved ? JSON.parse(saved) : [];
            });

            // Save to localStorage whenever dreamTrips change
            useEffect(() => {
                localStorage.setItem(`dreamTrips_${user?.id || 'default'}`, JSON.stringify(dreamTrips));
            }, [dreamTrips, user?.id]);

            // Save wallet amount
            useEffect(() => {
                localStorage.setItem(`wallet_${user?.id || 'default'}`, walletAmount.toString());
            }, [walletAmount, user?.id]);

            // Save notifications
            useEffect(() => {
                localStorage.setItem(`notifications_${user?.id || 'default'}`, JSON.stringify(notifications));
            }, [notifications, user?.id]);

            // Check for goal completion when trips or wallet changes
            useEffect(() => {
                const updatedTrips = [...dreamTrips];
                let needsUpdate = false;
                updatedTrips.forEach(trip => {
                    if (trip.currentAmount >= trip.targetAmount && !trip.goalReached) {
                        trip.goalReached = true;
                        needsUpdate = true;
                        const newNotif = {
                            id: Date.now(),
                            type: 'goal_reached',
                            message: `ðŸŽ‰ Congratulations! Your dream trip to ${trip.destination} is fully funded! Plan your trip now!`,
                            tripId: trip.id,
                            timestamp: new Date().toISOString()
                        };
                        setNotifications(prev => [newNotif, ...prev].slice(0, 10));
                    }
                });
                if (needsUpdate) {
                    setDreamTrips(updatedTrips);
                }
            }, [dreamTrips, walletAmount]);

            const addNotification = (notification) => {
                const newNotif = { id: Date.now(), ...notification };
                setNotifications(prev => [newNotif, ...prev].slice(0, 10)); // Keep last 10
            };

            const createDreamTrip = () => {
                if (!newTrip.destination || !newTrip.targetAmount) {
                    alert('Please fill in destination and target amount');
                    return;
                }
                const trip = {
                    id: Date.now(),
                    destination: newTrip.destination,
                    targetAmount: parseFloat(newTrip.targetAmount),
                    currentAmount: 0,
                    description: newTrip.description,
                    targetDate: newTrip.targetDate,
                    createdAt: new Date().toISOString(),
                    goalReached: false
                };
                setDreamTrips([...dreamTrips, trip]);
                setNewTrip({ destination: '', targetAmount: '', description: '', targetDate: '' });
                setShowCreateForm(false);
                addNotification({
                    type: 'trip_created',
                    message: `Dream trip to ${trip.destination} created! Start saving towards â‚¹${trip.targetAmount.toLocaleString()}`,
                    timestamp: new Date().toISOString()
                });
            };

            const addMoneyToWallet = () => {
                const amount = parseFloat(addMoneyAmount);
                if (isNaN(amount) || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }
                const newWalletAmount = walletAmount + amount;
                setWalletAmount(newWalletAmount);
                setAddMoneyAmount('');
                setShowWalletModal(false);
                addNotification({
                    type: 'money_added',
                    message: `ðŸ’° â‚¹${amount.toLocaleString()} added to wallet! Total: â‚¹${newWalletAmount.toLocaleString()}`,
                    timestamp: new Date().toISOString()
                });
            };

            const allocateMoneyToTrip = (tripId) => {
                if (walletAmount <= 0) {
                    setShowWalletModal(true);
                    return;
                }
                const trip = dreamTrips.find(t => t.id === tripId);
                if (!trip) return;
                
                const amountToAllocate = Math.min(walletAmount, trip.targetAmount - trip.currentAmount);
                if (amountToAllocate <= 0) {
                    alert('This trip is already fully funded!');
                    return;
                }
                
                trip.currentAmount += amountToAllocate;
                setWalletAmount(walletAmount - amountToAllocate);
                setDreamTrips([...dreamTrips]);
                
                addNotification({
                    type: 'money_allocated',
                    message: `âœ… â‚¹${amountToAllocate.toLocaleString()} allocated to ${trip.destination}. Progress: ${((trip.currentAmount / trip.targetAmount) * 100).toFixed(1)}%`,
                    tripId: tripId,
                    timestamp: new Date().toISOString()
                });

                // Check if goal reached
                if (trip.currentAmount >= trip.targetAmount) {
                    setTimeout(() => {
                        if (window.confirm(`ðŸŽ‰ Your dream trip to ${trip.destination} is fully funded! Would you like to plan your trip now?`)) {
                            setCurrentPage('planner');
                        }
                    }, 500);
                }
            };

            const handleNotificationClick = (notification) => {
                if (notification.type === 'goal_reached' && notification.tripId) {
                    if (window.confirm('Would you like to plan your trip now?')) {
                        setCurrentPage('planner');
                    }
                }
                // Remove notification after clicking
                setNotifications(prev => prev.filter(n => n.id !== notification.id));
            };

            const deleteTrip = (tripId) => {
                const trip = dreamTrips.find(t => t.id === tripId);
                if (window.confirm(`Are you sure you want to delete your dream trip to ${trip.destination}?`)) {
                    // Refund money back to wallet
                    const trip = dreamTrips.find(t => t.id === tripId);
                    if (trip) {
                        setWalletAmount(prev => prev + trip.currentAmount);
                    }
                    setDreamTrips(dreamTrips.filter(t => t.id !== tripId));
                }
            };

            const getProgressPercentage = (current, target) => {
                return Math.min((current / target) * 100, 100);
            };

            return (
                <div className={`space-y-6 ${darkMode ? 'text-white' : ''}`}>
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h1 className="text-4xl font-bold mb-2 flex items-center gap-3">
                                <span className="text-5xl">ðŸ’«</span>
                                Dream Trip Planner
                            </h1>
                            <p className="text-gray-600 dark:text-gray-400">Save money for your dream destinations and plan trips when goals are reached!</p>
                        </div>
                    </div>

                    {/* Wallet Card */}
                    <div className={`${darkMode ? 'bg-gray-800' : 'bg-gradient-to-r from-green-500 to-emerald-600'} rounded-xl p-6 shadow-lg text-white`}>
                        <div className="flex justify-between items-center">
                            <div>
                                <p className="text-sm opacity-90 mb-1">Your Wallet Balance</p>
                                <p className="text-4xl font-bold">â‚¹{walletAmount.toLocaleString('en-IN')}</p>
                            </div>
                            <button
                                onClick={() => setShowWalletModal(true)}
                                className="bg-white text-green-600 hover:bg-green-50 px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                                </svg>
                                Add Money
                            </button>
                        </div>
                    </div>

                    {/* Notifications */}
                    {notifications.length > 0 && (
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-blue-50'} rounded-xl p-4 border-l-4 border-blue-500`}>
                            <div className="flex justify-between items-center mb-2">
                                <h3 className="font-semibold text-blue-700 dark:text-blue-300">Recent Notifications</h3>
                                <button
                                    onClick={() => setNotifications([])}
                                    className="text-sm text-blue-600 hover:underline"
                                >
                                    Clear All
                                </button>
                            </div>
                            <div className="space-y-2 max-h-48 overflow-y-auto">
                                {notifications.slice(0, 5).map(notif => (
                                    <div
                                        key={notif.id}
                                        onClick={() => handleNotificationClick(notif)}
                                        className={`${darkMode ? 'bg-gray-700' : 'bg-white'} p-3 rounded-lg cursor-pointer hover:shadow-md transition`}
                                    >
                                        <p className="text-sm">{notif.message}</p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {new Date(notif.timestamp).toLocaleString()}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Create New Dream Trip Button */}
                    <div className="flex justify-end">
                        <button
                            onClick={() => setShowCreateForm(!showCreateForm)}
                            className={`${darkMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-blue-600 hover:bg-blue-700'} text-white px-6 py-3 rounded-lg font-semibold transition flex items-center gap-2`}
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            {showCreateForm ? 'Cancel' : 'Create Dream Trip'}
                        </button>
                    </div>

                    {/* Create Form */}
                    {showCreateForm && (
                        <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-lg`}>
                            <h3 className="text-2xl font-bold mb-4">Create Your Dream Trip</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-semibold mb-2">Destination</label>
                                    <input
                                        type="text"
                                        value={newTrip.destination}
                                        onChange={(e) => setNewTrip({...newTrip, destination: e.target.value})}
                                        placeholder="e.g., Goa, Ladakh, Kerala..."
                                        className={`w-full px-4 py-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold mb-2">Target Amount (â‚¹)</label>
                                    <input
                                        type="number"
                                        value={newTrip.targetAmount}
                                        onChange={(e) => setNewTrip({...newTrip, targetAmount: e.target.value})}
                                        placeholder="e.g., 50000"
                                        className={`w-full px-4 py-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold mb-2">Description (Optional)</label>
                                    <textarea
                                        value={newTrip.description}
                                        onChange={(e) => setNewTrip({...newTrip, description: e.target.value})}
                                        placeholder="What makes this your dream trip?"
                                        rows="3"
                                        className={`w-full px-4 py-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold mb-2">Target Date (Optional)</label>
                                    <input
                                        type="date"
                                        value={newTrip.targetDate}
                                        onChange={(e) => setNewTrip({...newTrip, targetDate: e.target.value})}
                                        className={`w-full px-4 py-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                    />
                                </div>
                                <button
                                    onClick={createDreamTrip}
                                    className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition"
                                >
                                    Create Dream Trip
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Dream Trips List */}
                    <div className="space-y-4">
                        <h2 className="text-2xl font-bold">Your Dream Trips</h2>
                        {dreamTrips.length === 0 ? (
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-8 text-center`}>
                                <p className="text-gray-500 text-lg mb-4">No dream trips yet. Create your first one!</p>
                            </div>
                        ) : (
                            dreamTrips.map(trip => {
                                const progress = getProgressPercentage(trip.currentAmount, trip.targetAmount);
                                const isComplete = trip.currentAmount >= trip.targetAmount;
                                return (
                                    <div
                                        key={trip.id}
                                        className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-lg border-l-4 ${isComplete ? 'border-green-500' : 'border-blue-500'}`}
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex-1">
                                                <div className="flex items-center gap-2 mb-2">
                                                    <h3 className="text-xl font-bold">{trip.destination}</h3>
                                                    {isComplete && (
                                                        <span className="bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                                                            Goal Reached! ðŸŽ‰
                                                        </span>
                                                    )}
                                                </div>
                                                {trip.description && (
                                                    <p className="text-gray-600 dark:text-gray-400 text-sm mb-2">{trip.description}</p>
                                                )}
                                                {trip.targetDate && (
                                                    <p className="text-gray-500 dark:text-gray-500 text-sm">
                                                        Target Date: {new Date(trip.targetDate).toLocaleDateString()}
                                                    </p>
                                                )}
                                            </div>
                                            <button
                                                onClick={() => deleteTrip(trip.id)}
                                                className="text-red-500 hover:text-red-700 p-2"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>

                                        {/* Progress Bar */}
                                        <div className="mb-4">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm font-semibold">
                                                    Saved: â‚¹{trip.currentAmount.toLocaleString('en-IN')}
                                                </span>
                                                <span className="text-sm font-semibold">
                                                    Target: â‚¹{trip.targetAmount.toLocaleString('en-IN')}
                                                </span>
                                            </div>
                                            <div className={`w-full ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} rounded-full h-4 overflow-hidden`}>
                                                <div
                                                    className={`h-full transition-all duration-500 ${isComplete ? 'bg-green-500' : 'bg-blue-500'}`}
                                                    style={{ width: `${progress}%` }}
                                                />
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                                {progress.toFixed(1)}% Complete â€¢ 
                                                Remaining: â‚¹{(trip.targetAmount - trip.currentAmount).toLocaleString('en-IN')}
                                            </p>
                                        </div>

                                        {/* Actions */}
                                        <div className="flex gap-3">
                                            {!isComplete && (
                                                <button
                                                    onClick={() => allocateMoneyToTrip(trip.id)}
                                                    className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold transition"
                                                >
                                                    Allocate from Wallet
                                                </button>
                                            )}
                                            {isComplete && (
                                                <button
                                                    onClick={() => setCurrentPage('planner')}
                                                    className="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold transition"
                                                >
                                                    ðŸŽ‰ Plan Your Trip Now!
                                                </button>
                                            )}
                                            {walletAmount === 0 && !isComplete && (
                                                <button
                                                    onClick={() => setShowWalletModal(true)}
                                                    className="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg font-semibold transition"
                                                >
                                                    Add Money to Wallet
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {/* Add Money Modal */}
                    {showWalletModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 w-full max-w-md shadow-2xl`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-2xl font-bold">Add Money to Wallet</h3>
                                    <button
                                        onClick={() => setShowWalletModal(false)}
                                        className="text-gray-400 hover:text-red-600 text-2xl"
                                    >
                                        âœ•
                                    </button>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-semibold mb-2">Amount (â‚¹)</label>
                                    <input
                                        type="number"
                                        value={addMoneyAmount}
                                        onChange={(e) => setAddMoneyAmount(e.target.value)}
                                        placeholder="Enter amount"
                                        className={`w-full px-4 py-2 rounded-lg border ${darkMode ? 'bg-gray-700 border-gray-600' : 'bg-white border-gray-300'}`}
                                        autoFocus
                                    />
                                </div>
                                <div className="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                    <p className="text-sm text-blue-700 dark:text-blue-300">
                                        Current Balance: â‚¹{walletAmount.toLocaleString('en-IN')}
                                    </p>
                                    {addMoneyAmount && (
                                        <p className="text-sm text-blue-700 dark:text-blue-300 mt-1">
                                            New Balance: â‚¹{(walletAmount + parseFloat(addMoneyAmount || 0)).toLocaleString('en-IN')}
                                        </p>
                                    )}
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowWalletModal(false)}
                                        className="flex-1 bg-gray-600 hover:bg-gray-700 text-white py-2 rounded-lg font-semibold transition"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={addMoneyToWallet}
                                        className="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold transition"
                                    >
                                        Add Money
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Trip Planner Page - Enhanced BharatTripAI Itinerary Planner
        function TripPlannerPage({ user, setCurrentPage, tripToEdit, setTripToEdit, darkMode }) {
            const [activeTab, setActiveTab] = useState('planner'); // planner, myTrips, budget, community
            const [selectedTripForBudget, setSelectedTripForBudget] = useState(null);
            const [formData, setFormData] = useState({
                startDest: '', 
                finalDest: '', 
                stops: [''], 
                startDate: '', 
                endDate: '', 
                travelers: 1, 
                budget: 'Mid-Range', 
                customPrompt: ''
            });
            const [generatedItinerary, setGeneratedItinerary] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [makePublic, setMakePublic] = useState(false);
            const [toast, setToast] = useState(null);
            const [showActivitySearch, setShowActivitySearch] = useState(false);
            const [currentDayForActivity, setCurrentDayForActivity] = useState(null);
            const [bannerImage, setBannerImage] = useState('');
            const [showAlternativesModal, setShowAlternativesModal] = useState(false);
            const [currentDayForAlternatives, setCurrentDayForAlternatives] = useState(null);
            const [alternativeOptions, setAlternativeOptions] = useState([]);
            const [isGeneratingAlternatives, setIsGeneratingAlternatives] = useState(false);

            // Populate form if editing a trip
            useEffect(() => {
                if (tripToEdit) {
                    setFormData({
                        startDest: tripToEdit.starting_destination || '',
                        finalDest: tripToEdit.final_destination || '',
                        stops: tripToEdit.stops || [''],
                        startDate: tripToEdit.startDate || '',
                        endDate: tripToEdit.endDate || '',
                        travelers: tripToEdit.travelers || 1,
                        budget: tripToEdit.budget_style || 'Mid-Range',
                        customPrompt: tripToEdit.customPrompt || ''
                    });
                    setGeneratedItinerary(tripToEdit);
                    setMakePublic(tripToEdit.isPublic || false);
                }
            }, [tripToEdit]);

            // Dynamic banner image
            useEffect(() => {
                if (formData.finalDest) {
                    setBannerImage(`https://source.unsplash.com/1600x900/?${encodeURIComponent(formData.finalDest)}`);
                } else {
                    setBannerImage('');
                }
            }, [formData.finalDest]);

            const handleInputChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
            const handleStopChange = (index, value) => {
                const newStops = [...formData.stops];
                newStops[index] = value;
                setFormData({ ...formData, stops: newStops });
            };
            const addStop = () => setFormData({ ...formData, stops: [...formData.stops, ''] });
            const removeStop = (index) => setFormData({ ...formData, stops: formData.stops.filter((_, i) => i !== index) });

            const itinerarySchema = {
                type: "object",
                properties: {
                    "title": { "type": "string" }, 
                    "starting_destination": { "type": "string" }, 
                    "final_destination": { "type": "string" }, 
                    "duration_days": { "type": "number" }, 
                    "budget_style": { "type": "string" }, 
                    "interests": { "type": "array", "items": { "type": "string" } },
                    "itinerary": { 
                        "type": "array", 
                        "items": { 
                            "type": "object", 
                            "properties": { 
                                "day": { "type": "number" }, 
                                "title": { "type": "string" }, 
                                "location": { "type": "string" }, 
                                "activities": { 
                                    "type": "array", 
                                    "items": { 
                                        "type": "object", 
                                        "properties": { 
                                            "name": {"type": "string"}, 
                                            "estimated_cost": {"type": "number"}
                                        }
                                    } 
                                }, 
                                "food": { 
                                    "type": "array", 
                                    "items": { 
                                        "type": "object", 
                                        "properties": { 
                                            "name": {"type": "string"}, 
                                            "estimated_cost": {"type": "number"}
                                        }
                                    } 
                                }, 
                                "accommodation": { 
                                    "type": "object", 
                                    "properties": { 
                                        "name": {"type": "string"}, 
                                        "estimated_cost": {"type": "number"}
                                    }
                                },
                                "transportation": { 
                                    "type": "array", 
                                    "items": { 
                                        "type": "object", 
                                        "properties": { 
                                            "name": {"type": "string"}, 
                                            "estimated_cost": {"type": "number"}
                                        }
                                    }
                                }
                            }, 
                            "required": ["day", "title", "location", "activities", "food", "accommodation"] 
                        } 
                    }
                }, 
                "required": ["title", "starting_destination", "final_destination", "duration_days", "budget_style", "itinerary"]
            };

            const handleGenerate = async () => {
                if (!formData.startDest || !formData.finalDest || !formData.startDate || !formData.endDate) {
                    setToast({ message: "Please fill all required fields, including dates.", type: 'error' });
                    return;
                }
                setIsGenerating(true); 
                setGeneratedItinerary(null); 
                setToast(null);
                
                // Calculate number of days
                const start = new Date(formData.startDate);
                const end = new Date(formData.endDate);
                const numDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                const stopsText = formData.stops.filter(s => s.trim() !== '').join(', ');
                
                const prompt = `You are an expert Indian travel planner. Create a detailed ${numDays}-day travel itinerary in JSON format.

TRIP DETAILS:
- Starting City: ${formData.startDest} (traveler starts journey from here)
- Final Destination: ${formData.finalDest} (THIS IS THE ONLY DESTINATION TO EXPLORE)
- Intermediate Stops: ${stopsText || 'None - Direct travel to final destination'}
- Trip Duration: ${formData.startDate} to ${formData.endDate} (${numDays} days)
- Number of Travelers: ${formData.travelers}
- Budget Style: ${formData.budget}
- User Preferences: ${formData.customPrompt || 'General sightseeing'}

CRITICAL RULES - FOLLOW STRICTLY:
1. Day 1: Travel from ${formData.startDest} to ${formData.finalDest}, then explore ${formData.finalDest}
2. Days 2 to ${numDays}: ALL activities MUST be in ${formData.finalDest} ONLY
3. DO NOT add any other cities like Khajuraho, Agra, Jaipur etc. unless they are explicitly listed in Intermediate Stops
4. ${stopsText ? `If intermediate stops are provided (${stopsText}), allocate 1 day per stop before reaching ${formData.finalDest}` : `Since no intermediate stops are specified, the ENTIRE trip should be in ${formData.finalDest}`}
5. Focus on exploring different areas, attractions, and experiences within ${formData.finalDest}
6. Include realistic costs in Indian Rupees (INR)
7. Suggest local food and restaurants of ${formData.finalDest}
8. Recommend appropriate accommodation in ${formData.finalDest} for the budget style

Return ONLY a valid JSON object with this exact structure (no additional text):
{
  "title": "Trip from ${formData.startDest} to ${formData.finalDest}",
  "starting_destination": "${formData.startDest}",
  "final_destination": "${formData.finalDest}",
  "duration_days": ${numDays},
  "budget_style": "${formData.budget}",
  "interests": ["sightseeing", "culture", "food"],
  "itinerary": [
    {
      "day": 1,
      "title": "Arrival in ${formData.finalDest}",
      "location": "${formData.finalDest}",
      "activities": [{"name": "Activity name", "estimated_cost": 500}],
      "food": [{"name": "Restaurant/cuisine", "estimated_cost": 800}],
      "accommodation": {"name": "Hotel type", "estimated_cost": 2000},
      "transportation": [{"name": "Travel from ${formData.startDest} to ${formData.finalDest}", "estimated_cost": 2000}]
    }
  ]
}

REMEMBER: All ${numDays} days should have location set to "${formData.finalDest}" (except intermediate stops if any).`;

                try {
                    const response = await geminiApi.generateContent(prompt);
                    
                    // Extract JSON from the response
                    let jsonData;
                    if (typeof response === 'object') {
                        jsonData = response;
                    } else {
                        // Try to extract JSON from text
                        const jsonMatch = response.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            jsonData = JSON.parse(jsonMatch[0]);
                        } else {
                            throw new Error("Could not extract JSON from response");
                        }
                    }
                    
                    // Validate the response has required fields
                    if (!jsonData.itinerary || !Array.isArray(jsonData.itinerary)) {
                        throw new Error("Invalid itinerary format received");
                    }
                    
                    const fullItineraryData = {
                        ...jsonData,
                        startDate: formData.startDate,
                        endDate: formData.endDate,
                        travelers: formData.travelers,
                        stops: formData.stops.filter(s => s.trim() !== ''),
                    };
                    
                    setGeneratedItinerary(fullItineraryData);
                    setToast({ message: "ðŸŽ‰ Your itinerary has been generated!", type: 'success' });
                } catch (error) {
                    console.error("Itinerary generation error:", error);
                    console.error("Error details:", error.message, error.stack);
                    
                    let errorMessage = "Failed to generate itinerary. Please try again.";
                    if (error.message?.includes('API request failed')) {
                        errorMessage = `API Error: ${error.message}. Please check your connection and try again.`;
                    } else if (error.message?.includes('JSON') || error.message?.includes('parse')) {
                        errorMessage = "Failed to parse itinerary response. Please try again.";
                    } else if (error.message?.includes('quota') || error.message?.includes('429')) {
                        errorMessage = "API quota exceeded. Please wait a moment and try again.";
                    }
                    
                    setToast({ message: errorMessage, type: 'error' });
                } finally { 
                    setIsGenerating(false); 
                }
            };
            
            const handleAddActivity = (activity) => {
                setGeneratedItinerary(prev => {
                    const newItinerary = JSON.parse(JSON.stringify(prev));
                    const dayIndex = newItinerary.itinerary.findIndex(d => d.day === currentDayForActivity.day);
                    if (dayIndex !== -1) {
                        if (!newItinerary.itinerary[dayIndex].activities) {
                            newItinerary.itinerary[dayIndex].activities = [];
                        }
                        newItinerary.itinerary[dayIndex].activities.push({ name: activity.name, estimated_cost: activity.cost });
                    }
                    return newItinerary;
                });
                setToast({ message: `${activity.name} added!`, type: 'success' });
            };

            const handleAskAssistantToChange = async (day) => {
                setCurrentDayForAlternatives(day);
                setShowAlternativesModal(true);
                setIsGeneratingAlternatives(true);
                setAlternativeOptions([]);

                try {
                    // Create prompt for generating 3 alternative options
                    const dayContext = `
Current Day ${day.day} Plan:
- Location: ${day.location}
- Title: ${day.title}
- Transportation: ${(day.transportation || []).map(t => t.name).join(', ') || 'Not specified'}
- Activities: ${(day.activities || []).map(a => a.name).join(', ')}
- Food: ${(day.food || []).map(f => f.name).join(', ')}
- Accommodation: ${day.accommodation?.name || 'Not specified'}
- Budget Style: ${formData.budget}
- Number of Travelers: ${formData.travelers}
`;

                    const prompt = `You are a travel assistant helping to modify a day in an itinerary. The user wants alternative options for Day ${day.day} in ${day.location}.

${dayContext}

Generate exactly 3 alternative day plans for this location. Each alternative should:
1. Be different from the current plan
2. Maintain the same budget style (${formData.budget})
3. Include transportation, activities, food, and accommodation
4. Provide estimated costs in INR
5. Be realistic and enjoyable

Return a JSON array with exactly 3 objects. Each object should have:
- title: A catchy title for the day
- transportation: Array of {name, estimated_cost}
- activities: Array of {name, estimated_cost}
- food: Array of {name, estimated_cost}
- accommodation: Object with {name, estimated_cost}
- description: Brief description of this alternative

Format: [{"title": "...", "transportation": [...], "activities": [...], "food": [...], "accommodation": {...}, "description": "..."}, ...]`;

                    const alternatives = await geminiApi.generateContent(prompt);
                    
                    // Parse the response - it might be a JSON string or already parsed
                    let parsedAlternatives;
                    if (typeof alternatives === 'string') {
                        // Try to extract JSON from the string
                        const jsonMatch = alternatives.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            parsedAlternatives = JSON.parse(jsonMatch[0]);
                        } else {
                            parsedAlternatives = JSON.parse(alternatives);
                        }
                    } else {
                        parsedAlternatives = alternatives;
                    }

                    // Ensure we have exactly 3 options
                    if (Array.isArray(parsedAlternatives) && parsedAlternatives.length >= 3) {
                        setAlternativeOptions(parsedAlternatives.slice(0, 3));
                    } else {
                        // Fallback: create 3 options from what we have or generate more
                        throw new Error('Did not receive 3 alternatives');
                    }
                } catch (error) {
                    console.error('Error generating alternatives:', error);
                    // Create fallback alternatives
                    setAlternativeOptions([
                        {
                            title: `Alternative Experience in ${day.location}`,
                            description: "A different way to explore this destination",
                            transportation: [{ name: 'Local Transport', estimated_cost: 500 }],
                            activities: [{ name: 'Local Market Visit', estimated_cost: 1000 }],
                            food: [{ name: 'Street Food Tour', estimated_cost: 800 }],
                            accommodation: { name: 'Budget Hotel', estimated_cost: 2000 }
                        },
                        {
                            title: `Cultural Immersion in ${day.location}`,
                            description: "Deep dive into local culture",
                            transportation: [{ name: 'Walking Tour', estimated_cost: 0 }],
                            activities: [{ name: 'Cultural Show', estimated_cost: 1500 }],
                            food: [{ name: 'Traditional Restaurant', estimated_cost: 1200 }],
                            accommodation: { name: 'Heritage Stay', estimated_cost: 3000 }
                        },
                        {
                            title: `Relaxed Day in ${day.location}`,
                            description: "Take it easy with leisure activities",
                            transportation: [{ name: 'Taxi Service', estimated_cost: 800 }],
                            activities: [{ name: 'Spa/Wellness', estimated_cost: 2000 }],
                            food: [{ name: 'CafÃ© & Relax', estimated_cost: 600 }],
                            accommodation: { name: 'Comfortable Hotel', estimated_cost: 2500 }
                        }
                    ]);
                    setToast({ message: 'Using default alternatives. AI generation failed.', type: 'warning' });
                } finally {
                    setIsGeneratingAlternatives(false);
                }
            };

            const handleSelectAlternative = (selectedOption) => {
                if (!currentDayForAlternatives || !generatedItinerary) return;

                setGeneratedItinerary(prev => {
                    const newItinerary = JSON.parse(JSON.stringify(prev));
                    const dayIndex = newItinerary.itinerary.findIndex(d => d.day === currentDayForAlternatives.day);
                    
                    if (dayIndex !== -1) {
                        // Update the day with selected alternative
                        newItinerary.itinerary[dayIndex] = {
                            ...newItinerary.itinerary[dayIndex],
                            title: selectedOption.title || newItinerary.itinerary[dayIndex].title,
                            transportation: selectedOption.transportation || newItinerary.itinerary[dayIndex].transportation,
                            activities: selectedOption.activities || newItinerary.itinerary[dayIndex].activities,
                            food: selectedOption.food || newItinerary.itinerary[dayIndex].food,
                            accommodation: selectedOption.accommodation || newItinerary.itinerary[dayIndex].accommodation
                        };
                    }
                    
                    return newItinerary;
                });

                setShowAlternativesModal(false);
                setCurrentDayForAlternatives(null);
                setAlternativeOptions([]);
                setToast({ message: `Day ${currentDayForAlternatives.day} updated successfully!`, type: 'success' });
            };

            const handleViewOnMap = (location) => {
                const locationName = location || formData.finalDest || formData.startDest;
                localStorage.setItem('selectedLocation', JSON.stringify({
                    name: locationName,
                    type: 'destination'
                }));
                window.dispatchEvent(new Event('navigateToExplore'));
                setTimeout(() => {
                    window.dispatchEvent(new Event('navigateToExplore'));
                }, 100);
            };

            const inputClasses = document.documentElement.classList.contains('dark') 
                ? 'bg-slate-700 text-white border-slate-600' 
                : 'bg-slate-100 text-slate-900 border-slate-300';
            const isDarkMode = document.documentElement.classList.contains('dark');
            const today = new Date().toISOString().split('T')[0];

            // State for My Trips, Budget, Community
            const [myTripsList, setMyTripsList] = useState([]);
            const [myTripsLoading, setMyTripsLoading] = useState(false);
            const [myTripsFilter, setMyTripsFilter] = useState('all');
            const [publicTrips, setPublicTrips] = useState([]);
            const [communityLoading, setCommunityLoading] = useState(false);
            const [selectedTripForReviews, setSelectedTripForReviews] = useState(null);
            const [tripReviews, setTripReviews] = useState([]);
            const [reviewLoading, setReviewLoading] = useState(false);
            const [showReviewForm, setShowReviewForm] = useState(false);
            const [newReview, setNewReview] = useState({ rating: 5, title: '', comment: '' });
            const [tripRating, setTripRating] = useState({ average: 0, count: 0 });
            
            // Load trips when My Trips tab is active
            useEffect(() => {
                if (activeTab === 'myTrips' && user) {
                    const fetchTrips = async () => {
                        setMyTripsLoading(true);
                        const trips = await mockApi.getUserTrips(user.id);
                        setMyTripsList(trips);
                        setMyTripsLoading(false);
                    };
                    fetchTrips();
                }
            }, [activeTab, user]);
            
            // Load community trips when Community tab is active
            useEffect(() => {
                if (activeTab === 'community') {
                    const fetchPublicTrips = async () => {
                        setCommunityLoading(true);
                        const trips = await mockApi.getPublicTrips('approved');
                        setPublicTrips(trips);
                        setCommunityLoading(false);
                    };
                    fetchPublicTrips();
                }
            }, [activeTab]);
            
            // Also refresh community trips when switching to community tab (in case new trips were approved)
            const handleTabChange = (tabId) => {
                setActiveTab(tabId);
                if (tabId !== 'budget') setSelectedTripForBudget(null);
                // Refresh community trips when switching to community tab
                if (tabId === 'community') {
                    const fetchPublicTrips = async () => {
                        setCommunityLoading(true);
                        const trips = await mockApi.getPublicTrips('approved');
                        setPublicTrips(trips);
                        setCommunityLoading(false);
                    };
                    fetchPublicTrips();
                }
            };

            const filteredTrips = useMemo(() => {
                if (myTripsFilter === 'all') return myTripsList;
                return myTripsList.filter(trip => trip.status === myTripsFilter);
            }, [myTripsList, myTripsFilter]);

            const handleViewBudget = (trip) => {
                setSelectedTripForBudget(trip);
                setActiveTab('budget');
            };

            const handleEditTrip = (trip) => {
                if (setTripToEdit) setTripToEdit(trip);
                setActiveTab('planner');
            };

            const handleCopyToMyTrips = (trip) => {
                setToast({ message: "Preparing to copy trip...", type: 'success' });
                const tripCopy = { 
                    ...trip, 
                    status: 'copied', 
                    isPublic: false,
                    startDate: '',
                    endDate: ''
                };
                delete tripCopy.id; 
                delete tripCopy.ownerId;
                if (setTripToEdit) setTripToEdit(tripCopy);
                setActiveTab('planner');
            };

            const handleViewReviews = async (trip) => {
                setSelectedTripForReviews(trip);
                setShowReviewForm(false);
                setReviewLoading(true);
                const reviews = await mockApi.getTripReviews(trip.id);
                const rating = await mockApi.getTripAverageRating(trip.id);
                setTripReviews(reviews);
                setTripRating(rating);
                setReviewLoading(false);
            };

            const handleSubmitReview = async () => {
                if (!selectedTripForReviews || !user) return;
                if (!newReview.comment.trim()) {
                    setToast({ message: "Please write a comment for your review.", type: 'error' });
                    return;
                }
                try {
                    await mockApi.saveReview(selectedTripForReviews.id, user.id, {
                        userName: `${user.firstName} ${user.lastName || ''}`.trim() || 'Anonymous',
                        rating: newReview.rating,
                        title: newReview.title,
                        comment: newReview.comment
                    });
                    setToast({ message: "Review submitted successfully!", type: 'success' });
                    setNewReview({ rating: 5, title: '', comment: '' });
                    setShowReviewForm(false);
                    // Refresh reviews
                    const reviews = await mockApi.getTripReviews(selectedTripForReviews.id);
                    const rating = await mockApi.getTripAverageRating(selectedTripForReviews.id);
                    setTripReviews(reviews);
                    setTripRating(rating);
                } catch (error) {
                    setToast({ message: "Failed to submit review.", type: 'error' });
                }
            };

            const handleSave = async () => {
                if (!generatedItinerary || !user) return;
                setToast({ message: "Saving...", type: 'success' });
                
                const finalTripData = {
                    ...generatedItinerary,
                    startDate: formData.startDate,
                    endDate: formData.endDate,
                    starting_destination: formData.startDest,
                    final_destination: formData.finalDest,
                    travelers: formData.travelers,
                    budget_style: formData.budget,
                    id: tripToEdit ? tripToEdit.id : null
                };

                try {
                    await mockApi.saveItinerary(user.id, finalTripData, makePublic);
                    setToast({ message: `Trip saved successfully! ${makePublic ? 'It is pending community approval.' : ''}`, type: 'success' });
                    if (setTripToEdit) setTripToEdit(null);
                    // Switch to My Trips tab and refresh
                    setActiveTab('myTrips');
                    const trips = await mockApi.getUserTrips(user.id);
                    setMyTripsList(trips);
                } catch(error) {
                    setToast({ message: error.message, type: 'error' });
                }
            };

            return (
                <div className="max-w-7xl mx-auto space-y-8 animate-fade-in p-6">
                    {toast && (
                        <div className={`fixed bottom-5 right-5 ${toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white py-3 px-6 rounded-lg shadow-xl z-50 flex items-center animate-fade-in-up`}>
                            {toast.type === 'success' ? 'âœ“' : 'âœ•'}
                            <span className="ml-3">{toast.message}</span>
                            <button onClick={() => setToast(null)} className="ml-4 font-bold">Ã—</button>
                        </div>
                    )}
                    {showActivitySearch && (
                        <ActivitySearch 
                            destination={currentDayForActivity?.location || formData.finalDest} 
                            onAddActivity={handleAddActivity} 
                            onClose={() => setShowActivitySearch(false)} 
                            isDarkMode={isDarkMode} 
                        />
                    )}
                    
                    <h2 className="text-4xl font-bold dark:text-white bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent text-center">
                        ðŸ‡®ðŸ‡³ BharatTripAI - Smart Itinerary Planner
                    </h2>
                    
                    {/* Tabs */}
                    <div className="flex gap-2 overflow-x-auto pb-2 border-b border-gray-300 dark:border-gray-700">
                        {[
                            { id: 'planner', label: 'ðŸ“ Plan Trip', icon: icons.Route },
                            { id: 'myTrips', label: 'ðŸ—“ï¸ My Trips', icon: icons.Calendar },
                            { id: 'budget', label: 'ðŸ’° Budget', icon: icons.Rupee },
                            { id: 'community', label: 'ðŸ‘¥ Community', icon: icons.Users }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => handleTabChange(tab.id)}
                                className={`flex items-center gap-2 px-6 py-3 font-semibold rounded-t-lg transition-all whitespace-nowrap ${
                                    activeTab === tab.id
                                        ? 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg'
                                        : 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'
                                }`}
                            >
                                <tab.icon className="w-5 h-5" />
                                <span>{tab.label}</span>
                            </button>
                        ))}
                    </div>
                    
                    {/* Tab Content */}
                    {activeTab === 'planner' && (
                        <>
                            <div className={`${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/50 border-slate-200'} backdrop-blur-lg border rounded-2xl p-8`}>
                                {bannerImage && <img src={bannerImage} className="w-full h-48 object-cover rounded-lg mb-6" alt="Destination" />}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <input 
                                        type="text" 
                                        name="startDest" 
                                        value={formData.startDest} 
                                        placeholder="Starting Destination (e.g., Delhi)" 
                                        onChange={handleInputChange} 
                                        className={`w-full ${inputClasses} border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none`} 
                                    />
                                    <input 
                                        type="text" 
                                        name="finalDest" 
                                        value={formData.finalDest} 
                                        placeholder="Final Destination (e.g., Goa)" 
                                        onChange={handleInputChange} 
                                        className={`w-full ${inputClasses} border rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:outline-none`} 
                                    />
                                </div>
                                <div className="mb-6">
                                    <label className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mb-2 block`}>Intermediate Stops</label>
                                    {formData.stops.map((stop, index) => (
                                        <div key={index} className="flex items-center gap-2 mb-2">
                                            <input 
                                                type="text" 
                                                value={stop} 
                                                onChange={(e) => handleStopChange(index, e.target.value)} 
                                                placeholder={`Stop ${index + 1}`} 
                                                className={`flex-grow ${inputClasses} border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none`} 
                                            />
                                            <button 
                                                onClick={() => removeStop(index)} 
                                                className="bg-red-600 hover:bg-red-500 text-white p-3 rounded-lg"
                                            >
                                                âŒ
                                            </button>
                                        </div>
                                    ))}
                                    <button onClick={addStop} className="text-indigo-400 hover:text-indigo-300 font-semibold text-sm">+ Add another stop</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <input 
                                        type="date" 
                                        name="startDate" 
                                        value={formData.startDate} 
                                        min={today} 
                                        onChange={handleInputChange} 
                                        className={`w-full ${inputClasses} border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none`} 
                                    />
                                    <input 
                                        type="date" 
                                        name="endDate" 
                                        value={formData.endDate} 
                                        min={formData.startDate || today} 
                                        onChange={handleInputChange} 
                                        className={`w-full ${inputClasses} border rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:outline-none`} 
                                    />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <input 
                                        type="number" 
                                        name="travelers" 
                                        min="1" 
                                        value={formData.travelers} 
                                        onChange={handleInputChange} 
                                        placeholder="Number of Travelers" 
                                        className={`w-full ${inputClasses} border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none`} 
                                    />
                                    <select 
                                        name="budget" 
                                        value={formData.budget} 
                                        onChange={handleInputChange} 
                                        className={`w-full ${inputClasses} border rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:outline-none`}
                                    >
                                        <option>Budget</option>
                                        <option>Mid-Range</option>
                                        <option>Luxury</option>
                                    </select>
                                </div>
                                <textarea 
                                    name="customPrompt" 
                                    value={formData.customPrompt} 
                                    onChange={handleInputChange} 
                                    placeholder="Any special requests? (e.g., 'I prefer vegan food', 'Include historical sites')" 
                                    className={`w-full ${inputClasses} border rounded-lg p-3 h-24 focus:ring-2 focus:ring-indigo-500 focus:outline-none mb-6`}
                                ></textarea>
                                <button 
                                    onClick={handleGenerate} 
                                    disabled={isGenerating || !!tripToEdit} 
                                    className="w-full text-lg bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 rounded-lg transition-all duration-300 shadow-lg hover:shadow-purple-500/30 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                                >
                                    {isGenerating ? (
                                        <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                    ) : (
                                        "âœ¨ Generate with AI"
                                    )}
                                </button>
                                {tripToEdit && <p className={`text-xs text-center mt-2 ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>AI generation is disabled when editing a trip.</p>}
                            </div>

                            {generatedItinerary && (
                                <div className={`${isDarkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/50 border-slate-200'} mt-8 backdrop-blur-lg border rounded-2xl p-8 animate-fade-in`}>
                                    <h2 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-4`}>{generatedItinerary.title}</h2>
                                    <div className="space-y-6">
                                        {generatedItinerary.itinerary && generatedItinerary.itinerary.map(day => (
                                            <div key={day.day} className={`p-4 ${isDarkMode ? 'bg-slate-900/50 border-slate-700' : 'bg-slate-100/50 border-slate-200'} rounded-lg border`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <h4 className={`text-xl font-bold text-indigo-400`}>
                                                        Day {day.day}: {day.title} 
                                                        <span className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'} font-normal`}> - {day.location}</span>
                                                    </h4>
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => { setCurrentDayForActivity(day); setShowActivitySearch(true); }} 
                                                            className="text-sm bg-teal-600 hover:bg-teal-500 text-white font-semibold py-1 px-3 rounded-lg flex items-center"
                                                        >
                                                            <icons.Search className="w-4 h-4 mr-2"/> Find Activities
                                                        </button>
                                                        <button 
                                                            onClick={() => handleAskAssistantToChange(day)} 
                                                            className="text-sm bg-purple-600 hover:bg-purple-500 text-white font-semibold py-1 px-3 rounded-lg flex items-center"
                                                        >
                                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                                            </svg>
                                                            Ask Assistant to Change
                                                        </button>
                                                    </div>
                                                </div>
                                                <div className={`${isDarkMode ? 'text-slate-300' : 'text-slate-700'} space-y-2 mt-2 text-sm`}>
                                                    <p><strong>Transportation:</strong> {(day.transportation || []).map(t => `${t.name} (â‚¹${t.estimated_cost || 0})`).join(', ') || 'Not specified'}</p>
                                                    <p><strong>Activities:</strong> {(day.activities || []).map(a => `${a.name} (â‚¹${a.estimated_cost || 0})`).join(', ') || 'Not specified'}</p>
                                                    <p><strong>Food:</strong> {(day.food || []).map(f => `${f.name} (â‚¹${f.estimated_cost || 0})`).join(', ') || 'Not specified'}</p>
                                                    <p><strong>Accommodation:</strong> {day.accommodation?.name || 'Not specified'} {day.accommodation?.estimated_cost ? `(â‚¹${day.accommodation.estimated_cost})` : ''}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-8 space-y-6">
                                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                                            <label className={`flex items-center ${isDarkMode ? 'text-slate-300' : 'text-slate-700'} cursor-pointer`}>
                                                <input 
                                                    type="checkbox" 
                                                    checked={makePublic} 
                                                    onChange={(e) => setMakePublic(e.target.checked)} 
                                                    className={`form-checkbox h-5 w-5 text-purple-600 ${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-200 border-slate-400'} rounded focus:ring-purple-500`} 
                                                />
                                                <span className="ml-2">Make this itinerary public</span>
                                            </label>
                                            <div className="flex gap-2 flex-wrap">
                                                <button 
                                                    onClick={() => handleViewOnMap(formData.finalDest)} 
                                                    className="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                                                >
                                                    ðŸ—ºï¸ View on Map
                                                </button>
                                                <button 
                                                    onClick={() => setCurrentPage('cultural')} 
                                                    className="bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                                                >
                                                    ðŸŽ­ Cultural Insights
                                                </button>
                                                <button 
                                                    onClick={handleSave} 
                                                    className="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                                                >
                                                    ðŸ’¾ Save Trip
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Alternatives Modal */}
                            {showAlternativesModal && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4">
                                    <div className={`${isDarkMode ? 'bg-slate-800' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto`}>
                                        <div className="sticky top-0 bg-slate-800 dark:bg-slate-800 border-b border-slate-700 p-6 flex justify-between items-center rounded-t-2xl">
                                            <h3 className="text-2xl font-bold text-white">
                                                Alternative Options for Day {currentDayForAlternatives?.day}
                                            </h3>
                                            <button
                                                onClick={() => {
                                                    setShowAlternativesModal(false);
                                                    setCurrentDayForAlternatives(null);
                                                    setAlternativeOptions([]);
                                                }}
                                                className="text-gray-400 hover:text-red-500 text-3xl font-bold"
                                            >
                                                âœ•
                                            </button>
                                        </div>

                                        <div className="p-6">
                                            {isGeneratingAlternatives ? (
                                                <div className="flex flex-col items-center justify-center py-12">
                                                    <div className="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                                    <p className={`text-lg ${isDarkMode ? 'text-slate-300' : 'text-slate-700'}`}>
                                                        Assistant is generating 3 alternative options for you...
                                                    </p>
                                                </div>
                                            ) : alternativeOptions.length > 0 ? (
                                                <div className="space-y-6">
                                                    <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mb-4`}>
                                                        Select one of the options below to replace Day {currentDayForAlternatives?.day}'s itinerary:
                                                    </p>
                                                    {alternativeOptions.map((option, index) => (
                                                        <div
                                                            key={index}
                                                            className={`${isDarkMode ? 'bg-slate-700 border-slate-600' : 'bg-slate-50 border-slate-200'} border-2 rounded-xl p-6 hover:border-purple-500 transition cursor-pointer`}
                                                            onClick={() => handleSelectAlternative(option)}
                                                        >
                                                            <div className="flex items-start justify-between mb-4">
                                                                <div className="flex-1">
                                                                    <h4 className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'} mb-2`}>
                                                                        Option {index + 1}: {option.title}
                                                                    </h4>
                                                                    {option.description && (
                                                                        <p className={`text-sm ${isDarkMode ? 'text-slate-300' : 'text-slate-600'} mb-3`}>
                                                                            {option.description}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                                <span className={`ml-4 px-3 py-1 rounded-full text-xs font-semibold ${isDarkMode ? 'bg-purple-600 text-white' : 'bg-purple-100 text-purple-700'}`}>
                                                                    Option {index + 1}
                                                                </span>
                                                            </div>

                                                            <div className="space-y-2 text-sm">
                                                                {option.transportation && option.transportation.length > 0 && (
                                                                    <div>
                                                                        <strong className={isDarkMode ? 'text-slate-300' : 'text-slate-700'}>Transportation: </strong>
                                                                        <span className={isDarkMode ? 'text-slate-400' : 'text-slate-600'}>
                                                                            {option.transportation.map(t => `${t.name} (â‚¹${t.estimated_cost})`).join(', ')}
                                                                        </span>
                                                                    </div>
                                                                )}
                                                                {option.activities && option.activities.length > 0 && (
                                                                    <div>
                                                                        <strong className={isDarkMode ? 'text-slate-300' : 'text-slate-700'}>Activities: </strong>
                                                                        <span className={isDarkMode ? 'text-slate-400' : 'text-slate-600'}>
                                                                            {option.activities.map(a => `${a.name} (â‚¹${a.estimated_cost})`).join(', ')}
                                                                        </span>
                                                                    </div>
                                                                )}
                                                                {option.food && option.food.length > 0 && (
                                                                    <div>
                                                                        <strong className={isDarkMode ? 'text-slate-300' : 'text-slate-700'}>Food: </strong>
                                                                        <span className={isDarkMode ? 'text-slate-400' : 'text-slate-600'}>
                                                                            {option.food.map(f => `${f.name} (â‚¹${f.estimated_cost})`).join(', ')}
                                                                        </span>
                                                                    </div>
                                                                )}
                                                                {option.accommodation && (
                                                                    <div>
                                                                        <strong className={isDarkMode ? 'text-slate-300' : 'text-slate-700'}>Accommodation: </strong>
                                                                        <span className={isDarkMode ? 'text-slate-400' : 'text-slate-600'}>
                                                                            {option.accommodation.name} (â‚¹{option.accommodation.estimated_cost})
                                                                        </span>
                                                                    </div>
                                                                )}
                                                            </div>

                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleSelectAlternative(option);
                                                                }}
                                                                className="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition"
                                                            >
                                                                Select This Option
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center py-12">
                                                    <p className={`text-lg ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                                                        No alternatives available. Please try again.
                                                    </p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </>
                    )}

                    {/* My Trips Tab */}
                    {activeTab === 'myTrips' && (
                        <div>
                            <div className="mb-6 flex items-center gap-4">
                                <icons.Filter className={isDarkMode ? 'text-slate-400' : 'text-slate-500'}/>
                                <select onChange={(e) => setMyTripsFilter(e.target.value)} value={myTripsFilter} className={`${isDarkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-100 text-slate-900 border-slate-300'} border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none`}>
                                    <option value="all">All</option>
                                    <option value="private">Private</option>
                                    <option value="copied">Copied</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            {myTripsLoading ? (
                                <div className="flex justify-center items-center h-64">
                                    <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            ) : filteredTrips.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {filteredTrips.map(trip => (
                                        <ItineraryCard 
                                            key={trip.id} 
                                            trip={trip} 
                                            isDarkMode={isDarkMode} 
                                            onViewBudget={handleViewBudget} 
                                            onEdit={handleEditTrip} 
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div className={`text-center py-16 ${isDarkMode ? 'bg-slate-800/50' : 'bg-white/50'} rounded-2xl`}>
                                    <h2 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>No trips found for this filter.</h2>
                                    <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mt-2`}>Why not plan a new one?</p>
                                    <button onClick={() => setActiveTab('planner')} className="mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg">Plan a Trip</button>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Budget Tab */}
                    {activeTab === 'budget' && <BudgetTabContent trip={selectedTripForBudget} user={user} isDarkMode={isDarkMode} setActiveTab={setActiveTab} setMyTripsList={setMyTripsList} />}

                    {/* Community Tab */}
                    {activeTab === 'community' && (
                        <div>
                            <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mb-8`}>Explore itineraries shared by other travelers. Get inspired for your next journey!</p>
                            {communityLoading ? (
                                <div className="flex justify-center items-center h-64">
                                    <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                                </div>
                            ) : publicTrips.length > 0 ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {publicTrips.map(trip => (
                                        <ItineraryCard 
                                            key={trip.id} 
                                            trip={trip} 
                                            onCopy={handleCopyToMyTrips}
                                            onRequestJoin={(trip) => {
                                                setToast({ message: `Request to join "${trip.title}" sent! (Feature coming soon)`, type: 'success' });
                                            }}
                                            onViewReviews={handleViewReviews}
                                            isDarkMode={isDarkMode}
                                        />
                                    ))}
                                </div>
                            ) : (
                                <div className={`text-center py-16 ${isDarkMode ? 'bg-slate-800/50' : 'bg-white/50'} rounded-2xl`}>
                                    <h2 className={`text-2xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>The community hub is quiet...</h2>
                                    <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} mt-2`}>Be the first to share a public trip!</p>
                                </div>
                            )}
                            
                            {/* Reviews Modal */}
                            {selectedTripForReviews && (
                                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4 overflow-y-auto">
                                    <div className={`${isDarkMode ? 'bg-slate-900' : 'bg-white'} rounded-2xl shadow-2xl w-full max-w-4xl p-8 relative my-8 max-h-[90vh] overflow-y-auto`}>
                                        <button
                                            className="absolute top-4 right-4 text-gray-400 hover:text-red-600 text-3xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition"
                                            onClick={() => {
                                                setSelectedTripForReviews(null);
                                                setShowReviewForm(false);
                                                setNewReview({ rating: 5, title: '', comment: '' });
                                            }}
                                        >
                                            âœ•
                                        </button>
                                        
                                        <div className="mb-6">
                                            <h2 className={`text-3xl font-bold mb-2 ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                                                Reviews & Ratings - {selectedTripForReviews.title}
                                            </h2>
                                            {tripRating.count > 0 && (
                                                <div className="flex items-center gap-3 mt-2">
                                                    <StarRating rating={Math.round(parseFloat(tripRating.average))} isEditable={false} size="lg" />
                                                    <span className={`text-xl font-bold ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                                                        {tripRating.average}
                                                    </span>
                                                    <span className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>
                                                        ({tripRating.count} {tripRating.count === 1 ? 'review' : 'reviews'})
                                                    </span>
                                                </div>
                                            )}
                                        </div>

                                        {user && !showReviewForm && (
                                            <button
                                                onClick={() => setShowReviewForm(true)}
                                                className="mb-6 bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                                            >
                                                Write a Review
                                            </button>
                                        )}

                                        {showReviewForm && user && (
                                            <div className={`${isDarkMode ? 'bg-slate-800' : 'bg-slate-50'} rounded-xl p-6 mb-6`}>
                                                <h3 className={`text-xl font-bold mb-4 ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>Write Your Review</h3>
                                                <div className="mb-4">
                                                    <label className={`block mb-2 ${isDarkMode ? 'text-slate-300' : 'text-slate-700'}`}>Rating</label>
                                                    <StarRating 
                                                        rating={newReview.rating} 
                                                        onRate={(rating) => setNewReview({...newReview, rating})}
                                                        isEditable={true}
                                                        size="lg"
                                                    />
                                                </div>
                                                <div className="mb-4">
                                                    <input
                                                        type="text"
                                                        placeholder="Review title (optional)"
                                                        value={newReview.title}
                                                        onChange={(e) => setNewReview({...newReview, title: e.target.value})}
                                                        className={`w-full ${inputClasses} border rounded-lg p-3`}
                                                    />
                                                </div>
                                                <div className="mb-4">
                                                    <textarea
                                                        placeholder="Share your experience..."
                                                        value={newReview.comment}
                                                        onChange={(e) => setNewReview({...newReview, comment: e.target.value})}
                                                        rows={4}
                                                        className={`w-full ${inputClasses} border rounded-lg p-3`}
                                                    />
                                                </div>
                                                <div className="flex gap-2">
                                                    <button
                                                        onClick={handleSubmitReview}
                                                        className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg transition-colors"
                                                    >
                                                        Submit Review
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            setShowReviewForm(false);
                                                            setNewReview({ rating: 5, title: '', comment: '' });
                                                        }}
                                                        className={`${isDarkMode ? 'bg-slate-700 hover:bg-slate-600' : 'bg-gray-300 hover:bg-gray-400'} text-white font-bold py-2 px-6 rounded-lg transition-colors`}
                                                    >
                                                        Cancel
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        <div>
                                            <h3 className={`text-2xl font-bold mb-4 ${isDarkMode ? 'text-white' : 'text-slate-900'}`}>
                                                {tripReviews.length > 0 ? 'All Reviews' : 'No Reviews Yet'}
                                            </h3>
                                            {reviewLoading ? (
                                                <div className="flex justify-center items-center h-32">
                                                    <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                                                </div>
                                            ) : tripReviews.length > 0 ? (
                                                <div className="space-y-4">
                                                    {tripReviews.map(review => (
                                                        <ReviewCard key={review.id} review={review} isDarkMode={isDarkMode} />
                                                    ))}
                                                </div>
                                            ) : (
                                                <p className={`${isDarkMode ? 'text-slate-400' : 'text-slate-600'} text-center py-8`}>
                                                    Be the first to review this trip!
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // My Trips Page
        function MyTrips({ user, setCurrentPage, darkMode, setSelectedTrip, setTripToEdit }) {
            const [trips, setTrips] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('all');

            useEffect(() => {
                const fetchTrips = async () => {
                    setLoading(true);
                    const userTrips = await mockApi.getUserTrips(user.id);
                    setTrips(userTrips);
                    setLoading(false);
                };
                fetchTrips();
            }, [user.id]);

            const filteredTrips = useMemo(() => {
                if (filter === 'all') return trips;
                return trips.filter(trip => trip.status === filter);
            }, [trips, filter]);
            
            const handleViewBudget = (trip) => {
                setSelectedTrip(trip);
                setCurrentPage('budget');
            };
            
            const handleEditTrip = (trip) => {
                setTripToEdit(trip);
                setCurrentPage('planner');
            };

            if (loading) return <div className="flex justify-center items-center h-full"><div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div></div>;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'} mb-6`}>My Trips</h1>
                    <div className="mb-6 flex items-center gap-4">
                        <icons.Filter className={darkMode ? 'text-slate-400' : 'text-slate-500'}/>
                        <select onChange={(e) => setFilter(e.target.value)} value={filter} className={`${darkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-100 text-slate-900 border-slate-300'} border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500 focus:outline-none`}>
                            <option value="all">All</option>
                            <option value="private">Private</option>
                            <option value="copied">Copied</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    {filteredTrips.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredTrips.map(trip => <ItineraryCard key={trip.id} trip={trip} isDarkMode={darkMode} onViewBudget={handleViewBudget} onEdit={handleEditTrip} />)}
                        </div>
                    ) : (
                        <div className={`text-center py-16 ${darkMode ? 'bg-slate-800/50' : 'bg-white/50'} rounded-2xl`}>
                            <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>No trips found for this filter.</h2>
                            <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'} mt-2`}>Why not plan a new one?</p>
                            <button onClick={() => setCurrentPage('planner')} className="mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg">Plan a Trip</button>
                        </div>
                    )}
                </div>
            );
        }

        // Budget View Page
        function BudgetView({ trip, setCurrentPage, darkMode, user }) {
            const [editableTrip, setEditableTrip] = useState(trip ? JSON.parse(JSON.stringify(trip)) : null);
            const [newItem, setNewItem] = useState({ day: 1, category: 'Activities', name: '', cost: '' });
            const [toast, setToast] = useState(null);

            useEffect(() => {
                if (trip) {
                    setEditableTrip(JSON.parse(JSON.stringify(trip)));
                }
            }, [trip]);

            const budgetData = useMemo(() => {
                if (!editableTrip || !editableTrip.itinerary) return null;
                
                const breakdown = { Accommodation: 0, Food: 0, Activities: 0, Transportation: 0, Total: 0 };

                editableTrip.itinerary.forEach(day => {
                    breakdown.Accommodation += day.accommodation?.estimated_cost || 0;
                    (day.food || []).forEach(f => breakdown.Food += f.estimated_cost || 0);
                    (day.activities || []).forEach(a => breakdown.Activities += a.estimated_cost || 0);
                    (day.transportation || []).forEach(t => breakdown.Transportation += t.estimated_cost || 0);
                });

                breakdown.Total = breakdown.Accommodation + breakdown.Food + breakdown.Activities + breakdown.Transportation;
                const avgPerDay = breakdown.Total / (editableTrip.duration_days || 1);

                return { breakdown, avgPerDay };
            }, [editableTrip]);
            
            const handleItemAdd = async () => {
                if (!newItem.name || !newItem.cost) {
                    setToast({ message: "Please enter item name and cost.", type: 'error' });
                    return;
                }
                const updatedTrip = JSON.parse(JSON.stringify(editableTrip));
                const dayIndex = updatedTrip.itinerary.findIndex(d => d.day == newItem.day);
                if (dayIndex !== -1) {
                    const categoryKey = newItem.category.toLowerCase();
                    if (!updatedTrip.itinerary[dayIndex][categoryKey]) {
                        updatedTrip.itinerary[dayIndex][categoryKey] = [];
                    }
                    updatedTrip.itinerary[dayIndex][categoryKey].push({ name: newItem.name, estimated_cost: parseFloat(newItem.cost) });
                    
                    setEditableTrip(updatedTrip);
                    await mockApi.saveItinerary(user.id, updatedTrip, updatedTrip.isPublic);
                    setToast({ message: "Item added and trip updated!", type: 'success' });
                    setNewItem({ day: 1, category: 'Activities', name: '', cost: '' });
                }
            };
            
            if (!budgetData || !editableTrip) {
                return (
                    <div className="p-8 text-center">
                        <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>No trip selected.</h2>
                        <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'} mt-2`}>Go to 'My Trips' to view a budget.</p>
                        <button onClick={() => setCurrentPage('myTrips')} className="mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg">Go to My Trips</button>
                    </div>
                );
            }
            
            const { breakdown, avgPerDay } = budgetData;
            const maxCost = Math.max(1, breakdown.Accommodation, breakdown.Food, breakdown.Activities, breakdown.Transportation);

            const Bar = ({ label, value, color }) => (
                <div>
                    <div className="flex justify-between mb-1">
                        <span className="text-base font-medium">{label}</span>
                        <span className={`text-sm font-medium ${darkMode ? 'text-white' : 'text-slate-700'}`}>â‚¹{value.toLocaleString('en-IN')}</span>
                    </div>
                    <div className={`w-full ${darkMode ? 'bg-slate-700' : 'bg-gray-200'} rounded-full h-4`}>
                        <div className={`${color} h-4 rounded-full`} style={{ width: `${(value / maxCost) * 100}%` }}></div>
                    </div>
                </div>
            );
            
            const inputClasses = darkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-100 text-slate-900 border-slate-300';

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    {toast && <Toast message={toast.message} type={toast.type} onDismiss={() => setToast(null)} />}
                    <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'} mb-2`}>Budget for: {editableTrip.title}</h1>
                    <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'} mb-8`}>An estimated cost breakdown for your adventure. Add or remove items to see the budget update in real-time.</p>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-8">
                            <div className={`${darkMode ? 'bg-slate-800/50' : 'bg-white/50'} backdrop-blur-lg p-6 rounded-2xl`}>
                                <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'} mb-6`}>Cost Breakdown</h2>
                                <div className="space-y-4">
                                    <Bar label="Accommodation" value={breakdown.Accommodation} color="bg-blue-500" />
                                    <Bar label="Food" value={breakdown.Food} color="bg-green-500" />
                                    <Bar label="Activities" value={breakdown.Activities} color="bg-yellow-500" />
                                    <Bar label="Transportation" value={breakdown.Transportation} color="bg-red-500" />
                                </div>
                            </div>
                             <div className={`${darkMode ? 'bg-slate-800/50' : 'bg-white/50'} backdrop-blur-lg p-6 rounded-2xl`}>
                                <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'} mb-4`}>Add Expense</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input type="text" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} placeholder="Item Name (e.g., Taxi)" className={`w-full ${inputClasses} border rounded-lg p-3`} />
                                    <input type="number" value={newItem.cost} onChange={e => setNewItem({...newItem, cost: e.target.value})} placeholder="Cost (â‚¹)" className={`w-full ${inputClasses} border rounded-lg p-3`} />
                                    <select value={newItem.day} onChange={e => setNewItem({...newItem, day: e.target.value})} className={`w-full ${inputClasses} border rounded-lg p-3`}>
                                        {editableTrip.itinerary.map(d => <option key={d.day} value={d.day}>Day {d.day}</option>)}
                                    </select>
                                    <select value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})} className={`w-full ${inputClasses} border rounded-lg p-3`}>
                                        <option>Activities</option>
                                        <option>Food</option>
                                        <option>Transportation</option>
                                    </select>
                                </div>
                                <button onClick={handleItemAdd} className="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg">Add Item</button>
                            </div>
                        </div>
                        <div className={`${darkMode ? 'bg-slate-800/50' : 'bg-white/50'} backdrop-blur-lg p-6 rounded-2xl flex flex-col justify-center items-center`}>
                             <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'} mb-4`}>Trip Summary</h2>
                             <div className="text-center">
                                <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>Total Estimated Cost</p>
                                <p className={`text-4xl font-bold text-indigo-400 my-2`}>â‚¹{breakdown.Total.toLocaleString('en-IN')}</p>
                             </div>
                             <div className="text-center mt-4">
                                <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'}`}>Average Cost Per Day</p>
                                <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-800'} my-1`}>â‚¹{avgPerDay.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
                             </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Dashboard Page
        function Dashboard({ user, setCurrentPage, darkMode, setTripToEdit }) {
            const [stats, setStats] = useState({ countries: 0, trips: 0, shared: 0, saved: 0 });
            const [upcomingTrips, setUpcomingTrips] = useState([]);
            const [loading, setLoading] = useState(true);
            const [idea, setIdea] = useState('');
            const [generatedIdea, setGeneratedIdea] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [toast, setToast] = useState(null);

            useEffect(() => {
                const fetchDashboardData = async () => {
                    setLoading(true);
                    const userTrips = await mockApi.getUserTrips(user.id);
                    
                    const countries = new Set();
                    let totalSavings = 0;
                    userTrips.forEach(trip => {
                        countries.add(trip.final_destination || 'Unknown');
                        if (trip.budget_style === 'Budget') {
                            totalSavings += ((trip.duration_days || 1) * 3000);
                        }
                    });

                    setStats({
                        countries: countries.size,
                        trips: userTrips.length,
                        shared: userTrips.filter(t => t.isPublic).length,
                        saved: totalSavings
                    });

                    setUpcomingTrips(userTrips.slice(0, 3));
                    setLoading(false);
                };
                fetchDashboardData();
            }, [user.id]);
            
            const handleGenerateIdea = async () => {
                if (!idea.trim()) {
                    setToast({ message: "Please enter a travel idea.", type: 'error' });
                    return;
                }
                setIsGenerating(true);
                setGeneratedIdea(null);
                try {
                    const prompt = `Generate a single, concise, and exciting travel trip idea for India based on the following user input: "${idea}". The idea should be a short paragraph, highlighting a key destination and a unique activity.`;
                    const result = await geminiApi.generateContent(prompt);
                    setGeneratedIdea(result);
                    setToast({ message: "Inspiration found!", type: 'success' });
                } catch (error) {
                    setToast({ message: "Could not generate an idea. Please try again.", type: 'error' });
                } finally {
                    setIsGenerating(false);
                }
            };

            const StatCard = ({ icon, label, value }) => (
                <div className={`${darkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/50 border-slate-200'} backdrop-blur-lg border rounded-2xl p-5`}>
                    <div className="text-indigo-400 mb-2">{cloneElement(icon, { className: "w-8 h-8" })}</div>
                    <p className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>{value}</p>
                    <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'} text-sm`}>{label}</p>
                </div>
            );

            return (
                <div className="p-4 sm:p-6 lg:p-8 space-y-8">
                    {toast && <Toast message={toast.message} type={toast.type} onDismiss={() => setToast(null)} />}
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div>
                            <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>Welcome back, {user.firstName}! ðŸ‘‹</h1>
                            <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'} mt-1`}>Let's plan your next adventure.</p>
                        </div>
                        <button onClick={() => { setTripToEdit(null); setCurrentPage('planner'); }} className="mt-4 sm:mt-0 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-lg hover:shadow-purple-500/30 flex items-center">
                            <icons.Plus /> <span className="ml-2">Plan New Trip</span>
                        </button>
                    </div>

                    {loading ? <div className="text-center">Loading stats...</div> : (
                         <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <StatCard icon={<icons.MapPin/>} label="Destinations Visited" value={stats.countries} />
                            <StatCard icon={<icons.TrendingUp/>} label="Total Trips Planned" value={stats.trips} />
                            <StatCard icon={<icons.Users/>} label="Shared Plans" value={stats.shared} />
                            <StatCard icon={<icons.Rupee/>} label="Estimated Savings (â‚¹)" value={stats.saved.toLocaleString('en-IN')} />
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 space-y-8">
                            <div>
                                <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'} mb-4`}>Upcoming Trips</h2>
                                <div className="space-y-4">
                                    {loading ? <p>Loading trips...</p> : upcomingTrips.length > 0 ? upcomingTrips.map(trip => (
                                        <ItineraryCard key={trip.id} trip={trip} isDarkMode={darkMode} />
                                    )) : <p className={darkMode ? 'text-slate-400' : 'text-slate-600'}>No upcoming trips. Time to plan one!</p>}
                                </div>
                            </div>
                            <div>
                                <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'} mb-4`}>AI Trip Idea Generator</h2>
                                <div className={`${darkMode ? 'bg-slate-800/50 border-slate-700' : 'bg-white/50 border-slate-200'} backdrop-blur-lg border rounded-2xl p-6`}>
                                    <p className={`${darkMode ? 'text-slate-300' : 'text-slate-700'} mb-4`}>Looking for inspiration? Describe your dream vacation.</p>
                                    <div className="flex flex-col sm:flex-row gap-4">
                                        <input type="text" value={idea} onChange={(e) => setIdea(e.target.value)} placeholder="e.g., a relaxing beach vacation in Goa" className={`flex-grow ${darkMode ? 'bg-slate-700 text-white border-slate-600' : 'bg-slate-100 text-slate-900 border-slate-300'} border rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:outline-none`} />
                                        <button onClick={handleGenerateIdea} disabled={isGenerating} className="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center disabled:opacity-50">
                                            {isGenerating ? <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : "âœ¨ Get Inspiration"}
                                        </button>
                                    </div>
                                    {generatedIdea && (
                                        <div className={`mt-6 p-4 ${darkMode ? 'bg-slate-900 border-indigo-500/50' : 'bg-slate-100 border-indigo-500/20'} rounded-lg border`}>
                                            <p className={darkMode ? 'text-slate-300' : 'text-slate-700'}>{generatedIdea}</p>
                                            <button onClick={() => setCurrentPage('planner')} className="mt-4 text-sm bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors">Plan This Trip</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Community Hub Page
        function CommunityHub({ user, setCurrentPage, darkMode, setTripToEdit }) {
            const [publicTrips, setPublicTrips] = useState([]);
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);

            useEffect(() => {
                const fetchPublicTrips = async () => {
                    setLoading(true);
                    const trips = await mockApi.getPublicTrips('approved');
                    setPublicTrips(trips);
                    setLoading(false);
                };
                fetchPublicTrips();
            }, []);
            
            const handleCopyToMyTrips = (trip) => {
                setToast({ message: "Preparing to copy trip...", type: 'success' });
                const tripCopy = { 
                    ...trip, 
                    status: 'copied', 
                    isPublic: false,
                    startDate: '',
                    endDate: ''
                };
                delete tripCopy.id; 
                delete tripCopy.ownerId;
                setTripToEdit(tripCopy);
                setCurrentPage('planner');
            };

            const handleRequestToJoin = (trip) => {
                setToast({ message: `Request to join "${trip.title}" sent! (Feature coming soon)`, type: 'success' });
            };

            if (loading) return <div className="flex justify-center items-center h-full"><div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"></div></div>;

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    {toast && <Toast message={toast.message} type={toast.type} onDismiss={() => setToast(null)} />}
                    <h1 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'} mb-6`}>Community Hub</h1>
                    <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'} mb-8`}>Explore itineraries shared by other travelers. Get inspired for your next journey!</p>
                    {publicTrips.length > 0 ? (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {publicTrips.map(trip => (
                                <ItineraryCard 
                                    key={trip.id} 
                                    trip={trip} 
                                    onCopy={handleCopyToMyTrips}
                                    onRequestJoin={handleRequestToJoin}
                                    isDarkMode={darkMode}
                                />
                            ))}
                        </div>
                    ) : (
                        <div className={`text-center py-16 ${darkMode ? 'bg-slate-800/50' : 'bg-white/50'} rounded-2xl`}>
                            <h2 className={`text-2xl font-bold ${darkMode ? 'text-white' : 'text-slate-900'}`}>The community hub is quiet...</h2>
                            <p className={`${darkMode ? 'text-slate-400' : 'text-slate-600'} mt-2`}>Be the first to share a public trip!</p>
                        </div>
                    )}
                </div>
            );
        }

        // Chat Page
        function ChatPage() {
            const [messages, setMessages] = useState([
                { role: 'bot', content: 'Hello! I\'m your AI travel assistant. I can help you modify your itinerary or answer any questions about traveling in India!' }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [currentItinerary, setCurrentItinerary] = useState(null);
            const [showAlternatives, setShowAlternatives] = useState(false);
            const [alternatives, setAlternatives] = useState([]);
            const [selectedDay, setSelectedDay] = useState(null);
            const messagesEndRef = useRef(null);
            
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            useEffect(() => {
                // Load the current itinerary and selected day from localStorage if they exist
                const savedItinerary = localStorage.getItem('currentItinerary');
                const savedDay = localStorage.getItem('selectedDay');
                if (savedItinerary) {
                    setCurrentItinerary(JSON.parse(savedItinerary));
                    if (savedDay) {
                        setSelectedDay(parseInt(savedDay, 10));
                        handleGenerateAlternatives(JSON.parse(savedItinerary).days[parseInt(savedDay, 10) - 1]);
                        setShowAlternatives(true);
                        // Clear the selected day after loading
                        localStorage.removeItem('selectedDay');
                    }
                }
            }, []);
            
            const handleGenerateAlternatives = async (currentDay) => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_BASE}/generate-alternatives`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            currentActivity: currentDay.activities,
                            preferences: currentItinerary.preferences || {},
                            destination: currentItinerary.destination
                        })
                    });
                    
                    const data = await response.json();
                    setAlternatives(data.alternatives || [
                        // Fallback alternatives if API fails
                        {
                            title: 'Cultural Experience',
                            description: 'Visit local temples and cultural sites, experience traditional performances'
                        },
                        {
                            title: 'Adventure Activity',
                            description: 'Go hiking, rock climbing, or try local adventure sports'
                        },
                        {
                            title: 'Relaxation Day',
                            description: 'Spend the day at a spa, enjoy local cuisine, and shop at markets'
                        }
                    ]);
                } catch (error) {
                    console.error('Failed to generate alternatives:', error);
                    setMessages(prev => [...prev, {
                        role: 'bot',
                        content: 'Sorry, I had trouble generating alternatives. Please try again.'
                    }]);
                } finally {
                    setLoading(false);
                }
            };

                                            const handleSelectAlternative = (selectedOption) => {
                                                // Keep any images from the original activity if they exist
                                                const originalDay = currentItinerary.days[selectedDay - 1];
                                                const updatedItinerary = {
                                                    ...currentItinerary,
                                                    days: currentItinerary.days.map((day, index) => {
                                                        if (index === selectedDay - 1) {
                                                            return {
                                                                ...day,
                                                                activities: selectedOption.description,
                                                                images: originalDay.images || [], // Preserve existing images
                                                                activityImages: originalDay.activityImages || [] // Preserve activity images
                                                            };
                                                        }
                                                        return day;
                                                    })
                                                };                setCurrentItinerary(updatedItinerary);
                localStorage.setItem('currentItinerary', JSON.stringify(updatedItinerary));
                setShowAlternatives(false);
                setMessages(prev => [...prev, {
                    role: 'bot',
                    content: `I've updated Day ${selectedDay} with the new activity: ${selectedOption.description}`
                }]);
            };
            
            const sendMessage = async () => {
                if (!input.trim()) return;
                
                const userMsg = input;
                setInput('');
                setMessages(prev => [...prev, { role: 'user', content: userMsg }]);
                setLoading(true);
                
                try {
                    const res = await fetch(`${API_BASE}/chatbot`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMsg, language: 'en' })
                    });
                    
                    const data = await res.json();
                    setMessages(prev => [...prev, { 
                        role: 'bot', 
                        content: data.reply || data.fallbackReply || 'Sorry, I encountered an error.' 
                    }]);
                } catch (err) {
                    console.error(err);
                    setMessages(prev => [...prev, { 
                        role: 'bot', 
                        content: 'Unable to connect to AI. Please ensure backend is running.' 
                    }]);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="max-w-4xl mx-auto animate-fade-in">
                    <h2 className="text-3xl font-bold mb-6 dark:text-white">AI Travel Assistant</h2>
                    
                    {/* Current Itinerary Display */}
                    {currentItinerary && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6">
                            <h3 className="text-2xl font-bold mb-4 dark:text-white">{currentItinerary.title || 'Your Itinerary'}</h3>
                            <div className="space-y-6">
                                {currentItinerary.days.map((day, index) => (
                                    <div key={index} className="border-b dark:border-gray-700 pb-6 last:border-0">
                                        <div className="flex items-center justify-between mb-4">
                                            <h4 className="text-lg font-semibold text-blue-600">
                                                Day {index + 1}: {day.title}
                                                <span className="text-gray-500 text-sm ml-2">- {day.location}</span>
                                            </h4>
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        setSelectedDay(index + 1);
                                                        setShowAlternatives(true);
                                                        handleGenerateAlternatives(day);
                                                    }}
                                                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition"
                                                >
                                                    Change Day
                                                </button>
                                                <button 
                                                    className="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-500 transition flex items-center gap-2"
                                                >
                                                    <icons.Search className="w-4 h-4" />
                                                    Find Activities
                                                </button>
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            {/* Activity Images */}
                                            {day.images && day.images.length > 0 && (
                                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                                    {day.images.map((image, imgIdx) => (
                                                        <div key={imgIdx} className="relative h-24 rounded-lg overflow-hidden">
                                                            <img
                                                                src={image}
                                                                alt={`Day ${index + 1} activity`}
                                                                className="w-full h-full object-cover"
                                                                onError={(e) => {
                                                                    e.target.onerror = null;
                                                                    e.target.src = 'https://via.placeholder.com/200x150?text=Image+Not+Available';
                                                                }}
                                                            />
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                            
                                            <div className="space-y-2 text-sm">
                                                <p><strong>Transportation:</strong> {day.transportation}</p>
                                                <p><strong>Activities:</strong> {day.activities}</p>
                                                {day.activityImages && day.activityImages.length > 0 && (
                                                    <div className="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-2">
                                                        {day.activityImages.map((img, imgIdx) => (
                                                            <div key={imgIdx} className="relative h-24 rounded-lg overflow-hidden">
                                                                <img
                                                                    src={img.url || img}
                                                                    alt={img.description || `Activity image ${imgIdx + 1}`}
                                                                    className="w-full h-full object-cover"
                                                                    onError={(e) => {
                                                                        e.target.onerror = null;
                                                                        e.target.src = 'https://via.placeholder.com/200x150?text=Image+Not+Available';
                                                                    }}
                                                                />
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                <p><strong>Food:</strong> {day.food}</p>
                                                <p><strong>Accommodation:</strong> {day.accommodation}</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Alternatives Modal */}
                    {showAlternatives && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4">
                                <h3 className="text-xl font-semibold mb-4 dark:text-white">Alternative Options for Day {selectedDay}</h3>
                                <div className="space-y-4">
                                    {alternatives.map((option, index) => (
                                        <div
                                            key={index}
                                            onClick={() => handleSelectAlternative(option)}
                                            className="p-4 border dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition"
                                        >
                                            <h4 className="font-medium dark:text-white">{option.title}</h4>
                                            <p className="text-gray-600 dark:text-gray-300">{option.description}</p>
                                        </div>
                                    ))}
                                </div>
                                <button
                                    onClick={() => setShowAlternatives(false)}
                                    className="mt-4 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                        {/* Messages */}
                        <div className="h-[500px] overflow-y-auto p-6 space-y-4">
                            {messages.map((msg, idx) => (
                                <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[70%] px-4 py-2 rounded-lg ${
                                        msg.role === 'user'
                                            ? 'bg-red-500 text-white'
                                            : 'bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white'
                                    }`}>
                                        {msg.content}
                                    </div>
                                </div>
                            ))}
                            {loading && (
                                <div className="flex justify-start">
                                    <div className="bg-gray-100 dark:bg-gray-700 px-4 py-2 rounded-lg">
                                        <div className="flex gap-1">
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                            <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        
                        {/* Input */}
                        <div className="border-t dark:border-gray-700 p-4 flex gap-2">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                placeholder="Ask me anything..."
                                className="flex-1 px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            />
                            <button
                                onClick={sendMessage}
                                disabled={loading}
                                className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 disabled:opacity-50 transition flex items-center gap-2"
                            >
                                <icons.Send />
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Community Page with Reviews
        function CommunityPage({ user, darkMode }) {
            const [reviews, setReviews] = useState([]);
            const [showAddReview, setShowAddReview] = useState(false);
            const [selectedPlace, setSelectedPlace] = useState(null);
            const [newReview, setNewReview] = useState({
                title: '',
                rating: 5,
                comment: '',
                image: null
            });
            const [loading, setLoading] = useState(false);
            const fileInputRef = useRef(null);

            const fetchReviews = async () => {
                try {
                    const res = await fetch(`/api/reviews/${selectedPlace?.id || 'all'}`);
                    const data = await res.json();
                    if (data.success) {
                        setReviews(data.reviews);
                    }
                } catch (error) {
                    console.error('Error fetching reviews:', error);
                }
            };

            useEffect(() => {
                fetchReviews();
            }, [selectedPlace]);

            const handleImageSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setNewReview(prev => ({ ...prev, image: file }));
                }
            };

            const handleSubmitReview = async (e) => {
                e.preventDefault();
                if (!user) return;

                setLoading(true);
                const formData = new FormData();
                formData.append('userId', user.id);
                formData.append('placeId', selectedPlace?.id || 'general');
                formData.append('rating', newReview.rating);
                formData.append('title', newReview.title);
                formData.append('comment', newReview.comment);
                if (newReview.image) {
                    formData.append('image', newReview.image);
                }

                try {
                    const res = await fetch('/api/reviews', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.success) {
                        setReviews(prev => [data.review, ...prev]);
                        setShowAddReview(false);
                        setNewReview({ title: '', rating: 5, comment: '', image: null });
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="max-w-4xl mx-auto space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="text-3xl font-bold dark:text-white">Community Reviews</h2>
                        <button
                            onClick={() => setShowAddReview(true)}
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                        >
                            <icons.Plus className="w-5 h-5" />
                            Write a Review
                        </button>
                    </div>

                    {/* Add Review Modal */}
                    {showAddReview && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-2xl mx-4">
                                <h3 className="text-2xl font-bold mb-4 dark:text-white">Write a Review</h3>
                                <form onSubmit={handleSubmitReview} className="space-y-4">
                                    <input
                                        type="text"
                                        value={newReview.title}
                                        onChange={(e) => setNewReview(prev => ({ ...prev, title: e.target.value }))}
                                        placeholder="Review Title"
                                        className="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                        required
                                    />
                                    
                                    <div className="flex items-center gap-2">
                                        {[1, 2, 3, 4, 5].map((star) => (
                                            <button
                                                key={star}
                                                type="button"
                                                onClick={() => setNewReview(prev => ({ ...prev, rating: star }))}
                                                className={`text-2xl ${star <= newReview.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                                            >
                                                â˜…
                                            </button>
                                        ))}
                                    </div>

                                    <textarea
                                        value={newReview.comment}
                                        onChange={(e) => setNewReview(prev => ({ ...prev, comment: e.target.value }))}
                                        placeholder="Write your review..."
                                        className="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white h-32"
                                        required
                                    ></textarea>

                                    <div className="flex items-center gap-4">
                                        <button
                                            type="button"
                                            onClick={() => fileInputRef.current?.click()}
                                            className="px-4 py-2 border rounded-lg dark:border-gray-600 dark:text-white flex items-center gap-2"
                                        >
                                            <icons.Upload className="w-5 h-5" />
                                            Upload Image
                                        </button>
                                        {newReview.image && (
                                            <span className="text-sm text-gray-600 dark:text-gray-300">
                                                {newReview.image.name}
                                            </span>
                                        )}
                                        <input
                                            ref={fileInputRef}
                                            type="file"
                                            accept="image/*"
                                            onChange={handleImageSelect}
                                            className="hidden"
                                        />
                                    </div>

                                    <div className="flex justify-end gap-2">
                                        <button
                                            type="button"
                                            onClick={() => setShowAddReview(false)}
                                            className="px-4 py-2 border rounded-lg dark:border-gray-600 dark:text-white"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            disabled={loading}
                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50"
                                        >
                                            {loading ? 'Submitting...' : 'Submit Review'}
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Reviews List */}
                    <div className="grid gap-6">
                        {reviews.map((review) => (
                            <div key={review.id} className="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <h3 className="text-xl font-semibold dark:text-white">{review.title}</h3>
                                        <div className="flex items-center gap-2 mt-1">
                                            <div className="flex">
                                                {[1, 2, 3, 4, 5].map((star) => (
                                                    <span
                                                        key={star}
                                                        className={`text-lg ${star <= review.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                                                    >
                                                        â˜…
                                                    </span>
                                                ))}
                                            </div>
                                            <span className="text-sm text-gray-500 dark:text-gray-400">
                                                {new Date(review.createdAt).toLocaleDateString()}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                            <icons.ThumbsUp className="w-5 h-5" />
                                        </button>
                                        <span className="text-sm text-gray-500 dark:text-gray-400">{review.likes}</span>
                                    </div>
                                </div>
                                
                                {review.imagePath && (
                                    <div className="mt-4">
                                        <img
                                            src={review.imagePath}
                                            alt="Review"
                                            className="w-full h-64 object-cover rounded-lg"
                                        />
                                    </div>
                                )}
                                
                                <p className="mt-4 text-gray-700 dark:text-gray-300">{review.comment}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Profile Page
        function ProfilePage() {
            return (
                <div className="max-w-4xl mx-auto space-y-6 animate-fade-in">
                    <h2 className="text-3xl font-bold dark:text-white">My Profile</h2>
                    
                    <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                        <div className="flex items-center gap-4 mb-6">
                            <div className="w-20 h-20 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center text-white text-3xl">
                                ðŸ‘¤
                            </div>
                            <div>
                                <h3 className="text-2xl font-bold dark:text-white">Welcome, Traveler!</h3>
                                <p className="text-gray-600 dark:text-gray-400">Member since October 2025</p>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <h4 className="font-semibold mb-2 dark:text-white">Travel Preferences</h4>
                                <select className="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option>Budget Backpacker</option>
                                    <option>Comfort Seeker</option>
                                    <option>Luxury Explorer</option>
                                </select>
                            </div>
                            
                            <div>
                                <h4 className="font-semibold mb-2 dark:text-white">Saved Trips</h4>
                                <div className="space-y-2">
                                    <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <h5 className="font-semibold dark:text-white">Golden Triangle Tour</h5>
                                        <p className="text-sm text-gray-600 dark:text-gray-400">Delhi - Agra - Jaipur | 5 Days</p>
                                    </div>
                                    <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <h5 className="font-semibold dark:text-white">Kerala Backwaters</h5>
                                        <p className="text-sm text-gray-600 dark:text-gray-400">Kochi - Munnar - Alleppey | 7 Days</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Travel Partner Page - Find travel companions
        function TravelPartnerPage({ user, darkMode }) {
            const [currentTab, setCurrentTab] = useState('feed');
            const [posts, setPosts] = useState([]);
            const [lookingPosts, setLookingPosts] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [showJoinModal, setShowJoinModal] = useState(false);
            const [showPlanModal, setShowPlanModal] = useState(false);
            const [selectedPost, setSelectedPost] = useState(null);
            const [selectedPlan, setSelectedPlan] = useState(null);
            const [pendingRequestsCount, setPendingRequestsCount] = useState(0);
            const [joinRequests, setJoinRequests] = useState([]);
            const [formData, setFormData] = useState({
                destination: '',
                startDate: '',
                endDate: '',
                tripType: 'Leisure',
                budget: 'Moderate',
                description: '',
                allowMultiple: true,
                maxParticipants: 10
            });
            const [joinMessage, setJoinMessage] = useState('');
            const [filters, setFilters] = useState({ destination: '', tripType: '' });

            const currentUserId = user?.id || localStorage.getItem('currentUserId') || `user_${Date.now()}`;
            const currentUserName = `${user?.firstName || 'User'} ${user?.lastName || ''}`.trim();

            // Load posts on mount and tab change
            useEffect(() => {
                if (currentTab === 'feed') loadFeed();
                else if (currentTab === 'looking') loadLookingPosts();
                else if (currentTab === 'requests') loadJoinRequests();
                else if (currentTab === 'my-trips') loadMyTrips();
            }, [currentTab]);

            // Check pending requests on mount
            useEffect(() => {
                checkPendingRequests();
            }, []);

            const loadFeed = async () => {
                setLoading(true);
                try {
                    let url = `${API_BASE}/travel-posts?`;
                    if (filters.destination) url += `destination=${encodeURIComponent(filters.destination)}&`;
                    if (filters.tripType) url += `tripType=${encodeURIComponent(filters.tripType)}&`;
                    
                    const response = await axios.get(url);
                    const postsData = response.data.posts || [];
                    
                    // Load join requests for posts owned by current user
                    for (const post of postsData) {
                        if (post.userId === currentUserId) {
                            try {
                                const reqRes = await axios.get(`${API_BASE}/travel-posts/${post.id}/join-requests?userId=${currentUserId}`);
                                post.joinRequests = reqRes.data.requests || [];
                            } catch (err) {
                                post.joinRequests = [];
                            }
                        }
                    }
                    
                    setPosts(postsData);
                } catch (error) {
                    console.error('Failed to load feed:', error);
                }
                setLoading(false);
            };

            const loadLookingPosts = async () => {
                setLoading(true);
                try {
                    const response = await axios.get(`${API_BASE}/travel-posts/looking-to-join`);
                    setLookingPosts(response.data.posts || []);
                } catch (error) {
                    console.error('Failed to load looking posts:', error);
                }
                setLoading(false);
            };

            const loadMyTrips = async () => {
                setLoading(true);
                try {
                    const response = await axios.get(`${API_BASE}/travel-posts?userId=${currentUserId}`);
                    setPosts(response.data.posts || []);
                } catch (error) {
                    console.error('Failed to load my trips:', error);
                }
                setLoading(false);
            };

            const loadJoinRequests = async () => {
                setLoading(true);
                try {
                    const response = await axios.get(`${API_BASE}/travel-posts?userId=${currentUserId}`);
                    const myPosts = response.data.posts || [];
                    
                    let allRequests = [];
                    for (const post of myPosts) {
                        try {
                            const reqRes = await axios.get(`${API_BASE}/travel-posts/${post.id}/join-requests?userId=${currentUserId}`);
                            const requests = (reqRes.data.requests || []).map(r => ({ ...r, post }));
                            allRequests = allRequests.concat(requests);
                        } catch (err) {
                            console.error('Failed to load requests for post', post.id);
                        }
                    }
                    
                    setJoinRequests(allRequests);
                    setPendingRequestsCount(allRequests.filter(r => r.status === 'pending').length);
                } catch (error) {
                    console.error('Failed to load join requests:', error);
                }
                setLoading(false);
            };

            const checkPendingRequests = async () => {
                try {
                    const response = await axios.get(`${API_BASE}/travel-posts?userId=${currentUserId}`);
                    const myPosts = response.data.posts || [];
                    
                    let total = 0;
                    for (const post of myPosts) {
                        try {
                            const reqRes = await axios.get(`${API_BASE}/travel-posts/${post.id}/join-requests?userId=${currentUserId}`);
                            total += (reqRes.data.requests || []).filter(r => r.status === 'pending').length;
                        } catch (err) {}
                    }
                    setPendingRequestsCount(total);
                } catch (error) {
                    console.error('Failed to check pending requests:', error);
                }
            };

            const createPost = async (e) => {
                e.preventDefault();
                try {
                    await axios.post(`${API_BASE}/travel-posts`, {
                        ...formData,
                        userId: currentUserId,
                        userName: currentUserName
                    });
                    setShowCreateModal(false);
                    setFormData({
                        destination: '',
                        startDate: '',
                        endDate: '',
                        tripType: 'Leisure',
                        budget: 'Moderate',
                        description: '',
                        allowMultiple: true,
                        maxParticipants: 10
                    });
                    loadFeed();
                } catch (error) {
                    console.error('Failed to create post:', error);
                    alert('Failed to create post');
                }
            };

            const sendJoinRequest = async () => {
                if (!selectedPost) return;
                try {
                    await axios.post(`${API_BASE}/travel-posts/${selectedPost.id}/join-request`, {
                        userId: currentUserId,
                        userName: currentUserName,
                        message: joinMessage
                    });
                    setShowJoinModal(false);
                    setJoinMessage('');
                    setSelectedPost(null);
                    alert('Join request sent!');
                    loadFeed();
                } catch (error) {
                    console.error('Failed to send request:', error);
                    alert(error.response?.data?.error || 'Failed to send request');
                }
            };

            const respondToRequest = async (postId, requestId, action) => {
                try {
                    await axios.post(`${API_BASE}/travel-posts/${postId}/join-requests/${requestId}/respond`, {
                        action,
                        userId: currentUserId
                    });
                    loadJoinRequests();
                    loadFeed();
                    checkPendingRequests();
                } catch (error) {
                    console.error('Failed to respond:', error);
                    alert(error.response?.data?.error || 'Failed to respond');
                }
            };

            const viewSharedPlan = async (postId) => {
                try {
                    const response = await axios.get(`${API_BASE}/travel-posts/${postId}/plan?userId=${currentUserId}`);
                    setSelectedPlan({ plan: response.data.plan, post: response.data.post });
                    setShowPlanModal(true);
                } catch (error) {
                    console.error('Failed to load plan:', error);
                    alert(error.response?.data?.error || 'Failed to load plan');
                }
            };

            const generateItinerary = async (postId, post) => {
                try {
                    const start = new Date(post.startDate);
                    const end = new Date(post.endDate);
                    const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                    
                    await axios.post(`${API_BASE}/travel-posts/${postId}/itinerary`, {
                        userId: currentUserId,
                        destination: post.destination,
                        startDate: post.startDate,
                        endDate: post.endDate,
                        days,
                        tripType: post.tripType,
                        budget: post.budget
                    });
                    
                    viewSharedPlan(postId);
                } catch (error) {
                    console.error('Failed to generate itinerary:', error);
                    alert('Failed to generate itinerary');
                }
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            };

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-6 text-white">
                        <h1 className="text-3xl font-bold mb-2">ðŸ‘¥ Find Your Perfect Travel Partner</h1>
                        <p className="text-indigo-100">Connect with fellow travelers and plan amazing trips together!</p>
                    </div>

                    {/* Tabs */}
                    <div className="flex flex-wrap gap-2 border-b border-gray-200 dark:border-gray-700 pb-2">
                        {[
                            { id: 'feed', label: 'Community Feed', icon: 'ðŸŒ' },
                            { id: 'create', label: 'Create Post', icon: 'âœï¸' },
                            { id: 'requests', label: 'Join Requests', icon: 'ðŸ””', badge: pendingRequestsCount },
                            { id: 'looking', label: 'Looking to Join', icon: 'ðŸ”' },
                            { id: 'my-trips', label: 'My Trips', icon: 'ðŸ“‹' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => tab.id === 'create' ? setShowCreateModal(true) : setCurrentTab(tab.id)}
                                className={`px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 relative ${
                                    currentTab === tab.id
                                        ? 'bg-indigo-600 text-white'
                                        : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                                }`}
                            >
                                <span>{tab.icon}</span>
                                <span>{tab.label}</span>
                                {tab.badge > 0 && (
                                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                        {tab.badge > 99 ? '99+' : tab.badge}
                                    </span>
                                )}
                            </button>
                        ))}
                    </div>

                    {/* Filters (for feed) */}
                    {currentTab === 'feed' && (
                        <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input
                                    type="text"
                                    placeholder="Search destination..."
                                    value={filters.destination}
                                    onChange={(e) => setFilters({ ...filters, destination: e.target.value })}
                                    className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                />
                                <select
                                    value={filters.tripType}
                                    onChange={(e) => setFilters({ ...filters, tripType: e.target.value })}
                                    className="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                >
                                    <option value="">All Trip Types</option>
                                    <option value="Leisure">Leisure</option>
                                    <option value="Adventure">Adventure</option>
                                    <option value="Cultural">Cultural</option>
                                    <option value="Business">Business</option>
                                    <option value="Family">Family</option>
                                </select>
                                <button
                                    onClick={loadFeed}
                                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                >
                                    Apply Filters
                                </button>
                                <button
                                    onClick={() => { setFilters({ destination: '', tripType: '' }); loadFeed(); }}
                                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300"
                                >
                                    Clear
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Content */}
                    {loading ? (
                        <div className="text-center py-12">
                            <div className="animate-spin text-4xl mb-4">ðŸ”„</div>
                            <p className="text-gray-500 dark:text-gray-400">Loading...</p>
                        </div>
                    ) : (
                        <>
                            {/* Feed Tab */}
                            {currentTab === 'feed' && (
                                <div className="space-y-6">
                                    {posts.length === 0 ? (
                                        <div className="text-center py-12 bg-white dark:bg-gray-800 rounded-lg">
                                            <div className="text-6xl mb-4">ðŸŒ</div>
                                            <p className="text-gray-500 dark:text-gray-400">No travel posts found. Be the first to create one!</p>
                                            <button
                                                onClick={() => setShowCreateModal(true)}
                                                className="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                            >
                                                Create Post
                                            </button>
                                        </div>
                                    ) : posts.map(post => {
                                        const isOwner = post.userId === currentUserId;
                                        const isMember = post.joinedUsers?.includes(currentUserId);
                                        const pendingReqs = (post.joinRequests || []).filter(r => r.status === 'pending');
                                        
                                        return (
                                            <div key={post.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 hover:shadow-lg transition">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <h3 className="text-xl font-bold text-gray-800 dark:text-gray-200">ðŸ“ {post.destination}</h3>
                                                        <p className="text-sm text-gray-500 dark:text-gray-400">by {post.userName} â€¢ {formatDate(post.createdAt)}</p>
                                                    </div>
                                                    <span className="px-3 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-full text-sm">
                                                        {post.tripType}
                                                    </span>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                                                    <div>
                                                        <span className="text-gray-500 dark:text-gray-400">ðŸ“… Dates:</span>
                                                        <p className="font-medium text-gray-800 dark:text-gray-200">{formatDate(post.startDate)} - {formatDate(post.endDate)}</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 dark:text-gray-400">ðŸ’° Budget:</span>
                                                        <p className="font-medium text-gray-800 dark:text-gray-200">{post.budget}</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 dark:text-gray-400">ðŸ‘¥ Members:</span>
                                                        <p className="font-medium text-gray-800 dark:text-gray-200">{post.joinedUsers?.length || 1}/{post.maxParticipants}</p>
                                                    </div>
                                                    <div>
                                                        <span className="text-gray-500 dark:text-gray-400">ðŸ“¬ Requests:</span>
                                                        <p className="font-medium text-gray-800 dark:text-gray-200">{pendingReqs.length} pending</p>
                                                    </div>
                                                </div>
                                                
                                                <p className="text-gray-700 dark:text-gray-300 mb-4">{post.description}</p>
                                                
                                                {/* Inline Join Requests for Owner */}
                                                {isOwner && pendingReqs.length > 0 && (
                                                    <div className="mb-4 p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
                                                        <h4 className="font-bold text-gray-800 dark:text-gray-200 mb-3 flex items-center">
                                                            <span className="w-2 h-2 bg-yellow-500 rounded-full mr-2 animate-pulse"></span>
                                                            Join Requests ({pendingReqs.length})
                                                        </h4>
                                                        <div className="space-y-2">
                                                            {pendingReqs.slice(0, 3).map(req => (
                                                                <div key={req.id} className="bg-white dark:bg-gray-700 p-3 rounded border border-gray-200 dark:border-gray-600 flex justify-between items-center">
                                                                    <div>
                                                                        <p className="font-semibold text-gray-800 dark:text-gray-200">{req.userName}</p>
                                                                        {req.message && <p className="text-sm text-gray-600 dark:text-gray-400 italic">"{req.message}"</p>}
                                                                    </div>
                                                                    <div className="flex gap-2">
                                                                        <button
                                                                            onClick={() => respondToRequest(post.id, req.id, 'accept')}
                                                                            className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                                                                        >
                                                                            âœ“
                                                                        </button>
                                                                        <button
                                                                            onClick={() => respondToRequest(post.id, req.id, 'reject')}
                                                                            className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                                                                        >
                                                                            âœ—
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                <div className="flex gap-3">
                                                    {(isOwner || isMember) ? (
                                                        <button
                                                            onClick={() => viewSharedPlan(post.id)}
                                                            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                                        >
                                                            ðŸ—ºï¸ Plan Trip
                                                        </button>
                                                    ) : (
                                                        <button
                                                            onClick={() => { setSelectedPost(post); setShowJoinModal(true); }}
                                                            className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                                        >
                                                            âœ‰ï¸ Request to Join
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* Requests Tab */}
                            {currentTab === 'requests' && (
                                <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                                    <h2 className="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-200">ðŸ”” Manage Join Requests</h2>
                                    {joinRequests.length === 0 ? (
                                        <div className="text-center py-12">
                                            <div className="text-6xl mb-4">ðŸ“­</div>
                                            <p className="text-gray-500 dark:text-gray-400">No join requests yet.</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            {joinRequests.filter(r => r.status === 'pending').map(req => (
                                                <div key={req.id} className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border-l-4 border-yellow-500">
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <div className="w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-bold">
                                                                    {(req.userName || 'U').charAt(0).toUpperCase()}
                                                                </div>
                                                                <div>
                                                                    <p className="font-semibold text-gray-800 dark:text-gray-200">{req.userName}</p>
                                                                    <p className="text-xs text-gray-500">{formatDate(req.createdAt)}</p>
                                                                </div>
                                                            </div>
                                                            <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                                                Wants to join: <strong>{req.post?.destination}</strong>
                                                            </p>
                                                            {req.message && <p className="text-gray-700 dark:text-gray-300 italic">"{req.message}"</p>}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => respondToRequest(req.post.id, req.id, 'accept')}
                                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                                            >
                                                                âœ“ Accept
                                                            </button>
                                                            <button
                                                                onClick={() => respondToRequest(req.post.id, req.id, 'reject')}
                                                                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                                                            >
                                                                âœ— Reject
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Looking to Join Tab */}
                            {currentTab === 'looking' && (
                                <div className="space-y-4">
                                    {lookingPosts.length === 0 ? (
                                        <div className="text-center py-12 bg-white dark:bg-gray-800 rounded-lg">
                                            <div className="text-6xl mb-4">ðŸ”</div>
                                            <p className="text-gray-500 dark:text-gray-400">No one is looking to join trips right now.</p>
                                        </div>
                                    ) : lookingPosts.map(post => (
                                        <div key={post.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <h4 className="font-bold text-gray-800 dark:text-gray-200">{post.userName}</h4>
                                                <span className="text-sm text-gray-500">{formatDate(post.createdAt)}</span>
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">
                                                <strong>Destination:</strong> {post.destination} â€¢ 
                                                <strong> Dates:</strong> {post.preferredDates} â€¢ 
                                                <strong> Type:</strong> {post.tripType}
                                            </p>
                                            <p className="text-gray-700 dark:text-gray-300">{post.description}</p>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {/* My Trips Tab */}
                            {currentTab === 'my-trips' && (
                                <div className="space-y-4">
                                    {posts.length === 0 ? (
                                        <div className="text-center py-12 bg-white dark:bg-gray-800 rounded-lg">
                                            <div className="text-6xl mb-4">ðŸ“‹</div>
                                            <p className="text-gray-500 dark:text-gray-400">You haven't created any trips yet.</p>
                                            <button
                                                onClick={() => setShowCreateModal(true)}
                                                className="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                                            >
                                                Create Your First Trip
                                            </button>
                                        </div>
                                    ) : posts.map(post => (
                                        <div key={post.id} className="bg-white dark:bg-gray-800 rounded-lg shadow p-4 flex justify-between items-center">
                                            <div>
                                                <h3 className="font-bold text-gray-800 dark:text-gray-200">ðŸ“ {post.destination}</h3>
                                                <p className="text-sm text-gray-500">{formatDate(post.startDate)} - {formatDate(post.endDate)}</p>
                                            </div>
                                            <button
                                                onClick={() => viewSharedPlan(post.id)}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                            >
                                                ðŸ—ºï¸ Plan Trip
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </>
                    )}

                    {/* Create Post Modal */}
                    {showCreateModal && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">âœï¸ Create Travel Post</h3>
                                <form onSubmit={createPost} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Destination *</label>
                                        <input
                                            type="text"
                                            required
                                            value={formData.destination}
                                            onChange={(e) => setFormData({ ...formData, destination: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                            placeholder="e.g., Goa, Kerala"
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Start Date *</label>
                                            <input
                                                type="date"
                                                required
                                                value={formData.startDate}
                                                onChange={(e) => setFormData({ ...formData, startDate: e.target.value })}
                                                className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">End Date *</label>
                                            <input
                                                type="date"
                                                required
                                                value={formData.endDate}
                                                onChange={(e) => setFormData({ ...formData, endDate: e.target.value })}
                                                className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                            />
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Trip Type</label>
                                            <select
                                                value={formData.tripType}
                                                onChange={(e) => setFormData({ ...formData, tripType: e.target.value })}
                                                className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                            >
                                                <option value="Leisure">Leisure</option>
                                                <option value="Adventure">Adventure</option>
                                                <option value="Cultural">Cultural</option>
                                                <option value="Business">Business</option>
                                                <option value="Family">Family</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Budget</label>
                                            <select
                                                value={formData.budget}
                                                onChange={(e) => setFormData({ ...formData, budget: e.target.value })}
                                                className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                            >
                                                <option value="Budget-friendly">Budget-friendly</option>
                                                <option value="Moderate">Moderate</option>
                                                <option value="Luxury">Luxury</option>
                                                <option value="Flexible">Flexible</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Max Participants</label>
                                        <input
                                            type="number"
                                            min="2"
                                            max="20"
                                            value={formData.maxParticipants}
                                            onChange={(e) => setFormData({ ...formData, maxParticipants: parseInt(e.target.value) })}
                                            className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Description *</label>
                                        <textarea
                                            required
                                            rows="3"
                                            value={formData.description}
                                            onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                                            className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white"
                                            placeholder="Tell others about your trip plans..."
                                        />
                                    </div>
                                    <div className="flex gap-4">
                                        <button type="submit" className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                            Create Post
                                        </button>
                                        <button type="button" onClick={() => setShowCreateModal(false)} className="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Join Request Modal */}
                    {showJoinModal && selectedPost && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
                                <h3 className="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">âœ‰ï¸ Send Join Request</h3>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">
                                    Request to join the trip to <strong>{selectedPost.destination}</strong>
                                </p>
                                <textarea
                                    rows="3"
                                    value={joinMessage}
                                    onChange={(e) => setJoinMessage(e.target.value)}
                                    className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white mb-4"
                                    placeholder="Tell them why you'd like to join (optional)..."
                                />
                                <div className="flex gap-4">
                                    <button onClick={sendJoinRequest} className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                        Send Request
                                    </button>
                                    <button onClick={() => { setShowJoinModal(false); setSelectedPost(null); setJoinMessage(''); }} className="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Shared Plan Modal */}
                    {showPlanModal && selectedPlan && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h3 className="text-2xl font-bold text-gray-800 dark:text-gray-200">ðŸ—ºï¸ Trip Plan: {selectedPlan.post.destination}</h3>
                                        <p className="text-gray-500">{formatDate(selectedPlan.post.startDate)} - {formatDate(selectedPlan.post.endDate)}</p>
                                    </div>
                                    <button onClick={() => { setShowPlanModal(false); setSelectedPlan(null); }} className="text-gray-500 hover:text-gray-700 text-2xl">
                                        Ã—
                                    </button>
                                </div>
                                
                                {/* Members */}
                                <div className="mb-6">
                                    <h4 className="font-bold text-gray-800 dark:text-gray-200 mb-2">ðŸ‘¥ Trip Members ({selectedPlan.plan.members.length})</h4>
                                    <div className="flex flex-wrap gap-2">
                                        {selectedPlan.plan.members.map((memberId, idx) => (
                                            <span key={memberId} className="px-3 py-1 bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 rounded-full text-sm">
                                                {memberId === selectedPlan.post.userId ? 'Owner' : `Member ${idx + 1}`}
                                                {memberId === currentUserId && ' (You)'}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Itinerary */}
                                <div className="mb-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="font-bold text-gray-800 dark:text-gray-200">ðŸ“… Itinerary</h4>
                                        {!selectedPlan.plan.itinerary && (
                                            <button
                                                onClick={() => generateItinerary(selectedPlan.post.id, selectedPlan.post)}
                                                className="px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:from-indigo-700 hover:to-purple-700 text-sm"
                                            >
                                                âœ¨ Generate AI Itinerary
                                            </button>
                                        )}
                                    </div>
                                    {selectedPlan.plan.itinerary ? (
                                        <div className="space-y-4">
                                            {selectedPlan.plan.itinerary.days?.map((day, idx) => (
                                                <div key={idx} className="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden">
                                                    <div className="bg-indigo-50 dark:bg-indigo-900/30 px-4 py-2 border-b border-gray-200 dark:border-gray-600">
                                                        <h5 className="font-bold text-indigo-800 dark:text-indigo-200">Day {idx + 1}: {day.title}</h5>
                                                    </div>
                                                    <div className="p-4 space-y-2">
                                                        {(day.activities || []).map((activity, aIdx) => (
                                                            <div key={aIdx} className="flex gap-3">
                                                                <span className="text-sm text-gray-500 w-16">{activity.time}</span>
                                                                <div>
                                                                    <p className="font-medium text-gray-800 dark:text-gray-200">{activity.name}</p>
                                                                    {activity.description && <p className="text-sm text-gray-600 dark:text-gray-400">{activity.description}</p>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                            {selectedPlan.plan.itinerary.tips && (
                                                <div className="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                                    <h5 className="font-bold text-yellow-800 dark:text-yellow-200 mb-2">ðŸ’¡ Tips</h5>
                                                    <p className="text-yellow-700 dark:text-yellow-300 text-sm">{selectedPlan.plan.itinerary.tips}</p>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                                            <div className="text-4xl mb-2">ðŸ“…</div>
                                            <p>No itinerary created yet. Click "Generate AI Itinerary" to create one!</p>
                                        </div>
                                    )}
                                </div>
                                
                                {/* Activities */}
                                <div className="mb-6">
                                    <h4 className="font-bold text-gray-800 dark:text-gray-200 mb-2">ðŸ“‹ Activities</h4>
                                    {selectedPlan.plan.activities?.length > 0 ? (
                                        <div className="space-y-2">
                                            {selectedPlan.plan.activities.map((a, idx) => (
                                                <div key={idx} className="p-3 bg-gray-50 dark:bg-gray-700 rounded">
                                                    <p className="text-gray-800 dark:text-gray-200">{a.title || a.name}</p>
                                                    {a.description && <p className="text-sm text-gray-600 dark:text-gray-400">{a.description}</p>}
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-gray-500 dark:text-gray-400 text-sm">No activities added yet.</p>
                                    )}
                                </div>
                                
                                <button onClick={() => { setShowPlanModal(false); setSelectedPlan(null); }} className="w-full px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Cultural Insights Page (NEW!)
        function CulturalInsightsPage() {
            const [destination, setDestination] = useState('');
            const [language, setLanguage] = useState('en');
            const [insights, setInsights] = useState(null);
            const [loading, setLoading] = useState(false);
            
            const loadCulturalInsights = async () => {
                if (!destination) {
                    alert('Please enter a destination');
                    return;
                }
                
                setLoading(true);
                
                try {
                    console.log('Fetching cultural insights for:', destination);
                    const res = await fetch(`${API_BASE}/cultural/insights`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ destination, language })
                    });
                    
                    console.log('Response status:', res.status);
                    
                    if (!res.ok) {
                        if (res.status === 404) {
                            alert('Cultural Insights endpoint not found.\n\nPlease restart the backend:\n1. Close backend terminal\n2. Double-click RESTART_BACKEND.bat\n3. Wait for "Cultural Insights" to appear in endpoints list\n4. Try again');
                            return;
                        }
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    
                    const data = await res.json();
                    console.log('Cultural insights data:', data);
                    
                    if (data.success) {
                        setInsights(data.culturalInsights);
                    } else {
                        alert(`Failed: ${data.error || 'Unknown error'}\n\nCheck browser console for details.`);
                    }
                } catch (err) {
                    console.error('Cultural insights error:', err);
                    alert(`Error: ${err.message}\n\nIf endpoint not found, restart backend:\nâ†’ Double-click RESTART_BACKEND.bat`);
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="max-w-6xl mx-auto space-y-6 animate-fade-in">
                    <h2 className="text-3xl font-bold dark:text-white flex items-center gap-2">
                        <span>ðŸŽ­</span> Cultural Insights
                    </h2>
                    
                    {/* Search Section */}
                    <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                        <div className="flex gap-4">
                            <input
                                type="text"
                                value={destination}
                                onChange={(e) => setDestination(e.target.value)}
                                placeholder="Enter destination (e.g., Varanasi, Jaipur, Kerala)"
                                className="flex-1 px-4 py-3 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            />
                            <select
                                value={language}
                                onChange={(e) => setLanguage(e.target.value)}
                                className="px-4 py-3 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                            >
                                <option value="en">English</option>
                                <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                                <option value="ta">à®¤à®®à®¿à®´à¯</option>
                            </select>
                            <button
                                onClick={loadCulturalInsights}
                                disabled={loading}
                                className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:shadow-lg disabled:opacity-50 transition"
                            >
                                {loading ? 'ðŸ” Loading...' : 'ðŸŽ­ Explore Culture'}
                            </button>
                        </div>
                    </div>
                    
                    {/* Cultural Insights Display */}
                    {insights && (
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Festivals */}
                            {insights.festivals && Array.isArray(insights.festivals) && insights.festivals.length > 0 && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-xl font-bold mb-4 text-purple-600 dark:text-purple-400 flex items-center gap-2">
                                        ðŸŽ‰ Festivals & Events
                                    </h3>
                                    <div className="space-y-2">
                                        {insights.festivals.map((festival, idx) => (
                                            <div key={idx} className="p-3 bg-purple-50 dark:bg-gray-700 rounded-lg">
                                                <p className="text-sm dark:text-white">{festival}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Customs & Traditions */}
                            {insights.customs && Array.isArray(insights.customs) && insights.customs.length > 0 && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-xl font-bold mb-4 text-orange-600 dark:text-orange-400 flex items-center gap-2">
                                        ðŸ™ Customs & Traditions
                                    </h3>
                                    <div className="space-y-2">
                                        {insights.customs.map((custom, idx) => (
                                            <div key={idx} className="flex items-start gap-2 text-sm dark:text-gray-300">
                                                <span>â€¢</span>
                                                <span>{custom}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Etiquette */}
                            {insights.etiquette && typeof insights.etiquette === 'object' && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-xl font-bold mb-4 text-green-600 dark:text-green-400 flex items-center gap-2">
                                        âœ… Do's & Don'ts
                                    </h3>
                                    <div className="space-y-3 text-sm">
                                        {insights.etiquette.dos && Array.isArray(insights.etiquette.dos) && (
                                            <div className="p-3 bg-green-50 dark:bg-green-900/20 rounded">
                                                <p className="font-semibold text-green-700 dark:text-green-400 mb-2">âœ… Do:</p>
                                                {insights.etiquette.dos.map((item, idx) => (
                                                    <p key={idx} className="dark:text-gray-300">â€¢ {item}</p>
                                                ))}
                                            </div>
                                        )}
                                        {insights.etiquette.donts && Array.isArray(insights.etiquette.donts) && (
                                            <div className="p-3 bg-red-50 dark:bg-red-900/20 rounded">
                                                <p className="font-semibold text-red-700 dark:text-red-400 mb-2">âŒ Don't:</p>
                                                {insights.etiquette.donts.map((item, idx) => (
                                                    <p key={idx} className="dark:text-gray-300">â€¢ {item}</p>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            
                            {/* Language Phrases */}
                            {insights.language && Array.isArray(insights.language) && insights.language.length > 0 && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-xl font-bold mb-4 text-blue-600 dark:text-blue-400 flex items-center gap-2">
                                        ðŸ’¬ Useful Phrases
                                    </h3>
                                    <div className="space-y-2">
                                        {insights.language.map((phrase, idx) => (
                                            <div key={idx} className="p-2 bg-blue-50 dark:bg-gray-700 rounded">
                                                <p className="text-sm dark:text-white">{phrase}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Food Culture */}
                            {insights.food && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6 md:col-span-2">
                                    <h3 className="text-xl font-bold mb-4 text-red-600 dark:text-red-400 flex items-center gap-2">
                                        ðŸ² Food & Dining Culture
                                    </h3>
                                    <p className="text-sm dark:text-gray-300">
                                        {typeof insights.food === 'string' ? insights.food : Array.isArray(insights.food) ? insights.food.join(' ') : 'Food culture information'}
                                    </p>
                                </div>
                            )}
                            
                            {/* Tips */}
                            {insights.tips && Array.isArray(insights.tips) && insights.tips.length > 0 && (
                                <div className="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-gray-700 dark:to-gray-600 rounded-xl p-6 md:col-span-2 border-l-4 border-yellow-500">
                                    <h3 className="text-xl font-bold mb-4 dark:text-white flex items-center gap-2">
                                        ðŸ’¡ Cultural Tips
                                    </h3>
                                    <div className="space-y-2">
                                        {insights.tips.map((tip, idx) => (
                                            <p key={idx} className="text-sm dark:text-gray-200">â€¢ {tip}</p>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    
                    {!insights && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl p-12 text-center">
                            <div className="text-6xl mb-4">ðŸŽ­</div>
                            <h3 className="text-xl font-semibold mb-2 dark:text-white">Discover Cultural Insights</h3>
                            <p className="text-gray-600 dark:text-gray-400">
                                Enter a destination above to learn about local festivals, customs, etiquette, and traditions
                            </p>
                        </div>
                    )}
                </div>
            );
        }

        // Smart Planner Page (NEW!)
        function SmartPlannerPage() {
            const [destinations, setDestinations] = useState(['']);
            const [duration, setDuration] = useState(7);
            const [budget, setBudget] = useState('');
            const [interests, setInterests] = useState([]);
            const [numberOfPeople, setNumberOfPeople] = useState(1);
            const [smartPlan, setSmartPlan] = useState(null);
            const [budgetBreakdown, setBudgetBreakdown] = useState(null);
            const [ecoScore, setEcoScore] = useState(null);
            const [loading, setLoading] = useState(false);
            
            const addDestination = () => {
                setDestinations([...destinations, '']);
            };
            
            const updateDestination = (index, value) => {
                const newDest = [...destinations];
                newDest[index] = value;
                setDestinations(newDest);
            };
            
            const removeDestination = (index) => {
                if (destinations.length > 1) {
                    setDestinations(destinations.filter((_, i) => i !== index));
                }
            };
            
            const toggleInterest = (interest) => {
                setInterests(prev =>
                    prev.includes(interest) ? prev.filter(i => i !== interest) : [...prev, interest]
                );
            };
            
            const generateSmartPlan = async () => {
                const validDest = destinations.filter(d => d.trim());
                if (validDest.length === 0 || interests.length === 0) {
                    alert('Please add destinations and select interests');
                    return;
                }
                
                setLoading(true);
                
                try {
                    console.log('Generating smart plan for:', validDest);
                    const res = await fetch(`${API_BASE}/planner/smart`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            destinations: validDest,
                            duration,
                            budget,
                            interests,
                            preferences: { numberOfPeople }
                        })
                    });
                    
                    if (!res.ok) {
                        if (res.status === 404) {
                            alert('Smart Planner endpoint not found.\n\nRestart backend: Double-click RESTART_BACKEND.bat');
                            setLoading(false);
                            return;
                        }
                        throw new Error(`HTTP ${res.status}`);
                    }
                    
                    const data = await res.json();
                    console.log('Smart plan full response:', data);
                    console.log('Smart plan object:', data.smartPlan);
                    console.log('Recommendations type:', typeof data.smartPlan.recommendations);
                    console.log('Recommendations value:', data.smartPlan.recommendations);
                    
                    if (data.success) {
                        setSmartPlan(data.smartPlan);
                        
                        // Calculate budget breakdown
                        const budgetRes = await fetch(`${API_BASE}/budget/calculate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                itinerary: data.smartPlan,
                                numberOfPeople,
                                splitEqually: true
                            })
                        });
                        const budgetData = await budgetRes.json();
                        if (budgetData.success) {
                            setBudgetBreakdown(budgetData.budgetBreakdown);
                        }
                        
                        // Get eco score if multiple destinations
                        if (validDest.length > 1) {
                            const ecoRes = await fetch(`${API_BASE}/eco/routes`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    origin: validDest[0],
                                    destination: validDest[validDest.length - 1]
                                })
                            });
                            const ecoData = await ecoRes.json();
                            if (ecoData.success) {
                                setEcoScore(ecoData.ecoRoutes);
                            }
                        }
                    }
                } catch (err) {
                    console.error(err);
                    alert('Error generating smart plan');
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="max-w-6xl mx-auto space-y-6 animate-fade-in">
                    <h2 className="text-3xl font-bold dark:text-white flex items-center gap-2">
                        <span>ðŸ—ºï¸</span> Smart Multi-City Planner
                    </h2>
                    
                    {/* Planning Form */}
                    <div className="bg-white dark:bg-gray-800 rounded-xl p-6 space-y-4">
                        {/* Destinations */}
                        <div>
                            <label className="block text-sm font-medium mb-2 dark:text-white">Destinations (in order)</label>
                            {destinations.map((dest, idx) => (
                                <div key={idx} className="flex gap-2 mb-2">
                                    <span className="flex items-center justify-center w-8 h-10 bg-red-500 text-white rounded-lg font-bold">
                                        {idx + 1}
                                    </span>
                                    <input
                                        type="text"
                                        value={dest}
                                        onChange={(e) => updateDestination(idx, e.target.value)}
                                        placeholder={`Destination ${idx + 1}`}
                                        className="flex-1 px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    />
                                    {destinations.length > 1 && (
                                        <button
                                            onClick={() => removeDestination(idx)}
                                            className="px-3 py-2 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-lg hover:bg-red-200 transition"
                                        >
                                            âŒ
                                        </button>
                                    )}
                                </div>
                            ))}
                            <button
                                onClick={addDestination}
                                className="w-full py-2 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-gray-600 dark:text-gray-400 hover:border-red-500 hover:text-red-500 transition"
                            >
                                + Add Another Destination
                            </button>
                        </div>
                        
                        {/* Duration, Budget, People */}
                        <div className="grid grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-medium mb-2 dark:text-white">Total Duration</label>
                                <input
                                    type="number"
                                    min="1"
                                    value={duration}
                                    onChange={(e) => setDuration(parseInt(e.target.value))}
                                    className="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                />
                                <p className="text-xs text-gray-500 mt-1">days</p>
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-2 dark:text-white">Budget per Person</label>
                                <input
                                    type="text"
                                    value={budget}
                                    onChange={(e) => setBudget(e.target.value)}
                                    placeholder="â‚¹50,000"
                                    className="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-2 dark:text-white">Number of People</label>
                                <input
                                    type="number"
                                    min="1"
                                    value={numberOfPeople}
                                    onChange={(e) => setNumberOfPeople(parseInt(e.target.value))}
                                    className="w-full px-4 py-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                />
                            </div>
                        </div>
                        
                        {/* Interests */}
                        <div>
                            <label className="block text-sm font-medium mb-2 dark:text-white">Interests</label>
                            <div className="flex flex-wrap gap-2">
                                {['heritage', 'nature', 'food', 'adventure', 'wellness', 'culture'].map(interest => (
                                    <button
                                        key={interest}
                                        onClick={() => toggleInterest(interest)}
                                        className={`px-4 py-2 rounded-full capitalize transition ${
                                            interests.includes(interest)
                                                ? 'bg-red-500 text-white'
                                                : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
                                        }`}
                                    >
                                        {interest}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Generate Button */}
                        <button
                            onClick={generateSmartPlan}
                            disabled={loading}
                            className="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg font-semibold text-lg hover:shadow-lg disabled:opacity-50 transition"
                        >
                            {loading ? 'ðŸ¤– Creating Smart Plan...' : 'ðŸš€ Generate Multi-City Plan'}
                        </button>
                    </div>
                    
                    {/* Smart Plan Results */}
                    {smartPlan && (
                        <div className="space-y-6">
                            {/* Route Optimization */}
                            {smartPlan.route && Array.isArray(smartPlan.route) && smartPlan.route.length > 0 && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-2xl font-bold mb-4 dark:text-white">ðŸ—ºï¸ Optimized Route</h3>
                                    <div className="flex items-center gap-4 flex-wrap">
                                        {smartPlan.route.map((city, idx) => (
                                            <React.Fragment key={idx}>
                                                <div className="px-6 py-3 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg font-semibold text-lg">
                                                    {city}
                                                </div>
                                                {idx < smartPlan.route.length - 1 && <span className="text-3xl dark:text-white font-bold">â†’</span>}
                                            </React.Fragment>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Budget Breakdown */}
                            {budgetBreakdown && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-2xl font-bold mb-4 dark:text-white flex items-center gap-2">
                                        ðŸ’° Budget Breakdown
                                        {numberOfPeople > 1 && (
                                            <span className="text-sm font-normal text-gray-600 dark:text-gray-400">
                                                (Split between {numberOfPeople} people)
                                            </span>
                                        )}
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                        {budgetBreakdown.breakdown && Object.entries(budgetBreakdown.breakdown).map(([key, value]) => (
                                            <div key={key} className="p-4 bg-blue-50 dark:bg-gray-700 rounded-lg text-center">
                                                <p className="text-sm text-gray-600 dark:text-gray-400 capitalize">{key}</p>
                                                <p className="text-xl font-bold text-blue-600 dark:text-blue-400">â‚¹{value}</p>
                                            </div>
                                        ))}
                                    </div>
                                    {budgetBreakdown.perPerson && (
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="p-4 bg-green-50 dark:bg-green-900/30 rounded-lg">
                                                <p className="text-sm text-gray-600 dark:text-gray-400">Per Person</p>
                                                <p className="text-2xl font-bold text-green-600 dark:text-green-400">â‚¹{budgetBreakdown.perPerson}</p>
                                            </div>
                                            <div className="p-4 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
                                                <p className="text-sm text-gray-600 dark:text-gray-400">Group Total</p>
                                                <p className="text-2xl font-bold text-purple-600 dark:text-purple-400">â‚¹{budgetBreakdown.total}</p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            
                            {/* Eco Score */}
                            {ecoScore && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-2xl font-bold mb-4 dark:text-white">ðŸŒ¿ Eco-Friendly Travel</h3>
                                    <div className="flex items-center gap-6 mb-4">
                                        <div className="flex-1">
                                            <div className="relative pt-1">
                                                <div className="flex mb-2 items-center justify-between">
                                                    <div>
                                                        <span className="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                                            Eco Score
                                                        </span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                                            {ecoScore.ecoScore || 75}/100
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-200 dark:bg-gray-700">
                                                    <div style={{width: `${ecoScore.ecoScore || 75}%`}} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-green-400 to-emerald-500"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <p className="text-sm dark:text-gray-300">
                                        {String(ecoScore.recommendations || 'Choose trains over flights to reduce carbon footprint by 75%. Consider eco-friendly accommodations.')}
                                    </p>
                                </div>
                            )}
                            
                            {/* Timeline */}
                            {smartPlan.timeline && Array.isArray(smartPlan.timeline) && smartPlan.timeline.length > 0 && (
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6">
                                    <h3 className="text-2xl font-bold mb-4 dark:text-white">ðŸ“… Day-by-Day Plan</h3>
                                    <div className="space-y-3">
                                        {smartPlan.timeline.map((item, idx) => (
                                            <div key={idx} className="p-4 bg-gradient-to-r from-orange-50 to-red-50 dark:from-gray-700 dark:to-gray-600 rounded-lg border-l-4 border-red-500">
                                                <p className="text-sm dark:text-gray-200">{item}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Recommendations */}
                            {smartPlan.recommendations && Array.isArray(smartPlan.recommendations) && smartPlan.recommendations.length > 0 && (
                                <div className="bg-gradient-to-r from-blue-50 to-cyan-50 dark:from-gray-800 dark:to-gray-700 rounded-xl p-6">
                                    <h3 className="text-xl font-bold mb-3 dark:text-white">âœ¨ Smart Recommendations</h3>
                                    <div className="space-y-2">
                                        {smartPlan.recommendations.map((rec, idx) => (
                                            <div key={idx} className="flex items-start gap-2 text-sm dark:text-gray-200">
                                                <span className="text-blue-500">â€¢</span>
                                                <span>{rec}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Tips */}
                            {smartPlan.tips && Array.isArray(smartPlan.tips) && smartPlan.tips.length > 0 && (
                                <div className="bg-yellow-50 dark:bg-gray-700 rounded-xl p-6">
                                    <h3 className="text-xl font-bold mb-3 text-yellow-700 dark:text-yellow-400">ðŸ’¡ Time & Money Saving Tips</h3>
                                    <div className="space-y-2">
                                        {smartPlan.tips.map((tip, idx) => (
                                            <p key={idx} className="text-sm dark:text-gray-200">â€¢ {tip}</p>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    
    <!-- Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-Xs0YAS6qA2YohhIVIwHMSXUrPhaFqnE&libraries=places">
    </script>
    
    <elevenlabs-convai agent-id="agent_1701ke4e7dw0emzv5zkkp37mw000"></elevenlabs-convai><script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript"></script>
</body>
</html>